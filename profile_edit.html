<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <title>ç·¨è¼¯å€‹äººè³‡æ–™ - ç‡Ÿé¤Šè¿½è¹¤ç³»çµ±</title>
    <!-- PWA æ”¯æ´ -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="å¥åº·åŠ©ç†">
    <link rel="apple-touch-icon" href="logo.png">
    <!-- PWA å„ªåŒ–æ¨£å¼ -->
    <link rel="stylesheet" href="/css/pwa.css">
    <!-- PWA å®‰è£æç¤º -->
    <script src="/js/pwa-install.js" defer></script>
    <script src="/js/pwa-utils.js" defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 90px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        /* é ‚éƒ¨å°èˆª */
        .nav-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            margin-bottom: 20px;
        }

        .back-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            color: white;
            text-decoration: none;
            font-weight: 500;
            padding: 10px 20px;
            background: rgba(255,255,255,0.2);
            border-radius: 25px;
            transition: all 0.3s;
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .page-title {
            color: white;
            font-size: 24px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        /* ä¸»è¦å…§å®¹å¡ç‰‡ */
        .main-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
            margin-bottom: 20px;
        }

        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 30px;
        }

        .card-header h2 {
            font-size: 20px;
            margin-bottom: 5px;
        }

        .card-header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .card-body {
            padding: 30px;
        }

        /* è¡¨å–®æ¨£å¼ */
        .form-section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 18px;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            color: #555;
            font-weight: 500;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .required-mark {
            color: #e74c3c;
        }

        .optional-mark {
            color: #999;
            font-size: 12px;
            font-weight: normal;
        }

        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* é¸é …å¡ç‰‡ */
        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
        }

        .option-card {
            padding: 12px 8px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .option-card:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .option-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .option-icon {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .option-label {
            font-size: 12px;
            font-weight: 600;
        }

        /* å¤šé¸é¸é … */
        .multi-options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }

        .multi-option {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .multi-option:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .multi-option.selected {
            border-color: #667eea;
            background: #f0f3ff;
            color: #667eea;
        }

        .multi-option .option-icon {
            font-size: 20px;
        }

        .multi-option .option-label {
            font-size: 11px;
        }

        /* è¨ˆç®—çµæœ */
        .calculated-results {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .calculated-results h4 {
            color: #333;
            margin-bottom: 15px;
        }

        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .result-item {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 10px;
        }

        .result-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .result-value {
            font-size: 20px;
            font-weight: 700;
            color: #667eea;
        }

        /* æŒ‰éˆ• */
        .btn-container {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .btn-save {
            flex: 1;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        .btn-save:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-cancel {
            padding: 15px 30px;
            background: #e0e0e0;
            color: #666;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            text-align: center;
        }

        .btn-cancel:hover {
            background: #d0d0d0;
        }

        /* è¼‰å…¥ä¸­ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e0e0e0;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* æˆåŠŸæç¤º */
        .success-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #27ae60;
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            display: none;
            z-index: 1001;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* åˆ†éš”ç·š */
        .divider {
            border-top: 2px dashed #e0e0e0;
            margin: 30px 0;
        }

        /* éŸ¿æ‡‰å¼ */
        @media (max-width: 768px) {
            .nav-header {
                flex-direction: column;
                gap: 15px;
            }

            .page-title {
                font-size: 20px;
            }

            .card-body {
                padding: 20px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .options-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .btn-container {
                flex-direction: column;
            }
        }

        /* åº•éƒ¨å°èˆªæ¬„ */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 8px 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: #666;
            font-size: 12px;
            padding: 5px 10px;
            border-radius: 10px;
            transition: all 0.3s;
            min-width: 60px;
        }

        .nav-item:hover {
            background: #f0f4ff;
            color: #667eea;
        }

        .nav-item.active {
            color: #667eea;
        }

        .nav-item.active .nav-icon {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .nav-icon {
            font-size: 20px;
            margin-bottom: 3px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            transition: all 0.3s;
        }

        .nav-label {
            font-weight: 500;
        }

        @media (max-width: 480px) {
            .nav-item {
                font-size: 10px;
                padding: 5px 5px;
                min-width: 50px;
            }

            .nav-icon {
                font-size: 18px;
                width: 35px;
                height: 35px;
            }

            .bottom-nav {
                padding: 5px 0;
            }
        }

        /* æ·±è‰²æ¨¡å¼ */
        body.dark-mode {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }

        body.dark-mode .main-card {
            background: #1e1e1e;
        }

        body.dark-mode .card-body {
            background: #1e1e1e;
        }

        body.dark-mode .section-title {
            color: #e0e0e0;
            border-bottom-color: #333;
        }

        body.dark-mode label {
            color: #ccc;
        }

        body.dark-mode input[type="number"],
        body.dark-mode select,
        body.dark-mode textarea {
            background: #2a2a2a;
            border-color: #444;
            color: #e0e0e0;
        }

        body.dark-mode input:focus,
        body.dark-mode select:focus,
        body.dark-mode textarea:focus {
            border-color: #667eea;
        }

        body.dark-mode .option-card {
            background: #2a2a2a;
            border-color: #444;
            color: #e0e0e0;
        }

        body.dark-mode .option-card:hover {
            border-color: #667eea;
            background: #333;
        }

        body.dark-mode .multi-option {
            background: #2a2a2a;
            border-color: #444;
            color: #e0e0e0;
        }

        body.dark-mode .multi-option:hover {
            border-color: #667eea;
            background: #333;
        }

        body.dark-mode .multi-option.selected {
            border-color: #667eea;
            background: #333;
            color: #667eea;
        }

        body.dark-mode .calculated-results {
            background: #2a2a2a;
        }

        body.dark-mode .calculated-results h4 {
            color: #e0e0e0;
        }

        body.dark-mode .result-item {
            background: #333;
        }

        body.dark-mode .result-label {
            color: #aaa;
        }

        body.dark-mode .btn-cancel {
            background: #444;
            color: #e0e0e0;
        }

        body.dark-mode .btn-cancel:hover {
            background: #555;
        }

        body.dark-mode .divider {
            border-top-color: #444;
        }

        body.dark-mode .loading-overlay {
            background: rgba(30, 30, 30, 0.95);
        }

        body.dark-mode .loading-overlay p {
            color: #e0e0e0;
        }

        body.dark-mode .spinner {
            border-color: #444;
            border-top-color: #667eea;
        }

        body.dark-mode .bottom-nav {
            background: #1e1e1e;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
        }

        body.dark-mode .nav-item {
            color: #888;
        }

        body.dark-mode .nav-item:hover,
        body.dark-mode .nav-item.active {
            color: #667eea;
        }
    </style>
</head>
<body>
    <!-- è¼‰å…¥ä¸­ -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <p>è¼‰å…¥ä¸­...</p>
    </div>

    <!-- æˆåŠŸæç¤º -->
    <div class="success-toast" id="successToast">è³‡æ–™å·²å„²å­˜æˆåŠŸï¼</div>

    <div class="container">
        <!-- é ‚éƒ¨å°èˆª -->
        <div class="nav-header">
            <a href="dashboard.html" class="back-btn">
                <span>&larr;</span> è¿”å›é¦–é 
            </a>
            <h2 class="page-title">ç·¨è¼¯å€‹äººè³‡æ–™</h2>
            <div style="width: 120px;"></div>
        </div>

        <form id="profileForm">
            <!-- åŸºæœ¬è³‡æ–™ -->
            <div class="main-card">
                <div class="card-header">
                    <h2>åŸºæœ¬è³‡æ–™</h2>
                    <p>é€™äº›è³‡æ–™ç”¨æ–¼è¨ˆç®—æ‚¨çš„ç‡Ÿé¤Šéœ€æ±‚</p>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label>æ€§åˆ¥ <span class="required-mark">*</span></label>
                        <div class="options-grid">
                            <div class="option-card" data-field="gender" data-value="true" onclick="selectOption('gender', true)">
                                <div class="option-icon">&#x1F468;</div>
                                <div class="option-label">ç”·æ€§</div>
                            </div>
                            <div class="option-card" data-field="gender" data-value="false" onclick="selectOption('gender', false)">
                                <div class="option-icon">&#x1F469;</div>
                                <div class="option-label">å¥³æ€§</div>
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="age">å¹´é½¡ <span class="required-mark">*</span></label>
                            <input type="number" id="age" min="10" max="120" placeholder="ä¾‹å¦‚ï¼š25" oninput="updateCalculations()">
                        </div>
                        <div class="form-group">
                            <label for="height">èº«é«˜ (<span id="heightUnitLabel">cm</span>) <span class="required-mark">*</span></label>
                            <input type="number" id="height" min="100" max="250" step="0.1" placeholder="ä¾‹å¦‚ï¼š170" oninput="updateCalculations()">
                        </div>
                        <div class="form-group">
                            <label for="weight">é«”é‡ (<span id="weightUnitLabel">kg</span>) <span class="required-mark">*</span></label>
                            <input type="number" id="weight" min="20" max="300" step="0.1" placeholder="ä¾‹å¦‚ï¼š65" oninput="updateCalculations()">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>å¥åº·ç›®æ¨™ <span class="required-mark">*</span></label>
                        <div class="options-grid">
                            <div class="option-card" data-field="goal" data-value="0" onclick="selectOption('goal', 0)">
                                <div class="option-icon">&#x2696;</div>
                                <div class="option-label">ç¶­æŒé«”é‡</div>
                            </div>
                            <div class="option-card" data-field="goal" data-value="1" onclick="selectOption('goal', 1)">
                                <div class="option-icon">&#x1F4C9;</div>
                                <div class="option-label">æ¸›é‡</div>
                            </div>
                            <div class="option-card" data-field="goal" data-value="2" onclick="selectOption('goal', 2)">
                                <div class="option-icon">&#x1F4AA;</div>
                                <div class="option-label">å¢è‚Œ</div>
                            </div>
                            <div class="option-card" data-field="goal" data-value="3" onclick="selectOption('goal', 3)">
                                <div class="option-icon">&#x2764;</div>
                                <div class="option-label">æ”¹å–„å¥åº·</div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="activityLevel">æ—¥å¸¸æ´»å‹•é‡ <span class="required-mark">*</span></label>
                        <select id="activityLevel" onchange="updateCalculations()">
                            <option value="sedentary">ä¹…å - å¹¾ä¹ä¸é‹å‹•</option>
                            <option value="lightly_active">è¼•åº¦æ´»å‹• - æ¯é€±é‹å‹•1-2æ¬¡</option>
                            <option value="moderately_active">ä¸­åº¦æ´»å‹• - æ¯é€±é‹å‹•3-5æ¬¡</option>
                            <option value="very_active">é«˜åº¦æ´»å‹• - æ¯é€±é‹å‹•6-7æ¬¡</option>
                            <option value="extra_active">æ¥µé«˜æ´»å‹• - æ¯å¤©é«˜å¼·åº¦é‹å‹•</option>
                        </select>
                    </div>

                    <!-- è¨ˆç®—çµæœ -->
                    <div class="calculated-results" id="calculatedResults" style="display: none;">
                        <h4>ç‡Ÿé¤Šè¨ˆç®—çµæœ</h4>
                        <div class="result-grid">
                            <div class="result-item">
                                <div class="result-label">BMI</div>
                                <div class="result-value" id="bmiResult">-</div>
                            </div>
                            <div class="result-item">
                                <div class="result-label">åŸºç¤ä»£è¬ (BMR)</div>
                                <div class="result-value" id="bmrResult">-</div>
                            </div>
                            <div class="result-item">
                                <div class="result-label">æ¯æ—¥æ¶ˆè€— (TDEE)</div>
                                <div class="result-value" id="tdeeResult">-</div>
                            </div>
                            <div class="result-item">
                                <div class="result-label">å»ºè­°ç†±é‡</div>
                                <div class="result-value" id="caloriesResult">-</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- é‹å‹•ç¿’æ…£ -->
            <div class="main-card">
                <div class="card-header">
                    <h2>é‹å‹•ç¿’æ…£</h2>
                    <p>å¡«å¯«å¾Œå¯ç²å¾—å€‹äººåŒ–é‹å‹•å»ºè­°</p>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label>ç›®å‰é‹å‹•é »ç‡ <span class="optional-mark">(é¸å¡«)</span></label>
                        <div class="options-grid">
                            <div class="option-card" data-field="exerciseFrequency" data-value="0" onclick="selectOption('exerciseFrequency', 0)">
                                <div class="option-icon">&#x1F6CB;</div>
                                <div class="option-label">å¹¾ä¹ä¸é‹å‹•</div>
                            </div>
                            <div class="option-card" data-field="exerciseFrequency" data-value="1" onclick="selectOption('exerciseFrequency', 1)">
                                <div class="option-icon">&#x1F6B6;</div>
                                <div class="option-label">æ¯é€±1-2æ¬¡</div>
                            </div>
                            <div class="option-card" data-field="exerciseFrequency" data-value="2" onclick="selectOption('exerciseFrequency', 2)">
                                <div class="option-icon">&#x1F3C3;</div>
                                <div class="option-label">æ¯é€±3-4æ¬¡</div>
                            </div>
                            <div class="option-card" data-field="exerciseFrequency" data-value="3" onclick="selectOption('exerciseFrequency', 3)">
                                <div class="option-icon">&#x1F3CB;</div>
                                <div class="option-label">æ¯é€±5+æ¬¡</div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>é‹å‹•ç¶“é©— <span class="optional-mark">(é¸å¡«)</span></label>
                        <div class="options-grid">
                            <div class="option-card" data-field="exerciseExperience" data-value="0" onclick="selectOption('exerciseExperience', 0)">
                                <div class="option-icon">&#x1F331;</div>
                                <div class="option-label">æ–°æ‰‹</div>
                            </div>
                            <div class="option-card" data-field="exerciseExperience" data-value="1" onclick="selectOption('exerciseExperience', 1)">
                                <div class="option-icon">&#x1F33F;</div>
                                <div class="option-label">åˆå­¸è€…</div>
                            </div>
                            <div class="option-card" data-field="exerciseExperience" data-value="2" onclick="selectOption('exerciseExperience', 2)">
                                <div class="option-icon">&#x1F333;</div>
                                <div class="option-label">ä¸­ç´šè€…</div>
                            </div>
                            <div class="option-card" data-field="exerciseExperience" data-value="3" onclick="selectOption('exerciseExperience', 3)">
                                <div class="option-icon">&#x1F3C6;</div>
                                <div class="option-label">é€²éšè€…</div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>æ¯æ¬¡å¯é‹å‹•æ™‚é–“ <span class="optional-mark">(é¸å¡«)</span></label>
                        <div class="options-grid">
                            <div class="option-card" data-field="exerciseTimePerSession" data-value="0" onclick="selectOption('exerciseTimePerSession', 0)">
                                <div class="option-icon">&#x23F1;</div>
                                <div class="option-label">15-30åˆ†é˜</div>
                            </div>
                            <div class="option-card" data-field="exerciseTimePerSession" data-value="1" onclick="selectOption('exerciseTimePerSession', 1)">
                                <div class="option-icon">&#x23F0;</div>
                                <div class="option-label">30-60åˆ†é˜</div>
                            </div>
                            <div class="option-card" data-field="exerciseTimePerSession" data-value="2" onclick="selectOption('exerciseTimePerSession', 2)">
                                <div class="option-icon">&#x1F550;</div>
                                <div class="option-label">60-90åˆ†é˜</div>
                            </div>
                            <div class="option-card" data-field="exerciseTimePerSession" data-value="3" onclick="selectOption('exerciseTimePerSession', 3)">
                                <div class="option-icon">&#x1F551;</div>
                                <div class="option-label">90åˆ†é˜+</div>
                            </div>
                        </div>
                    </div>

                    <div class="divider"></div>

                    <div class="form-group">
                        <label>åå¥½é‹å‹•é¡å‹ <span class="optional-mark">(å¯è¤‡é¸)</span></label>
                        <div class="multi-options-grid">
                            <div class="multi-option" data-field="preferredExerciseTypes" data-value="cardio" onclick="toggleMultiOption('preferredExerciseTypes', 'cardio')">
                                <div class="option-icon">&#x1F3C3;</div>
                                <div class="option-label">æœ‰æ°§é‹å‹•</div>
                            </div>
                            <div class="multi-option" data-field="preferredExerciseTypes" data-value="strength" onclick="toggleMultiOption('preferredExerciseTypes', 'strength')">
                                <div class="option-icon">&#x1F3CB;</div>
                                <div class="option-label">é‡é‡è¨“ç·´</div>
                            </div>
                            <div class="multi-option" data-field="preferredExerciseTypes" data-value="hiit" onclick="toggleMultiOption('preferredExerciseTypes', 'hiit')">
                                <div class="option-icon">&#x26A1;</div>
                                <div class="option-label">HIIT</div>
                            </div>
                            <div class="multi-option" data-field="preferredExerciseTypes" data-value="yoga" onclick="toggleMultiOption('preferredExerciseTypes', 'yoga')">
                                <div class="option-icon">&#x1F9D8;</div>
                                <div class="option-label">ç‘œä¼½</div>
                            </div>
                            <div class="multi-option" data-field="preferredExerciseTypes" data-value="swimming" onclick="toggleMultiOption('preferredExerciseTypes', 'swimming')">
                                <div class="option-icon">&#x1F3CA;</div>
                                <div class="option-label">æ¸¸æ³³</div>
                            </div>
                            <div class="multi-option" data-field="preferredExerciseTypes" data-value="cycling" onclick="toggleMultiOption('preferredExerciseTypes', 'cycling')">
                                <div class="option-icon">&#x1F6B4;</div>
                                <div class="option-label">é¨è»Š</div>
                            </div>
                            <div class="multi-option" data-field="preferredExerciseTypes" data-value="ball" onclick="toggleMultiOption('preferredExerciseTypes', 'ball')">
                                <div class="option-icon">&#x26BD;</div>
                                <div class="option-label">çƒé¡</div>
                            </div>
                            <div class="multi-option" data-field="preferredExerciseTypes" data-value="home" onclick="toggleMultiOption('preferredExerciseTypes', 'home')">
                                <div class="option-icon">&#x1F3E0;</div>
                                <div class="option-label">å±…å®¶é‹å‹•</div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>å¯ä½¿ç”¨å™¨æ <span class="optional-mark">(å¯è¤‡é¸)</span></label>
                        <div class="multi-options-grid">
                            <div class="multi-option" data-field="availableEquipment" data-value="none" onclick="toggleMultiOption('availableEquipment', 'none')">
                                <div class="option-icon">&#x1F938;</div>
                                <div class="option-label">ç„¡å™¨æ</div>
                            </div>
                            <div class="multi-option" data-field="availableEquipment" data-value="dumbbell" onclick="toggleMultiOption('availableEquipment', 'dumbbell')">
                                <div class="option-icon">&#x1F3CB;</div>
                                <div class="option-label">å•éˆ´</div>
                            </div>
                            <div class="multi-option" data-field="availableEquipment" data-value="band" onclick="toggleMultiOption('availableEquipment', 'band')">
                                <div class="option-icon">&#x1F397;</div>
                                <div class="option-label">å½ˆåŠ›å¸¶</div>
                            </div>
                            <div class="multi-option" data-field="availableEquipment" data-value="treadmill" onclick="toggleMultiOption('availableEquipment', 'treadmill')">
                                <div class="option-icon">&#x1F3C3;</div>
                                <div class="option-label">è·‘æ­¥æ©Ÿ</div>
                            </div>
                            <div class="multi-option" data-field="availableEquipment" data-value="gym" onclick="toggleMultiOption('availableEquipment', 'gym')">
                                <div class="option-icon">&#x1F3E2;</div>
                                <div class="option-label">å¥èº«æˆ¿</div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>èº«é«”ç‹€æ³é™åˆ¶ <span class="optional-mark">(å¯è¤‡é¸)</span></label>
                        <div class="multi-options-grid">
                            <div class="multi-option" data-field="physicalLimitations" data-value="knee" onclick="toggleMultiOption('physicalLimitations', 'knee')">
                                <div class="option-icon">&#x1F9B5;</div>
                                <div class="option-label">è†è“‹ä¸é©</div>
                            </div>
                            <div class="multi-option" data-field="physicalLimitations" data-value="back" onclick="toggleMultiOption('physicalLimitations', 'back')">
                                <div class="option-icon">&#x1F519;</div>
                                <div class="option-label">è…°èƒŒå•é¡Œ</div>
                            </div>
                            <div class="multi-option" data-field="physicalLimitations" data-value="shoulder" onclick="toggleMultiOption('physicalLimitations', 'shoulder')">
                                <div class="option-icon">&#x1F4AA;</div>
                                <div class="option-label">è‚©é ¸å•é¡Œ</div>
                            </div>
                            <div class="multi-option" data-field="physicalLimitations" data-value="heart" onclick="toggleMultiOption('physicalLimitations', 'heart')">
                                <div class="option-icon">&#x2764;</div>
                                <div class="option-label">å¿ƒè¡€ç®¡ç–¾ç—…</div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="otherNotes">å…¶ä»–å‚™è¨» <span class="optional-mark">(é¸å¡«)</span></label>
                        <textarea id="otherNotes" placeholder="æœ‰èˆŠå‚·ã€ç‰¹æ®Šéœ€æ±‚ã€éæ•ç­‰..."></textarea>
                    </div>
                </div>
            </div>

            <!-- æŒ‰éˆ• -->
            <div class="btn-container">
                <a href="dashboard.html" class="btn-cancel">å–æ¶ˆ</a>
                <button type="submit" class="btn-save" id="btnSave">å„²å­˜è®Šæ›´</button>
            </div>
        </form>
    </div>

    <!-- å…±ç”¨å·¥å…·å‡½æ•¸ -->
    <script src="/js/utils.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script>
        // Firebase é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyCk4GY-VkG4dd_zXP5HZQDlZbjdY0k0img",
            authDomain: "fooddata-92fa8.firebaseapp.com",
            projectId: "fooddata-92fa8",
            storageBucket: "fooddata-92fa8.firebasestorage.app",
            messagingSenderId: "459965557703",
            appId: "1:459965557703:web:6a16b3937935219eb887e2",
            measurementId: "G-R16CYV7QC2"
        };

        // åˆå§‹åŒ– Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // è¡¨å–®è³‡æ–™
        let formData = {
            gender: null,
            goal: null,
            exerciseFrequency: null,
            exerciseExperience: null,
            exerciseTimePerSession: null,
            preferredExerciseTypes: [],
            availableEquipment: [],
            physicalLimitations: []
        };

        // è¼‰å…¥ç”¨æˆ¶è³‡æ–™
        async function loadUserProfile() {
            try {
                const user = auth.currentUser;
                if (!user) return;

                const doc = await db.collection('member').doc(user.uid).get();

                if (doc.exists) {
                    const data = doc.to_dict ? doc.to_dict() : doc.data();

                    // å¡«å…¥è¡¨å–®
                    if (data.age) document.getElementById('age').value = data.age;
                    if (data.height) document.getElementById('height').value = data.height;
                    if (data.weight) document.getElementById('weight').value = data.weight;
                    if (data.activityLevel) document.getElementById('activityLevel').value = data.activityLevel;
                    if (data.otherNotes) document.getElementById('otherNotes').value = data.otherNotes;

                    // å–®é¸æ¬„ä½
                    if (data.gender !== undefined) selectOption('gender', data.gender);
                    if (data.goal !== undefined) selectOption('goal', data.goal);
                    if (data.exerciseFrequency !== undefined) selectOption('exerciseFrequency', data.exerciseFrequency);
                    if (data.exerciseExperience !== undefined) selectOption('exerciseExperience', data.exerciseExperience);
                    if (data.exerciseTimePerSession !== undefined) selectOption('exerciseTimePerSession', data.exerciseTimePerSession);

                    // å¤šé¸æ¬„ä½
                    if (data.preferredExerciseTypes) {
                        formData.preferredExerciseTypes = data.preferredExerciseTypes;
                        data.preferredExerciseTypes.forEach(v => {
                            const el = document.querySelector(`[data-field="preferredExerciseTypes"][data-value="${v}"]`);
                            if (el) el.classList.add('selected');
                        });
                    }
                    if (data.availableEquipment) {
                        formData.availableEquipment = data.availableEquipment;
                        data.availableEquipment.forEach(v => {
                            const el = document.querySelector(`[data-field="availableEquipment"][data-value="${v}"]`);
                            if (el) el.classList.add('selected');
                        });
                    }
                    if (data.physicalLimitations) {
                        formData.physicalLimitations = data.physicalLimitations;
                        data.physicalLimitations.forEach(v => {
                            const el = document.querySelector(`[data-field="physicalLimitations"][data-value="${v}"]`);
                            if (el) el.classList.add('selected');
                        });
                    }

                    updateCalculations();
                }
            } catch (error) {
                console.error('è¼‰å…¥è³‡æ–™å¤±æ•—:', error);
            } finally {
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        }

        // é¸æ“‡å–®é¸é¸é …
        function selectOption(field, value) {
            formData[field] = value;

            // æ›´æ–° UI
            document.querySelectorAll(`[data-field="${field}"]`).forEach(el => {
                const elValue = el.dataset.value;
                // è™•ç†å¸ƒæ—å€¼
                let isMatch = false;
                if (elValue === 'true') isMatch = (value === true);
                else if (elValue === 'false') isMatch = (value === false);
                else isMatch = (parseInt(elValue) === value);

                el.classList.toggle('selected', isMatch);
            });

            updateCalculations();
        }

        // åˆ‡æ›å¤šé¸é¸é …
        function toggleMultiOption(field, value) {
            const index = formData[field].indexOf(value);
            if (index > -1) {
                formData[field].splice(index, 1);
            } else {
                formData[field].push(value);
            }

            // æ›´æ–° UI
            const el = document.querySelector(`[data-field="${field}"][data-value="${value}"]`);
            if (el) {
                el.classList.toggle('selected', formData[field].includes(value));
            }
        }

        // è¨ˆç®— BMR
        function calculateBMR(age, height, weight, isMale) {
            if (isMale) {
                return 88.362 + (13.397 * weight) + (4.799 * height) - (5.677 * age);
            } else {
                return 447.593 + (9.247 * weight) + (3.098 * height) - (4.330 * age);
            }
        }

        // è¨ˆç®— TDEE
        function calculateTDEE(bmr, activityLevel) {
            const multipliers = {
                'sedentary': 1.2,
                'lightly_active': 1.375,
                'moderately_active': 1.55,
                'very_active': 1.725,
                'extra_active': 1.9
            };
            return bmr * (multipliers[activityLevel] || 1.55);
        }

        // æ›´æ–°è¨ˆç®—çµæœ
        function updateCalculations() {
            const age = parseInt(document.getElementById('age').value);
            const height = parseFloat(document.getElementById('height').value);
            const weight = parseFloat(document.getElementById('weight').value);
            const activityLevel = document.getElementById('activityLevel').value;

            if (!age || !height || !weight || formData.gender === null) {
                document.getElementById('calculatedResults').style.display = 'none';
                return;
            }

            const bmi = weight / Math.pow(height / 100, 2);
            const bmr = calculateBMR(age, height, weight, formData.gender);
            const tdee = calculateTDEE(bmr, activityLevel);

            let suggestedCalories = tdee;
            if (formData.goal === 1) suggestedCalories = tdee - 500;
            else if (formData.goal === 2) suggestedCalories = tdee + 300;
            else if (formData.goal === 3) suggestedCalories = tdee - 200;
            suggestedCalories = Math.max(suggestedCalories, 1200);

            document.getElementById('bmiResult').textContent = bmi.toFixed(1);
            document.getElementById('bmrResult').textContent = Math.round(bmr);
            document.getElementById('tdeeResult').textContent = Math.round(tdee);
            document.getElementById('caloriesResult').textContent = Math.round(suggestedCalories);

            document.getElementById('calculatedResults').style.display = 'block';
        }

        // å„²å­˜è³‡æ–™
        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (formData.gender === null) {
                alert('è«‹é¸æ“‡æ€§åˆ¥');
                return;
            }
            if (formData.goal === null) {
                alert('è«‹é¸æ“‡å¥åº·ç›®æ¨™');
                return;
            }

            const age = parseInt(document.getElementById('age').value);
            const height = parseFloat(document.getElementById('height').value);
            const weight = parseFloat(document.getElementById('weight').value);

            if (!age || !height || !weight) {
                alert('è«‹å¡«å¯«å®Œæ•´çš„åŸºæœ¬è³‡æ–™');
                return;
            }

            const btnSave = document.getElementById('btnSave');
            btnSave.disabled = true;
            btnSave.textContent = 'å„²å­˜ä¸­...';

            try {
                const user = auth.currentUser;
                if (!user) throw new Error('è«‹å…ˆç™»å…¥');

                const activityLevel = document.getElementById('activityLevel').value;
                const otherNotes = document.getElementById('otherNotes').value.trim();

                // è¨ˆç®—æ•¸å€¼
                const bmi = weight / Math.pow(height / 100, 2);
                const bmr = calculateBMR(age, height, weight, formData.gender);
                const tdee = calculateTDEE(bmr, activityLevel);

                let suggestedCalories = tdee;
                if (formData.goal === 1) suggestedCalories = tdee - 500;
                else if (formData.goal === 2) suggestedCalories = tdee + 300;
                else if (formData.goal === 3) suggestedCalories = tdee - 200;
                suggestedCalories = Math.max(suggestedCalories, 1200);

                const targetProtein = (suggestedCalories * 0.3) / 4;
                const targetCarbs = (suggestedCalories * 0.45) / 4;
                const targetFat = (suggestedCalories * 0.25) / 9;

                // çµ„åˆè³‡æ–™
                const profileData = {
                    age, height, weight,
                    gender: formData.gender,
                    goal: formData.goal,
                    activityLevel,

                    BMI: parseFloat(bmi.toFixed(1)),
                    BMR: Math.round(bmr),
                    TDEE_level: Math.round(tdee),
                    suggested_calories: Math.round(suggestedCalories),

                    targetCalories: Math.round(suggestedCalories),
                    targetProtein: Math.round(targetProtein),
                    targetCarbs: Math.round(targetCarbs),
                    targetFat: Math.round(targetFat),

                    exerciseFrequency: formData.exerciseFrequency,
                    exerciseExperience: formData.exerciseExperience,
                    exerciseTimePerSession: formData.exerciseTimePerSession,
                    preferredExerciseTypes: formData.preferredExerciseTypes,
                    availableEquipment: formData.availableEquipment,
                    physicalLimitations: formData.physicalLimitations,
                    otherNotes,

                    hasExerciseProfile: formData.exerciseFrequency !== null ||
                                        formData.exerciseExperience !== null ||
                                        formData.exerciseTimePerSession !== null ||
                                        formData.preferredExerciseTypes.length > 0,

                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                await db.collection('member').doc(user.uid).set(profileData, { merge: true });

                // é¡¯ç¤ºæˆåŠŸæç¤º
                const toast = document.getElementById('successToast');
                toast.style.display = 'block';
                setTimeout(() => {
                    toast.style.display = 'none';
                }, 3000);

            } catch (error) {
                console.error('å„²å­˜å¤±æ•—:', error);
                alert('å„²å­˜å¤±æ•—ï¼š' + error.message);
            } finally {
                btnSave.disabled = false;
                btnSave.textContent = 'å„²å­˜è®Šæ›´';
            }
        });

        // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
        auth.onAuthStateChanged((user) => {
            if (user) {
                loadUserProfile();
            } else {
                window.location.href = 'login.html';
            }
        });

        // é é¢è¼‰å…¥æ™‚æ›´æ–°å–®ä½æ¨™ç±¤
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof BentoAIUtils !== 'undefined') {
                const isImperial = BentoAIUtils.isImperialUnit();
                if (isImperial) {
                    document.getElementById('heightUnitLabel').textContent = 'ft\'in"';
                    document.getElementById('weightUnitLabel').textContent = 'lb';
                    document.getElementById('height').placeholder = "ä¾‹å¦‚ï¼š5'10\"";
                    document.getElementById('weight').placeholder = 'ä¾‹å¦‚ï¼š154';
                } else {
                    document.getElementById('heightUnitLabel').textContent = 'cm';
                    document.getElementById('weightUnitLabel').textContent = 'kg';
                    document.getElementById('height').placeholder = 'ä¾‹å¦‚ï¼š170';
                    document.getElementById('weight').placeholder = 'ä¾‹å¦‚ï¼š65';
                }
            }
        });
    </script>

    <!-- åº•éƒ¨å°èˆªæ¬„ -->
    <nav class="bottom-nav">
        <a href="dashboard.html" class="nav-item">
            <div class="nav-icon">ğŸ </div>
            <span class="nav-label">é¦–é </span>
        </a>
        <a href="diet_records.html" class="nav-item">
            <div class="nav-icon">ğŸ½ï¸</div>
            <span class="nav-label">è¨˜éŒ„</span>
        </a>
        <a href="food-detect.html" class="nav-item">
            <div class="nav-icon">ğŸ“·</div>
            <span class="nav-label">è¾¨è­˜</span>
        </a>
        <a href="statistics.html" class="nav-item">
            <div class="nav-icon">ğŸ“Š</div>
            <span class="nav-label">çµ±è¨ˆ</span>
        </a>
        <a href="chat.html" class="nav-item">
            <div class="nav-icon">ğŸ’¬</div>
            <span class="nav-label">è«®è©¢</span>
        </a>
        <a href="exercise.html" class="nav-item">
            <div class="nav-icon">ğŸƒ</div>
            <span class="nav-label">é‹å‹•</span>
        </a>
        <a href="settings.html" class="nav-item active">
            <div class="nav-icon">âš™ï¸</div>
            <span class="nav-label">è¨­å®š</span>
        </a>
    </nav>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <!-- æ·±è‰²æ¨¡å¼ï¼ˆå…§è¯è…³æœ¬+æ¨£å¼ï¼Œé¿å…é–ƒçˆï¼‰ -->
    <script>try{var s=JSON.parse(localStorage.getItem('bentoai_settings')||'{}');if(s.darkMode){document.documentElement.classList.add('dark-mode')}else{document.documentElement.classList.remove('dark-mode')}}catch(e){document.documentElement.classList.remove('dark-mode')}</script>
    <style>html.dark-mode,html.dark-mode body{background:linear-gradient(135deg,#1a1a2e 0%,#16213e 100%)!important}html.dark-mode .bottom-nav{background:#1a1a2e!important;border-top:1px solid #2a2a3e}html.dark-mode .nav-item{color:#888!important}html.dark-mode .container,html.dark-mode .header,html.dark-mode .section,html.dark-mode .form-section,html.dark-mode .form-group,html.dark-mode .settings-section,html.dark-mode .settings-item,html.dark-mode .user-card,html.dark-mode .user-header,html.dark-mode .user-info,html.dark-mode .profile-item,html.dark-mode .profile-grid,html.dark-mode .profile-panel,html.dark-mode .option-card,html.dark-mode .feature-card,html.dark-mode .stat-card,html.dark-mode .summary-item,html.dark-mode .nutrition-item,html.dark-mode .nutrition-card,html.dark-mode .chart-container,html.dark-mode .chart-section,html.dark-mode .insight-card,html.dark-mode .tips-card,html.dark-mode .recent-card,html.dark-mode .card,html.dark-mode .chat-container,html.dark-mode .chat-header,html.dark-mode .chat-messages,html.dark-mode .chat-input-area,html.dark-mode .quick-questions,html.dark-mode .welcome-message,html.dark-mode .edit-form,html.dark-mode .stats-grid,html.dark-mode .loading,html.dark-mode .step,html.dark-mode .total-item,html.dark-mode .input-wrapper,html.dark-mode .options-grid,html.dark-mode .multi-option,html.dark-mode .tech-item,html.dark-mode .empty-state,html.dark-mode .filter-btn,html.dark-mode .time-selector,html.dark-mode .controls,html.dark-mode .record-card,html.dark-mode .meal-section,html.dark-mode .food-item,html.dark-mode .modal-content,html.dark-mode .upload-area,html.dark-mode .result-card,html.dark-mode .analysis-card{background:#1e1e2e!important;color:#e0e0e0!important}html.dark-mode input,html.dark-mode select,html.dark-mode textarea{background:#2a2a3e!important;color:#e0e0e0!important;border-color:#3a3a4e!important}html.dark-mode .btn-secondary{background:#3a3a4e!important;color:#e0e0e0!important}</style>
    <meta charset="UTF-8">
    <script src="/js/dark-mode.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <title>AI ç‡Ÿé¤Šå¸«èŠå¤©å®¤</title>
    <!-- PWA æ”¯æ´ -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="å¥åº·åŠ©ç†">
    <link rel="apple-touch-icon" href="logo.png">
    <link rel="icon" href="logo.png" type="image/png">
    <!-- PWA å„ªåŒ–æ¨£å¼ -->
    <link rel="stylesheet" href="/css/pwa.css">

    <!-- å…±ç”¨å·¥å…·å‡½æ•¸ -->
    <script src="/js/utils.js"></script>
    <script src="/js/security.js"></script>
    <!-- PWA å®‰è£æç¤º -->
    <script src="/js/pwa-install.js" defer></script>
    <script src="/js/pwa-utils.js" defer></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- Markdown è§£æå™¨ (marked.js) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            overflow: hidden;
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 0 40px rgba(0,0,0,0.3);
        }

        /* é ‚éƒ¨æ¨™é¡Œæ¬„ */
        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .chat-header h1 {
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-logo {
            width: 35px;
            height: 35px;
            object-fit: contain;
            filter: brightness(0) invert(1);
        }

        .chat-header .back-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .chat-header .back-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        /* å€‹äººè³‡æ–™é¢æ¿ - æ‰‹æ©Ÿç‰ˆé è¨­éš±è— */
        .profile-panel {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 2px solid #e9ecef;
            display: none; /* é è¨­éš±è— */
            gap: 15px;
            align-items: center;
        }

        .profile-panel.expanded {
            display: flex; /* å±•é–‹æ™‚é¡¯ç¤º */
        }

        .profile-panel.collapsed {
            display: none;
        }

        /* æ‰‹æ©Ÿç‰ˆéš±è— metrics-panel */
        @media (max-width: 768px) {
            .profile-panel, .metrics-panel {
                display: none !important;
            }
        }

        .profile-item {
            flex: 1;
            background: white;
            padding: 10px 15px;
            border-radius: 10px;
            border: 2px solid #dee2e6;
            cursor: pointer;
            transition: all 0.3s;
        }

        .profile-item:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .profile-item.active {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .profile-item label {
            display: block;
            font-size: 0.85em;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .profile-item select,
        .profile-item input {
            width: 100%;
            border: none;
            background: transparent;
            font-size: 1em;
            color: #333;
            cursor: pointer;
            outline: none;
        }

        /* BMI èˆ‡ TDEE é¢æ¿ - ç²¾ç°¡ç‰ˆ */
        .metrics-panel {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 10px 15px;
            display: flex;
            gap: 10px;
            justify-content: center;
            border-bottom: 2px solid #e9ecef;
        }

        .metric-card {
            background: white;
            border-radius: 10px;
            padding: 8px 15px;
            text-align: center;
            min-width: 100px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .metric-label {
            font-size: 0.7em;
            color: #6c757d;
            margin-bottom: 3px;
            font-weight: 600;
        }

        .metric-value {
            font-size: 1.3em;
            font-weight: bold;
            color: #667eea;
            margin: 2px 0;
        }

        .metric-status {
            font-size: 0.65em;
            padding: 2px 6px;
            border-radius: 10px;
            display: inline-block;
            margin-top: 2px;
        }

        .metric-status.normal {
            background: #d4edda;
            color: #155724;
        }

        .metric-status.warning {
            background: #fff3cd;
            color: #856404;
        }

        .metric-status.danger {
            background: #f8d7da;
            color: #721c24;
        }

        /* èŠå¤©è¨Šæ¯å€åŸŸ */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }

        .message {
            display: flex;
            margin-bottom: 20px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            justify-content: flex-end;
        }

        .message-content {
            max-width: 70%;
            padding: 15px 20px;
            border-radius: 20px;
            position: relative;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 5px;
        }

        .message.ai .message-content {
            background: white;
            color: #333;
            border-bottom-left-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 85%;
        }

        /* å¯æ”¶åˆçš„é•·è¨Šæ¯ */
        .message.ai .message-content.collapsible {
            max-height: 300px;
            overflow: hidden;
            position: relative;
        }

        .message.ai .message-content.collapsible::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(transparent, white);
            pointer-events: none;
        }

        .message.ai .message-content.expanded {
            max-height: none;
        }

        .message.ai .message-content.expanded::after {
            display: none;
        }

        .expand-btn {
            display: block;
            width: 100%;
            padding: 8px;
            margin-top: 10px;
            background: #f0f4ff;
            border: 1px solid #667eea;
            border-radius: 8px;
            color: #667eea;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .expand-btn:hover {
            background: #667eea;
            color: white;
        }

        /* Markdown æ¸²æŸ“æ¨£å¼ */
        .message.ai .message-content h1,
        .message.ai .message-content h2,
        .message.ai .message-content h3 {
            color: #667eea;
            margin-top: 15px;
            margin-bottom: 10px;
        }

        .message.ai .message-content h1 { font-size: 1.4em; }
        .message.ai .message-content h2 { font-size: 1.2em; }
        .message.ai .message-content h3 { font-size: 1.1em; }

        .message.ai .message-content p {
            margin-bottom: 10px;
            line-height: 1.6;
        }

        .message.ai .message-content ul,
        .message.ai .message-content ol {
            margin: 10px 0;
            padding-left: 25px;
        }

        .message.ai .message-content li {
            margin: 5px 0;
            line-height: 1.5;
        }

        .message.ai .message-content strong {
            color: #333;
            font-weight: 600;
        }

        .message.ai .message-content em {
            color: #666;
        }

        .message.ai .message-content hr {
            border: none;
            border-top: 1px solid #e0e0e0;
            margin: 15px 0;
        }

        .message.ai .message-content blockquote {
            border-left: 4px solid #667eea;
            padding-left: 15px;
            margin: 10px 0;
            color: #666;
            background: #f8f9fa;
            padding: 10px 15px;
            border-radius: 5px;
        }

        .message.ai .message-content code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9em;
        }

        .message.ai .message-content pre {
            background: #f4f4f4;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 10px 0;
        }

        /* å…è²¬è²æ˜æ¨£å¼ */
        .message.ai .message-content p:last-of-type {
            color: #888;
            font-size: 0.9em;
            border-top: 1px solid #e0e0e0;
            padding-top: 10px;
            margin-top: 15px;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin: 0 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .message.ai .message-avatar {
            background: #28a745;
            color: white;
        }

        .message-time {
            font-size: 0.75em;
            opacity: 0.7;
            margin-top: 5px;
        }

        /* è¼¸å…¥å€åŸŸ */
        .chat-input-area {
            padding: 20px;
            padding-bottom: 90px; /* ç‚ºåº•éƒ¨å°èˆªé ç•™ç©ºé–“ */
            background: white;
            border-top: 2px solid #e9ecef;
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .chat-input {
            flex: 1;
            border: 2px solid #dee2e6;
            border-radius: 25px;
            padding: 12px 20px;
            font-size: 1em;
            outline: none;
            transition: border-color 0.3s, box-shadow 0.3s, height 0.15s ease;
            resize: none;
            min-height: 46px;
            max-height: 150px;
            font-family: inherit;
            line-height: 1.4;
            overflow-y: auto;
        }

        .chat-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .send-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .send-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .send-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: scale(1);
        }

        /* è¼‰å…¥å‹•ç•« */
        .typing-indicator {
            display: flex;
            gap: 5px;
            padding: 15px 20px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: #6c757d;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }

        /* å€‹äººè³‡æ–™æ›´æ–°ç¢ºèªå¡ç‰‡ */
        .profile-update-confirm {
            margin: 15px 20px;
        }

        .update-card {
            background: linear-gradient(135deg, #f8f9ff 0%, #e8f4fd 100%);
            border: 2px solid #667eea;
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.15);
        }

        .update-card.success {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-color: #4caf50;
        }

        .update-card.error {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
            border-color: #f44336;
        }

        .update-card.dismissed {
            background: #f5f5f5;
            border-color: #bdbdbd;
        }

        .update-header {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
        }

        .update-icon {
            font-size: 1.3em;
        }

        .update-fields {
            background: white;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 12px;
        }

        .update-field {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dashed #e0e0e0;
        }

        .update-field:last-child {
            border-bottom: none;
        }

        .field-label {
            color: #666;
            font-size: 0.9em;
        }

        .field-value {
            font-weight: 600;
            color: #667eea;
        }

        .update-actions {
            display: flex;
            gap: 10px;
        }

        .update-actions .btn-confirm {
            flex: 1;
            padding: 10px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .update-actions .btn-confirm:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .update-actions .btn-cancel {
            padding: 10px 16px;
            background: #e0e0e0;
            color: #666;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .update-actions .btn-cancel:hover {
            background: #d0d0d0;
        }

        .update-loading {
            text-align: center;
            color: #667eea;
            padding: 10px;
        }

        .update-result {
            text-align: center;
            font-weight: 500;
            padding: 5px;
        }

        /* æ·±è‰²æ¨¡å¼ - æ›´æ–°ç¢ºèªå¡ç‰‡ */
        html.dark-mode .update-card {
            background: linear-gradient(135deg, #2a2a3e 0%, #1e1e2e 100%);
            border-color: #667eea;
        }

        html.dark-mode .update-card.success {
            background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%);
            border-color: #4caf50;
        }

        html.dark-mode .update-card.error {
            background: linear-gradient(135deg, #b71c1c 0%, #c62828 100%);
            border-color: #f44336;
        }

        html.dark-mode .update-card.dismissed {
            background: #2a2a2a;
            border-color: #555;
        }

        html.dark-mode .update-header {
            color: #e0e0e0;
        }

        html.dark-mode .update-fields {
            background: #1e1e2e;
        }

        html.dark-mode .update-field {
            border-bottom-color: #3a3a4e;
        }

        html.dark-mode .field-label {
            color: #aaa;
        }

        html.dark-mode .update-actions .btn-cancel {
            background: #3a3a4e;
            color: #e0e0e0;
        }

        html.dark-mode .update-result {
            color: #e0e0e0;
        }

        /* æ­¡è¿è¨Šæ¯ */
        .welcome-message {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }

        .welcome-message h2 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .welcome-message p {
            margin: 5px 0;
        }

        /* å¿«é€Ÿå•é¡Œå»ºè­°å€åŸŸ */
        .quick-questions-wrapper {
            border-top: 1px solid #eee;
            background: linear-gradient(to bottom, transparent, rgba(255,255,255,0.95));
        }

        .quick-questions-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 8px;
            cursor: pointer;
            color: #667eea;
            font-size: 0.85em;
            user-select: none;
        }

        .quick-questions-toggle:hover {
            background: rgba(102, 126, 234, 0.05);
        }

        .toggle-icon {
            transition: transform 0.3s;
        }

        .quick-questions-wrapper.collapsed .toggle-icon {
            transform: rotate(180deg);
        }

        .quick-questions-wrapper.collapsed .quick-questions {
            display: none;
        }

        .quick-questions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 8px 15px 12px;
            justify-content: center;
        }

        .quick-question-btn {
            background: white;
            border: 1.5px solid #dee2e6;
            padding: 8px 14px;
            border-radius: 18px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85em;
        }

        .quick-question-btn:hover {
            border-color: #667eea;
            background: #f0f4ff;
            transform: translateY(-2px);
        }

        /* æ‰‹æ©Ÿç‰ˆæç¤ºè©æ›´å° */
        @media (max-width: 480px) {
            .quick-question-btn {
                padding: 6px 10px;
                font-size: 0.75em;
                border-radius: 15px;
            }

            .quick-questions {
                gap: 6px;
                padding: 6px 10px 10px;
            }

            .quick-questions-toggle {
                padding: 6px;
                font-size: 0.8em;
            }
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .chat-container {
                border-radius: 0;
            }

            .profile-panel {
                flex-direction: column;
            }

            .metrics-panel {
                flex-direction: column;
                padding: 15px;
                gap: 10px;
            }

            .metric-card {
                min-width: auto;
                width: 100%;
            }

            .message-content {
                max-width: 85%;
            }
        }

        /* æ»¾å‹•æ¢æ¨£å¼ */
        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* ===== åº•éƒ¨å°èˆªæ¬„ ===== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 8px 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: #666;
            font-size: 12px;
            padding: 5px 10px;
            border-radius: 10px;
            transition: all 0.3s;
            min-width: 60px;
        }

        .nav-item:hover {
            background: #f0f4ff;
            color: #667eea;
        }

        .nav-item.active {
            color: #667eea;
        }

        .nav-item.active .nav-icon {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .nav-icon {
            font-size: 20px;
            margin-bottom: 3px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            transition: all 0.3s;
        }

        .nav-label {
            font-weight: 500;
        }

        /* chat é é¢ç‰¹æ®Šè™•ç†ï¼šç‚ºåº•éƒ¨å°èˆªç•™å‡ºç©ºé–“ */
        .chat-container {
            height: calc(100vh - 70px);
        }

        /* æ‰‹æ©Ÿç‰ˆåº•éƒ¨å°èˆªå„ªåŒ– */
        @media (max-width: 480px) {
            .nav-item {
                font-size: 10px;
                padding: 5px 5px;
                min-width: 50px;
            }

            .nav-icon {
                font-size: 18px;
                width: 35px;
                height: 35px;
            }

            .bottom-nav {
                padding: 5px 0;
            }

            .chat-container {
                height: calc(100vh - 60px);
            }
        }

        /* æ·±è‰²æ¨¡å¼ */
        html.dark-mode {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }

        html.dark-mode .chat-container {
            background: #1e1e1e;
        }

        html.dark-mode .chat-header {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }

        html.dark-mode .profile-panel {
            background: #2a2a2a;
            border-bottom-color: #444;
        }

        html.dark-mode .profile-item {
            background: #333;
            border-color: #444;
            color: #e0e0e0;
        }

        html.dark-mode .profile-item:hover {
            border-color: #667eea;
        }

        html.dark-mode .profile-item label {
            color: #aaa;
        }

        html.dark-mode .profile-item select,
        html.dark-mode .profile-item input {
            color: #e0e0e0;
            background: transparent;
        }

        html.dark-mode .metrics-panel {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }

        html.dark-mode .chat-messages {
            background: #2a2a2a;
        }

        html.dark-mode .message.ai .message-content {
            background: #333;
            color: #e0e0e0;
        }

        html.dark-mode .message.ai .message-content h1,
        html.dark-mode .message.ai .message-content h2,
        html.dark-mode .message.ai .message-content h3 {
            color: #667eea;
        }

        html.dark-mode .message.ai .message-content blockquote {
            background: #444;
            color: #ccc;
        }

        html.dark-mode .expand-btn {
            background: #444;
            border-color: #667eea;
            color: #667eea;
        }

        html.dark-mode .expand-btn:hover {
            background: #667eea;
            color: white;
        }

        html.dark-mode .quick-questions {
            background: linear-gradient(to bottom, transparent, rgba(30,30,30,0.95));
            border-top-color: #444;
        }

        html.dark-mode .quick-question-btn {
            background: #333;
            border-color: #444;
            color: #e0e0e0;
        }

        html.dark-mode .quick-question-btn:hover {
            border-color: #667eea;
            background: #444;
        }

        html.dark-mode .chat-input-area {
            background: #1e1e1e;
            border-top-color: #444;
        }

        html.dark-mode .chat-input {
            background: #333;
            border-color: #444;
            color: #e0e0e0;
        }

        html.dark-mode .chat-input:focus {
            border-color: #667eea;
        }

        html.dark-mode .welcome-message {
            color: #888;
        }

        html.dark-mode .welcome-message h2 {
            color: #667eea;
        }

        html.dark-mode .bottom-nav {
            background: #1e1e1e;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
        }

        html.dark-mode .nav-item {
            color: #888;
        }

        html.dark-mode .nav-item:hover,
        html.dark-mode .nav-item.active {
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <!-- é ‚éƒ¨æ¨™é¡Œæ¬„ -->
        <div class="chat-header">
            <h1>
                <img src="logo.png" alt="Logo" class="header-logo">
                AI ç‡Ÿé¤Šå¸«
            </h1>
            <button class="back-btn" onclick="window.location.href='dashboard.html'">â† è¿”å›ä¸»é </button>
        </div>

        <!-- å€‹äººè³‡æ–™é¢æ¿ -->
        <div class="profile-panel" id="profilePanel">
            <div class="profile-item">
                <label>å¹´é½¡</label>
                <input type="number" id="userAge" placeholder="è«‹è¼¸å…¥" min="1" max="120" onchange="updateProfile()">
            </div>
            <div class="profile-item">
                <label>æ€§åˆ¥</label>
                <select id="userGender" onchange="updateProfile()">
                    <option value="">è«‹é¸æ“‡</option>
                    <option value="male">ç”·æ€§</option>
                    <option value="female">å¥³æ€§</option>
                </select>
            </div>
            <div class="profile-item">
                <label>èº«é«˜ (å…¬åˆ†)</label>
                <input type="number" id="userHeight" placeholder="è«‹è¼¸å…¥" min="100" max="250" onchange="updateProfile()">
            </div>
            <div class="profile-item">
                <label>é«”é‡ (å…¬æ–¤)</label>
                <input type="number" id="userWeight" placeholder="è«‹è¼¸å…¥" min="20" max="300" onchange="updateProfile()">
            </div>
            <div class="profile-item">
                <label>æ´»å‹•é‡</label>
                <select id="userActivity" onchange="updateProfile()">
                    <option value="">è«‹é¸æ“‡</option>
                    <option value="1.2">ä¹…å (å¾ˆå°‘é‹å‹•)</option>
                    <option value="1.375">è¼•åº¦æ´»å‹• (æ¯é€±1-3å¤©)</option>
                    <option value="1.55">ä¸­åº¦æ´»å‹• (æ¯é€±3-5å¤©)</option>
                    <option value="1.725">é«˜åº¦æ´»å‹• (æ¯é€±6-7å¤©)</option>
                    <option value="1.9">éå¸¸é«˜åº¦æ´»å‹• (é«”åŠ›å‹å‹•)</option>
                </select>
            </div>
            <div class="profile-item">
                <label>å¥åº·ç›®æ¨™</label>
                <select id="userGoal" onchange="updateProfile()">
                    <option value="">è«‹é¸æ“‡</option>
                    <option value="lose_weight">æ¸›é‡</option>
                    <option value="gain_muscle">å¢è‚Œ</option>
                    <option value="maintain">ç¶­æŒå¥åº·</option>
                    <option value="diabetes">ç³–å°¿ç—…ç®¡ç†</option>
                    <option value="heart_health">å¿ƒè¡€ç®¡å¥åº·</option>
                </select>
            </div>
        </div>

        <!-- èŠå¤©è¨Šæ¯å€åŸŸ -->
        <div class="chat-messages" id="chatMessages">
            <div class="welcome-message">
                <h2>ğŸ‘‹ æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„ AI ç‡Ÿé¤Šå¸«</h2>
                <p>ç™»å…¥å¾Œæˆ‘æœƒè¼‰å…¥æ‚¨çš„å€‹äººè³‡æ–™ï¼Œæä¾›æ›´ç²¾æº–çš„ç‡Ÿé¤Šå»ºè­°ã€‚<br>æ‚¨ä¹Ÿå¯ä»¥åˆ°<a href="profile_edit.html" style="color: #667eea;">å€‹äººè³‡æ–™</a>é é¢æ›´æ–°è³‡è¨Šã€‚</p>
            </div>

        </div>

        <!-- å¿«é€Ÿå•é¡Œå»ºè­° - å›ºå®šåœ¨è¼¸å…¥å€ä¸Šæ–¹ -->
        <div class="quick-questions-wrapper" id="quickQuestionsWrapper">
            <div class="quick-questions-toggle" onclick="toggleQuickQuestions()">
                <span class="toggle-icon">â–²</span>
                <span id="toggleText">å¿«é€Ÿæå•</span>
            </div>
            <div class="quick-questions" id="quickQuestions">
                <button class="quick-question-btn" onclick="sendQuickQuestion('æˆ‘ä¸€å¤©è¦åƒå¤šå°‘è›‹ç™½è³ªï¼Ÿ')">
                    è›‹ç™½è³ªæ”å–ï¼Ÿ
                </button>
                <button class="quick-question-btn" onclick="sendQuickQuestion('æƒ³æ¸›è‚¥è©²æ€éº¼åƒï¼Ÿ')">
                    æ¸›è‚¥é£²é£Ÿ
                </button>
                <button class="quick-question-btn" onclick="sendQuickQuestion('ç³–å°¿ç—…é£²é£Ÿå»ºè­°')">
                    ç³–å°¿ç—…é£²é£Ÿ
                </button>
                <button class="quick-question-btn" onclick="sendQuickQuestion('é«˜è¡€å£“è¦æ³¨æ„ä»€éº¼ï¼Ÿ')">
                    é«˜è¡€å£“æ³¨æ„
                </button>
                <button class="quick-question-btn" onclick="sendQuickQuestion('å¢è‚Œè©²æ€éº¼åƒï¼Ÿ')">
                    å¢è‚Œé£²é£Ÿ
                </button>
            </div>
        </div>

        <!-- è¼¸å…¥å€åŸŸ -->
        <div class="chat-input-area">
            <div class="chat-input-container">
                <textarea
                    class="chat-input"
                    id="messageInput"
                    placeholder="è¼¸å…¥æ‚¨çš„å•é¡Œ..."
                    rows="1"
                    onkeydown="handleKeyDown(event)"
                ></textarea>
                <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                    â¤
                </button>
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨å°èˆªæ¬„ -->
    <nav class="bottom-nav">
        <a href="dashboard.html" class="nav-item">
            <div class="nav-icon">ğŸ </div>
            <span class="nav-label">é¦–é </span>
        </a>
        <a href="diet_records.html" class="nav-item">
            <div class="nav-icon">ğŸ½ï¸</div>
            <span class="nav-label">è¨˜éŒ„</span>
        </a>
        <a href="food-detect.html" class="nav-item">
            <div class="nav-icon">ğŸ“·</div>
            <span class="nav-label">è¾¨è­˜</span>
        </a>
        <a href="statistics.html" class="nav-item">
            <div class="nav-icon">ğŸ“Š</div>
            <span class="nav-label">çµ±è¨ˆ</span>
        </a>
        <a href="chat.html" class="nav-item active">
            <div class="nav-icon">ğŸ’¬</div>
            <span class="nav-label">è«®è©¢</span>
        </a>
        <a href="exercise.html" class="nav-item">
            <div class="nav-icon">ğŸƒ</div>
            <span class="nav-label">é‹å‹•</span>
        </a>
        <a href="settings.html" class="nav-item">
            <div class="nav-icon">âš™ï¸</div>
            <span class="nav-label">è¨­å®š</span>
        </a>
    </nav>

    <script>
        // Firebase é…ç½®ï¼ˆWeb ç‰ˆï¼‰
        const firebaseConfig = {
            apiKey: "AIzaSyCk4GY-VkG4dd_zXP5HZQDlZbjdY0k0img",
            authDomain: "fooddata-92fa8.firebaseapp.com",
            projectId: "fooddata-92fa8",
            storageBucket: "fooddata-92fa8.firebasestorage.app",
            messagingSenderId: "459965557703",
            appId: "1:459965557703:web:6a16b3937935219eb887e2",
            measurementId: "G-R16CYV7QC2"
        };

        // åˆå§‹åŒ– Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        // å…¨å±€è®Šæ•¸
        let conversationHistory = [];
        let userProfile = {
            age: '',
            gender: '',
            height: '',
            weight: '',
            activity: '',
            goal: ''
        };
        let currentUser = null;
        let userIdToken = null;

        // ç›£è½ç™»å…¥ç‹€æ…‹
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                // å–å¾— ID Token
                userIdToken = await user.getIdToken();
                console.log('ç”¨æˆ¶å·²ç™»å…¥:', user.email);

                // âœ… ç”¨æˆ¶ç™»å…¥æ™‚ï¼Œæ¸…ç©ºèˆŠè³‡æ–™ä¸¦è¼‰å…¥è©²ç”¨æˆ¶å°ˆå±¬è³‡æ–™
                await loadUserProfileFromFirestore(user.uid);
            } else {
                currentUser = null;
                userIdToken = null;
                console.log('ç”¨æˆ¶æœªç™»å…¥');

                // âœ… ç”¨æˆ¶ç™»å‡ºæ™‚ï¼Œæ¸…é™¤æ‰€æœ‰å€‹äººè³‡æ–™ï¼ˆé˜²æ­¢è³‡æ–™æ´©æ¼ï¼‰
                clearAllProfileData();
            }
        });

        // è‡ªå‹•èª¿æ•´è¼¸å…¥æ¡†é«˜åº¦
        const messageInput = document.getElementById('messageInput');

        function autoResizeInput() {
            messageInput.style.height = 'auto';
            const newHeight = Math.min(messageInput.scrollHeight, 150);
            messageInput.style.height = newHeight + 'px';
        }

        function resetInputHeight() {
            messageInput.style.height = '46px';  // é‡ç½®åˆ°æœ€å°é«˜åº¦
        }

        messageInput.addEventListener('input', autoResizeInput);

        // è™•ç† Enter éµ
        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // è¨ˆç®— BMI
        function calculateBMI(weight, height) {
            // BMI = é«”é‡(kg) / èº«é«˜(m)Â²
            const heightInMeters = height / 100;
            return weight / (heightInMeters * heightInMeters);
        }

        // è¨ˆç®— BMR (åŸºç¤ä»£è¬ç‡) - Mifflin-St Jeor Equation
        function calculateBMR(weight, height, age, gender) {
            // ç”·æ€§: BMR = 10 Ã— é«”é‡(kg) + 6.25 Ã— èº«é«˜(cm) - 5 Ã— å¹´é½¡ + 5
            // å¥³æ€§: BMR = 10 Ã— é«”é‡(kg) + 6.25 Ã— èº«é«˜(cm) - 5 Ã— å¹´é½¡ - 161
            let bmr = 10 * weight + 6.25 * height - 5 * age;

            if (gender === 'male') {
                bmr += 5;
            } else if (gender === 'female') {
                bmr -= 161;
            }

            return bmr;
        }

        // è¨ˆç®— TDEE (æ¯æ—¥ç¸½æ¶ˆè€—)
        function calculateTDEE(bmr, activityLevel) {
            return bmr * parseFloat(activityLevel);
        }

        // å–å¾— BMI ç‹€æ…‹
        function getBMIStatus(bmi) {
            if (bmi < 18.5) {
                return { text: 'éè¼•', class: 'warning' };
            } else if (bmi < 24) {
                return { text: 'æ­£å¸¸', class: 'normal' };
            } else if (bmi < 27) {
                return { text: 'éé‡', class: 'warning' };
            } else {
                return { text: 'è‚¥èƒ–', class: 'danger' };
            }
        }

        // æ›´æ–°å€‹äººè³‡æ–™
        function updateProfile() {
            userProfile.age = document.getElementById('userAge').value;
            userProfile.gender = document.getElementById('userGender').value;
            userProfile.height = document.getElementById('userHeight').value;
            userProfile.weight = document.getElementById('userWeight').value;
            userProfile.activity = document.getElementById('userActivity').value;
            userProfile.goal = document.getElementById('userGoal').value;

            // âŒ ä¸å†å„²å­˜åˆ° localStorageï¼ˆå·²ç§»é™¤ï¼Œé˜²æ­¢è·¨ç”¨æˆ¶è³‡æ–™æ´©æ¼ï¼‰
            // localStorage.setItem('userProfile', JSON.stringify(userProfile));

            // BMI/TDEE é¢æ¿å·²ç§»é™¤ï¼Œåªåšè¨ˆç®—ä¸é¡¯ç¤º

            // å¦‚æœå¡«å¯«å®Œæ•´ï¼Œé¡¯ç¤ºæç¤ºï¼ˆç”± loadUserProfileFromFirestore è™•ç†æ­¡è¿è¨Šæ¯ï¼‰
        }

        // âœ… å¾ Firestore è¼‰å…¥ç”¨æˆ¶å°ˆå±¬è³‡æ–™
        async function loadUserProfileFromFirestore(userId) {
            try {
                console.log('ğŸ”„ é–‹å§‹è¼‰å…¥ Firestore è³‡æ–™ï¼ŒuserId:', userId);

                // åˆå§‹åŒ– Firestoreï¼ˆéœ€è¦é¡å¤–å¼•å…¥ï¼‰
                if (!firebase.firestore) {
                    console.warn('âš ï¸ Firestore æœªè¼‰å…¥ï¼Œä½¿ç”¨ç©ºç™½è³‡æ–™');
                    clearAllProfileData();
                    return;
                }

                const db = firebase.firestore();
                console.log('ğŸ“¦ Firestore å·²åˆå§‹åŒ–');

                const memberDoc = await db.collection('member').doc(userId).get();
                console.log('ğŸ“„ æ–‡æª”æŸ¥è©¢å®Œæˆï¼Œexists:', memberDoc.exists);

                if (memberDoc.exists) {
                    const data = memberDoc.data();
                    console.log('âœ… å¾ Firestore è¼‰å…¥ç”¨æˆ¶è³‡æ–™:', JSON.stringify(data, null, 2));

                    // å°‡ Firestore è³‡æ–™æ˜ å°„åˆ°è¡¨å–®
                    userProfile.age = data.age || '';

                    // æ€§åˆ¥è½‰æ›ï¼ˆæ”¯æ´å¤šç¨®æ ¼å¼ï¼‰
                    if (data.gender === true || data.gender === 'male' || data.gender === 'ç”·') {
                        userProfile.gender = 'male';
                    } else if (data.gender === false || data.gender === 'female' || data.gender === 'å¥³') {
                        userProfile.gender = 'female';
                    } else {
                        userProfile.gender = data.gender || '';
                    }

                    userProfile.height = data.height || '';
                    userProfile.weight = data.weight || '';

                    // æ´»å‹•ç­‰ç´šæ˜ å°„
                    const activityMap = {
                        'sedentary': '1.2',
                        'lightly_active': '1.375',
                        'moderately_active': '1.55',
                        'very_active': '1.725',
                        'extra_active': '1.9'
                    };
                    userProfile.activity = activityMap[data.activityLevel] || data.activityLevel || '';

                    // ç›®æ¨™æ˜ å°„
                    const goalMap = {
                        0: 'maintain',
                        1: 'lose_weight',
                        2: 'gain_muscle'
                    };
                    userProfile.goal = goalMap[data.goal] || data.goal || '';

                    console.log('ğŸ“‹ æ˜ å°„å¾Œçš„ userProfile:', JSON.stringify(userProfile, null, 2));

                    // æ›´æ–°è¡¨å–®é¡¯ç¤º
                    const ageEl = document.getElementById('userAge');
                    const genderEl = document.getElementById('userGender');
                    const heightEl = document.getElementById('userHeight');
                    const weightEl = document.getElementById('userWeight');
                    const activityEl = document.getElementById('userActivity');
                    const goalEl = document.getElementById('userGoal');

                    console.log('ğŸ¯ è¡¨å–®å…ƒç´ æª¢æŸ¥:', {
                        ageEl: !!ageEl,
                        genderEl: !!genderEl,
                        heightEl: !!heightEl,
                        weightEl: !!weightEl,
                        activityEl: !!activityEl,
                        goalEl: !!goalEl
                    });

                    if (ageEl) ageEl.value = userProfile.age;
                    if (genderEl) genderEl.value = userProfile.gender;
                    if (heightEl) heightEl.value = userProfile.height;
                    if (weightEl) weightEl.value = userProfile.weight;
                    if (activityEl) activityEl.value = userProfile.activity;
                    if (goalEl) goalEl.value = userProfile.goal;

                    console.log('âœ… è¡¨å–®å€¼å·²è¨­å®š:', {
                        age: ageEl?.value,
                        gender: genderEl?.value,
                        height: heightEl?.value,
                        weight: weightEl?.value,
                        activity: activityEl?.value,
                        goal: goalEl?.value
                    });

                    // è¨ˆç®—ä¸¦é¡¯ç¤º BMI/TDEE
                    updateProfile();

                    // é¡¯ç¤ºæ­¡è¿è¨Šæ¯
                    if (conversationHistory.length === 0 && userProfile.age && userProfile.height && userProfile.weight) {
                        setTimeout(() => {
                            const age = parseInt(userProfile.age);
                            const height = parseFloat(userProfile.height);
                            const weight = parseFloat(userProfile.weight);
                            const bmi = calculateBMI(weight, height);
                            const bmr = calculateBMR(weight, height, age, userProfile.gender);
                            const tdee = calculateTDEE(bmr, userProfile.activity);

                            addAIMessage(`æ­¡è¿å›ä¾†ï¼æˆ‘å·²è¼‰å…¥æ‚¨çš„å€‹äººè³‡æ–™ã€‚\n\næ‚¨çš„å¥åº·æŒ‡æ¨™ï¼š\nâ€¢ BMI: ${bmi.toFixed(1)} (${getBMIStatus(bmi).text})\nâ€¢ BMR: ${Math.round(bmr)} å¤§å¡/å¤©\nâ€¢ TDEE: ${Math.round(tdee)} å¤§å¡/å¤©\n\næœ‰ä»€éº¼ç‡Ÿé¤Šå•é¡Œæƒ³å•æˆ‘å—ï¼Ÿ`);
                        }, 500);
                    }
                } else {
                    console.log('â„¹ï¸ ç”¨æˆ¶å°šæœªè¨­å®šå€‹äººè³‡æ–™');
                    clearAllProfileData();
                }
            } catch (error) {
                console.error('âŒ è¼‰å…¥ Firestore è³‡æ–™å¤±æ•—:', error);
                clearAllProfileData();
            }
        }

        // âœ… æ¸…é™¤æ‰€æœ‰å€‹äººè³‡æ–™ï¼ˆç™»å‡ºæ™‚èª¿ç”¨ï¼Œé˜²æ­¢è³‡æ–™æ´©æ¼ï¼‰
        function clearAllProfileData() {
            console.log('ğŸ§¹ æ¸…é™¤æ‰€æœ‰å€‹äººè³‡æ–™');

            // æ¸…ç©º userProfile ç‰©ä»¶
            userProfile = {
                age: '',
                gender: '',
                height: '',
                weight: '',
                activity: '',
                goal: ''
            };

            // æ¸…ç©ºè¡¨å–®
            document.getElementById('userAge').value = '';
            document.getElementById('userGender').value = '';
            document.getElementById('userHeight').value = '';
            document.getElementById('userWeight').value = '';
            document.getElementById('userActivity').value = '';
            document.getElementById('userGoal').value = '';

            // æ¸…ç©ºå°è©±æ­·å²
            conversationHistory = [];

            // æ¸…ç©ºèŠå¤©è¨Šæ¯ï¼ˆä¿ç•™æ­¡è¿è¨Šæ¯ï¼‰
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = `
                <div class="welcome-message">
                    <h2>ğŸ‘‹ æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„ AI ç‡Ÿé¤Šå¸«</h2>
                    <p>ç™»å…¥å¾Œæˆ‘æœƒè¼‰å…¥æ‚¨çš„å€‹äººè³‡æ–™ï¼Œæä¾›æ›´ç²¾æº–çš„ç‡Ÿé¤Šå»ºè­°ã€‚<br>æ‚¨ä¹Ÿå¯ä»¥åˆ°<a href="profile_edit.html" style="color: #667eea;">å€‹äººè³‡æ–™</a>é é¢æ›´æ–°è³‡è¨Šã€‚</p>
                </div>
            `;

            // âŒ ä¸å†ä½¿ç”¨ localStorageï¼ˆå·²ç§»é™¤ï¼‰
            // localStorage.removeItem('userProfile');
        }

        // âš ï¸ å»¢æ£„èˆŠå‡½æ•¸ï¼ˆä¸å†ä½¿ç”¨ localStorageï¼‰
        function loadProfile() {
            console.warn('âš ï¸ loadProfile() å·²å»¢æ£„ï¼Œè«‹ä½¿ç”¨ loadUserProfileFromFirestore()');
            // ä¸åšä»»ä½•äº‹ï¼Œé˜²æ­¢è¼‰å…¥èˆŠè³‡æ–™
        }

        // åˆ‡æ›å¿«é€Ÿæå•å€åŸŸé¡¯ç¤º/éš±è—
        function toggleQuickQuestions() {
            const wrapper = document.getElementById('quickQuestionsWrapper');
            const toggleText = document.getElementById('toggleText');
            wrapper.classList.toggle('collapsed');

            if (wrapper.classList.contains('collapsed')) {
                toggleText.textContent = 'å±•é–‹æå•';
            } else {
                toggleText.textContent = 'å¿«é€Ÿæå•';
            }

            // å„²å­˜ç”¨æˆ¶åå¥½åˆ° localStorage
            localStorage.setItem('quickQuestionsCollapsed', wrapper.classList.contains('collapsed'));
        }

        // é é¢è¼‰å…¥æ™‚æ¢å¾©ç”¨æˆ¶åå¥½
        document.addEventListener('DOMContentLoaded', function() {
            const isCollapsed = localStorage.getItem('quickQuestionsCollapsed') === 'true';
            if (isCollapsed) {
                const wrapper = document.getElementById('quickQuestionsWrapper');
                const toggleText = document.getElementById('toggleText');
                wrapper.classList.add('collapsed');
                toggleText.textContent = 'å±•é–‹æå•';
            }
        });

        // ç™¼é€å¿«é€Ÿå•é¡Œ
        function sendQuickQuestion(question) {
            document.getElementById('messageInput').value = question;
            sendMessage();
        }

        // ç™¼é€è¨Šæ¯
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();

            if (!message) return;

            // é¡¯ç¤ºç”¨æˆ¶è¨Šæ¯
            addUserMessage(message);
            input.value = '';
            resetInputHeight();  // é‡ç½®è¼¸å…¥æ¡†é«˜åº¦

            // é¡¯ç¤ºè¼‰å…¥å‹•ç•«
            showTypingIndicator();

            // ç¦ç”¨ç™¼é€æŒ‰éˆ•
            document.getElementById('sendBtn').disabled = true;

            try {
                // æº–å‚™è«‹æ±‚è³‡æ–™
                const requestData = {
                    message: message,
                    profile: userProfile,
                    history: conversationHistory.slice(-6) // åªå‚³æœ€è¿‘ 3 è¼ªå°è©±
                };

                // å¦‚æœç”¨æˆ¶å·²ç™»å…¥ï¼ŒåŠ å…¥ ID Token
                if (userIdToken) {
                    requestData.id_token = userIdToken;
                    console.log('âœ… å·²é™„å¸¶ Firebase ID Token');
                }

                // ç™¼é€åˆ°å¾Œç«¯
                const response = await fetch('https://bentoai-api-30594327640.asia-east1.run.app/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });

                const data = await response.json();

                // ç§»é™¤è¼‰å…¥å‹•ç•«
                removeTypingIndicator();

                if (data.success) {
                    // é¡¯ç¤º AI å›æ‡‰
                    addAIMessage(data.answer);

                    // å¦‚æœåµæ¸¬åˆ°å€‹äººè³‡æ–™è®ŠåŒ–ï¼Œé¡¯ç¤ºç¢ºèªæŒ‰éˆ•
                    if (data.detected_profile && data.detected_profile.fields && data.detected_profile.fields.length > 0) {
                        showProfileUpdateConfirm(data.detected_profile);
                    }

                    // å¦‚æœä½¿ç”¨äº†é£²é£Ÿè¨˜éŒ„ï¼Œé¡¯ç¤ºæç¤º
                    if (data.diet_records_count && data.diet_records_count > 0) {
                        console.log(`âœ… AI å·²åƒè€ƒæ‚¨çš„ ${data.diet_records_count} ç­†é£²é£Ÿè¨˜éŒ„`);
                        // å¯ä»¥åœ¨èŠå¤©ç•Œé¢é¡¯ç¤ºå°æç¤º
                        addSystemMessage(`ğŸ’¡ AI å·²åƒè€ƒæ‚¨éå» ${data.diet_records_count} ç­†é£²é£Ÿè¨˜éŒ„æä¾›å»ºè­°`);
                    }

                    // æ›´æ–°å°è©±æ­·å²
                    conversationHistory.push({
                        user: message,
                        ai: data.answer
                    });
                } else {
                    addAIMessage('æŠ±æ­‰ï¼Œç³»çµ±ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
                }
            } catch (error) {
                removeTypingIndicator();
                addAIMessage('æŠ±æ­‰ï¼Œç„¡æ³•é€£æ¥åˆ°æœå‹™å™¨ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥ã€‚');
                console.error('Error:', error);
            }

            // å•Ÿç”¨ç™¼é€æŒ‰éˆ•ï¼ˆåŠ å…¥å†·å»æ™‚é–“é˜²æ­¢é€£é»ï¼‰
            setTimeout(() => {
                document.getElementById('sendBtn').disabled = false;
            }, 2000);  // 2 ç§’å†·å»
        }

        // æ·»åŠ ç”¨æˆ¶è¨Šæ¯
        function addUserMessage(text) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user';
            messageDiv.innerHTML = `
                <div class="message-content">
                    ${escapeHtml(text)}
                    <div class="message-time">${getCurrentTime()}</div>
                </div>
                <div class="message-avatar">ğŸ‘¤</div>
            `;
            messagesDiv.appendChild(messageDiv);
            scrollToBottom();
        }

        // æ·»åŠ  AI è¨Šæ¯
        function addAIMessage(text) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ai';

            // æª¢æŸ¥è¨Šæ¯é•·åº¦ï¼Œè¶…é 500 å­—å°±å¯æ”¶åˆ
            const isLong = text.length > 500;
            const messageId = 'msg-' + Date.now();

            messageDiv.innerHTML = `
                <div class="message-avatar">ğŸ¥—</div>
                <div class="message-content ${isLong ? 'collapsible' : ''}" id="${messageId}">
                    ${formatAIResponse(text)}
                    <div class="message-time">${getCurrentTime()}</div>
                </div>
            `;

            messagesDiv.appendChild(messageDiv);

            // å¦‚æœæ˜¯é•·è¨Šæ¯ï¼ŒåŠ å…¥å±•é–‹/æ”¶åˆæŒ‰éˆ•
            if (isLong) {
                const contentDiv = document.getElementById(messageId);
                const expandBtn = document.createElement('button');
                expandBtn.className = 'expand-btn';
                expandBtn.textContent = 'ğŸ“– å±•é–‹å®Œæ•´å›è¦†';
                expandBtn.onclick = function() {
                    if (contentDiv.classList.contains('expanded')) {
                        contentDiv.classList.remove('expanded');
                        expandBtn.textContent = 'ğŸ“– å±•é–‹å®Œæ•´å›è¦†';
                    } else {
                        contentDiv.classList.add('expanded');
                        expandBtn.textContent = 'ğŸ“• æ”¶åˆå›è¦†';
                    }
                };
                contentDiv.parentElement.appendChild(expandBtn);
            }

            scrollToBottom();
        }

        // æ·»åŠ ç³»çµ±æç¤ºè¨Šæ¯
        function addSystemMessage(text) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'system-message';
            messageDiv.innerHTML = `
                <div style="text-align: center; padding: 8px; margin: 10px 0; background: #e8f5e9; color: #2e7d32; border-radius: 8px; font-size: 0.85em;">
                    ${escapeHtml(text)}
                </div>
            `;
            messagesDiv.appendChild(messageDiv);
            scrollToBottom();
        }

        // é¡¯ç¤ºå€‹äººè³‡æ–™æ›´æ–°ç¢ºèªå¡ç‰‡
        function showProfileUpdateConfirm(detectedProfile) {
            const messagesDiv = document.getElementById('chatMessages');
            const confirmDiv = document.createElement('div');
            confirmDiv.className = 'profile-update-confirm';
            confirmDiv.id = 'profileUpdateConfirm-' + Date.now();

            // æ§‹å»ºæ¬„ä½é¡¯ç¤º
            let fieldsHtml = detectedProfile.fields.map(field => {
                const displayValue = field.display || `${field.value} ${field.unit || ''}`;
                return `<div class="update-field">
                    <span class="field-label">${escapeHtml(field.label)}</span>
                    <span class="field-value">${escapeHtml(displayValue)}</span>
                </div>`;
            }).join('');

            confirmDiv.innerHTML = `
                <div class="update-card">
                    <div class="update-header">
                        <span class="update-icon">ğŸ“</span>
                        <span>åµæ¸¬åˆ°è³‡æ–™è®ŠåŒ–ï¼Œæ˜¯å¦æ›´æ–°ï¼Ÿ</span>
                    </div>
                    <div class="update-fields">
                        ${fieldsHtml}
                    </div>
                    <div class="update-actions">
                        <button class="btn-confirm" onclick="confirmProfileUpdate('${confirmDiv.id}', ${JSON.stringify(detectedProfile.data).replace(/"/g, '&quot;')})">
                            âœ“ ç¢ºèªæ›´æ–°
                        </button>
                        <button class="btn-cancel" onclick="cancelProfileUpdate('${confirmDiv.id}')">
                            âœ— ä¸ç”¨äº†
                        </button>
                    </div>
                </div>
            `;

            messagesDiv.appendChild(confirmDiv);
            scrollToBottom();
        }

        // ç¢ºèªæ›´æ–°å€‹äººè³‡æ–™
        async function confirmProfileUpdate(cardId, updateData) {
            const card = document.getElementById(cardId);
            if (!card) return;

            // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
            const actionsDiv = card.querySelector('.update-actions');
            actionsDiv.innerHTML = '<div class="update-loading">æ›´æ–°ä¸­...</div>';

            try {
                const user = firebase.auth().currentUser;
                if (!user) {
                    throw new Error('è«‹å…ˆç™»å…¥');
                }

                const idToken = await user.getIdToken();
                const response = await fetch(`${API_BASE_URL}/api/chat/confirm-profile-update`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${idToken}`
                    },
                    body: JSON.stringify({ updates: updateData })
                });

                const data = await response.json();

                if (data.success) {
                    // æ›´æ–°æˆåŠŸï¼Œé¡¯ç¤ºæˆåŠŸè¨Šæ¯
                    card.innerHTML = `
                        <div class="update-card success">
                            <div class="update-result">
                                âœ… ${escapeHtml(data.message)}
                            </div>
                        </div>
                    `;
                    // æ›´æ–°å´é‚Šæ¬„çš„è³‡æ–™é¡¯ç¤º
                    loadUserProfile();
                } else {
                    throw new Error(data.error || 'æ›´æ–°å¤±æ•—');
                }
            } catch (error) {
                console.error('æ›´æ–°å€‹äººè³‡æ–™å¤±æ•—:', error);
                card.innerHTML = `
                    <div class="update-card error">
                        <div class="update-result">
                            âŒ æ›´æ–°å¤±æ•—ï¼š${escapeHtml(error.message)}
                        </div>
                    </div>
                `;
            }
        }

        // å–æ¶ˆæ›´æ–°
        function cancelProfileUpdate(cardId) {
            const card = document.getElementById(cardId);
            if (card) {
                card.innerHTML = `
                    <div class="update-card dismissed">
                        <div class="update-result">
                            å·²ç•¥éè³‡æ–™æ›´æ–°
                        </div>
                    </div>
                `;
            }
        }

        // é¡¯ç¤ºè¼‰å…¥å‹•ç•«
        function showTypingIndicator() {
            const messagesDiv = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message ai';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                <div class="message-avatar">ğŸ¥—</div>
                <div class="message-content">
                    <div class="typing-indicator">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;
            messagesDiv.appendChild(typingDiv);
            scrollToBottom();
        }

        // ç§»é™¤è¼‰å…¥å‹•ç•«
        function removeTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) {
                indicator.remove();
            }
        }

        // æ ¼å¼åŒ– AI å›æ‡‰ï¼ˆä½¿ç”¨ marked.js è§£æ Markdownï¼‰
        function formatAIResponse(text) {
            // ä½¿ç”¨ marked.js è§£æ Markdownï¼ˆæ­é…å®‰å…¨éæ¿¾ï¼‰
            if (typeof marked !== 'undefined') {
                // è¨­å®š marked é¸é …
                marked.setOptions({
                    breaks: true,      // æ”¯æ´æ›è¡Œ (GFM)
                    gfm: true          // å•Ÿç”¨ GitHub Flavored Markdown
                });

                const html = marked.parse(text);
                // ä½¿ç”¨å®‰å…¨å·¥å…·éæ¿¾ XSS
                if (typeof BentoAISecurity !== 'undefined') {
                    return BentoAISecurity.sanitizeHtml(html);
                }
                return html;
            }

            // å¦‚æœ marked æœªè¼‰å…¥ï¼Œä½¿ç”¨åŸºæœ¬æ ¼å¼åŒ–
            text = text.replace(/\n/g, '<br>');
            text = text.replace(/^\*\s+/gm, 'â€¢ ');
            text = text.replace(/^-\s+/gm, 'â€¢ ');
            return text;
        }

        // è½‰ç¾© HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ç²å–ç•¶å‰æ™‚é–“
        function getCurrentTime() {
            const now = new Date();
            return now.getHours().toString().padStart(2, '0') + ':' +
                   now.getMinutes().toString().padStart(2, '0');
        }

        // æ»¾å‹•åˆ°åº•éƒ¨
        function scrollToBottom() {
            const messagesDiv = document.getElementById('chatMessages');
            setTimeout(() => {
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }, 100);
        }

        // âœ… é é¢è¼‰å…¥æ™‚ï¼ˆè³‡æ–™ç”± onAuthStateChanged è‡ªå‹•è¼‰å…¥ï¼‰
        window.onload = function() {
            console.log('ğŸ“„ é é¢å·²è¼‰å…¥ï¼Œç­‰å¾… Firebase Auth ç‹€æ…‹...');
            // ä¸å†èª¿ç”¨ loadProfile()ï¼Œæ”¹ç”± onAuthStateChanged è‡ªå‹•è¼‰å…¥ç”¨æˆ¶å°ˆå±¬è³‡æ–™
        };
    </script>
</body>
</html>

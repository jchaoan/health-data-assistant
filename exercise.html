<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <!-- æ·±è‰²æ¨¡å¼ï¼ˆå…§è¯è…³æœ¬+æ¨£å¼ï¼Œé¿å…é–ƒçˆï¼‰ -->
    <script>try{var s=JSON.parse(localStorage.getItem('bentoai_settings')||'{}');if(s.darkMode){document.documentElement.classList.add('dark-mode')}else{document.documentElement.classList.remove('dark-mode')}}catch(e){document.documentElement.classList.remove('dark-mode')}</script>
    <style>html.dark-mode,html.dark-mode body{background:linear-gradient(135deg,#1a1a2e 0%,#16213e 100%)!important}html.dark-mode .bottom-nav{background:#1a1a2e!important;border-top:1px solid #2a2a3e}html.dark-mode .nav-item{color:#888!important}html.dark-mode .container,html.dark-mode .header,html.dark-mode .section,html.dark-mode .form-section,html.dark-mode .form-group,html.dark-mode .settings-section,html.dark-mode .settings-item,html.dark-mode .user-card,html.dark-mode .user-header,html.dark-mode .user-info,html.dark-mode .profile-item,html.dark-mode .profile-grid,html.dark-mode .profile-panel,html.dark-mode .option-card,html.dark-mode .feature-card,html.dark-mode .stat-card,html.dark-mode .summary-item,html.dark-mode .nutrition-item,html.dark-mode .nutrition-card,html.dark-mode .chart-container,html.dark-mode .chart-section,html.dark-mode .insight-card,html.dark-mode .tips-card,html.dark-mode .recent-card,html.dark-mode .card,html.dark-mode .chat-container,html.dark-mode .chat-header,html.dark-mode .chat-messages,html.dark-mode .chat-input-area,html.dark-mode .quick-questions,html.dark-mode .welcome-message,html.dark-mode .edit-form,html.dark-mode .stats-grid,html.dark-mode .loading,html.dark-mode .step,html.dark-mode .total-item,html.dark-mode .input-wrapper,html.dark-mode .options-grid,html.dark-mode .multi-option,html.dark-mode .tech-item,html.dark-mode .empty-state,html.dark-mode .filter-btn,html.dark-mode .time-selector,html.dark-mode .controls,html.dark-mode .record-card,html.dark-mode .meal-section,html.dark-mode .food-item,html.dark-mode .modal-content,html.dark-mode .upload-area,html.dark-mode .result-card,html.dark-mode .analysis-card{background:#1e1e2e!important;color:#e0e0e0!important}html.dark-mode input,html.dark-mode select,html.dark-mode textarea{background:#2a2a3e!important;color:#e0e0e0!important;border-color:#3a3a4e!important}html.dark-mode .btn-secondary{background:#3a3a4e!important;color:#e0e0e0!important}</style>
    <meta charset="UTF-8">
    <script src="/js/dark-mode.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <title>é‹å‹•å»ºè­° - ç‡Ÿé¤Šè¿½è¹¤ç³»çµ±</title>
    <!-- PWA æ”¯æ´ -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="å¥åº·åŠ©ç†">
    <link rel="apple-touch-icon" href="logo.png">
    <link rel="icon" href="logo.png" type="image/png">
    <!-- PWA å„ªåŒ–æ¨£å¼ -->
    <link rel="stylesheet" href="/css/pwa.css">

    <!-- å…±ç”¨å·¥å…·å‡½æ•¸ -->
    <script src="/js/utils.js"></script>
    <script src="/js/security.js"></script>
    <!-- PWA å®‰è£æç¤º -->
    <script src="/js/pwa-install.js" defer></script>
    <script src="/js/pwa-utils.js" defer></script>

    <!-- Markdown è§£æå™¨ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 120px; /* å¢åŠ åº•éƒ¨ç©ºé–“çµ¦å°èˆªæ¬„ */
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 25px 30px;
            margin-bottom: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 28px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-logo {
            width: 40px;
            height: 40px;
            object-fit: contain;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #667eea;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        .btn-refresh {
            background: #10b981;
            color: white;
        }

        .btn-refresh:hover {
            background: #059669;
        }

        /* ç”¨æˆ¶æ‘˜è¦å¡ç‰‡ */
        .user-summary {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .user-summary h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .summary-item {
            background: linear-gradient(135deg, #f8f9ff 0%, #f0f3ff 100%);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            border-left: 4px solid #667eea;
        }

        .summary-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .summary-value {
            font-size: 18px;
            font-weight: 700;
            color: #667eea;
        }

        /* è¼‰å…¥ç‹€æ…‹ */
        .loading {
            background: white;
            border-radius: 15px;
            padding: 60px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e0e0e0;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading p {
            color: #666;
            font-size: 16px;
        }

        /* ç„¡è³‡æ–™æç¤º */
        .no-profile {
            background: white;
            border-radius: 15px;
            padding: 60px 30px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .no-profile-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .no-profile h2 {
            color: #333;
            margin-bottom: 15px;
        }

        .no-profile p {
            color: #666;
            margin-bottom: 25px;
            line-height: 1.6;
        }

        /* é‹å‹•å»ºè­°å…§å®¹ */
        .recommendation-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .recommendation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .recommendation-header h2 {
            color: #333;
            font-size: 22px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .recommendation-content {
            line-height: 1.8;
            color: #444;
        }

        /* Markdown æ¸²æŸ“æ¨£å¼ */
        .recommendation-content h1 {
            color: #667eea;
            font-size: 1.5em;
            margin: 25px 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }

        .recommendation-content h2 {
            color: #764ba2;
            font-size: 1.3em;
            margin: 20px 0 12px 0;
        }

        .recommendation-content h3 {
            color: #333;
            font-size: 1.15em;
            margin: 15px 0 10px 0;
        }

        .recommendation-content p {
            margin-bottom: 12px;
        }

        .recommendation-content ul,
        .recommendation-content ol {
            margin: 12px 0;
            padding-left: 25px;
        }

        .recommendation-content li {
            margin: 8px 0;
        }

        .recommendation-content strong {
            color: #333;
            font-weight: 600;
        }

        .recommendation-content hr {
            border: none;
            border-top: 2px dashed #e0e0e0;
            margin: 25px 0;
        }

        .recommendation-content blockquote {
            background: #fff8e1;
            border-left: 4px solid #ffc107;
            padding: 15px 20px;
            margin: 15px 0;
            border-radius: 8px;
            color: #5d4037;
        }

        .recommendation-content code {
            background: #f4f4f4;
            padding: 2px 8px;
            border-radius: 4px;
            font-family: monospace;
        }

        /* å¿«é€Ÿæç¤ºå€ */
        .quick-tips {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            border-left: 4px solid #4caf50;
        }

        .quick-tips h4 {
            color: #2e7d32;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .quick-tips ul {
            list-style: none;
            padding: 0;
        }

        .quick-tips li {
            padding: 8px 0;
            color: #33691e;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .quick-tips li::before {
            content: ">";
            color: #4caf50;
            font-weight: bold;
        }

        /* éŒ¯èª¤è¨Šæ¯ */
        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border-left: 4px solid #ef5350;
        }

        /* é€²åº¦è¿½è¹¤å¡ç‰‡ */
        .progress-card {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            border-left: 4px solid #2196f3;
        }

        .progress-card h3 {
            color: #1565c0;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .progress-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }

        .progress-stat {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .progress-stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #1565c0;
        }

        .progress-stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .progress-change {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            margin-top: 5px;
            font-size: 13px;
        }

        .progress-change.positive {
            color: #4caf50;
        }

        .progress-change.negative {
            color: #f44336;
        }

        /* æ–°æ‰‹æ­¡è¿æç¤º */
        .welcome-tip {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-radius: 12px;
            padding: 15px;
            margin-top: 15px;
            border-left: 4px solid #4caf50;
            animation: fadeInUp 0.5s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .welcome-tip-icon {
            font-size: 28px;
            line-height: 1;
        }

        .welcome-tip-content {
            flex: 1;
        }

        .welcome-tip-content strong {
            color: #2e7d32;
            font-size: 15px;
        }

        .welcome-tip-content p {
            color: #388e3c;
            font-size: 13px;
            margin: 5px 0 0 0;
            line-height: 1.5;
        }

        html.dark-mode .welcome-tip {
            background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%);
        }

        html.dark-mode .welcome-tip-content strong {
            color: #c8e6c9;
        }

        html.dark-mode .welcome-tip-content p {
            color: #a5d6a7;
        }

        /* åé¥‹å€å¡Š */
        .feedback-section {
            background: #fff3e0;
            border-radius: 12px;
            padding: 20px;
            margin-top: 25px;
            border-left: 4px solid #ff9800;
        }

        .feedback-section h4 {
            color: #e65100;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .feedback-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .feedback-btn {
            padding: 10px 20px;
            border: 2px solid #ddd;
            border-radius: 25px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .feedback-btn:hover {
            border-color: #667eea;
            background: #f0f3ff;
        }

        .feedback-btn.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .feedback-btn.selected:hover {
            opacity: 0.9;
        }

        .feedback-success {
            color: #4caf50;
            font-size: 14px;
            margin-top: 15px;
            display: none;
        }

        /* ===== éŸ¿æ‡‰å¼è¨­è¨ˆ ===== */

        /* å¤§è¢å¹• (æ¡Œé¢) */
        @media (min-width: 1200px) {
            .container {
                max-width: 1000px;
            }
        }

        /* ä¸­ç­‰è¢å¹• (å¹³æ¿) */
        @media (max-width: 1199px) and (min-width: 769px) {
            .container {
                max-width: 95%;
            }

            .header h1 {
                font-size: 24px;
            }

            .summary-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        /* å°è¢å¹• (æ‰‹æ©Ÿæ©«å‘ & å°å¹³æ¿) */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
                padding: 20px;
            }

            .header h1 {
                font-size: 22px;
            }

            .header-actions {
                width: 100%;
                justify-content: center;
                flex-wrap: wrap;
                gap: 8px;
            }

            .btn {
                padding: 10px 18px;
                font-size: 13px;
            }

            .user-summary {
                padding: 20px;
            }

            .user-summary h3 {
                flex-direction: column;
                gap: 5px;
                text-align: center;
            }

            .user-summary h3 span:last-child {
                margin-left: 0 !important;
            }

            .summary-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .summary-item {
                padding: 12px;
            }

            .summary-value {
                font-size: 16px;
            }

            .quick-tips {
                padding: 15px;
            }

            .quick-tips h4 {
                font-size: 15px;
            }

            .recommendation-card {
                padding: 20px;
            }

            .recommendation-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .recommendation-header h2 {
                font-size: 18px;
            }

            .recommendation-content {
                font-size: 15px;
                line-height: 1.7;
            }

            .recommendation-content h1 {
                font-size: 1.3em;
            }

            .recommendation-content h2 {
                font-size: 1.15em;
            }

            .recommendation-content h3 {
                font-size: 1.05em;
            }

            .no-profile {
                padding: 40px 20px;
            }

            .no-profile-icon {
                font-size: 48px;
            }

            .no-profile h2 {
                font-size: 20px;
            }

            .no-profile p {
                font-size: 14px;
            }

            .loading {
                padding: 40px 20px;
            }

            .error-message {
                padding: 15px;
                font-size: 14px;
            }
        }

        /* è¶…å°è¢å¹• (æ‰‹æ©Ÿç›´å‘) */
        @media (max-width: 480px) {
            body {
                padding: 5px;
            }

            .header {
                padding: 15px;
                border-radius: 10px;
            }

            .header h1 {
                font-size: 18px;
                flex-direction: column;
                gap: 5px;
            }

            .header-actions {
                gap: 6px;
            }

            .btn {
                padding: 8px 12px;
                font-size: 12px;
                border-radius: 8px;
            }

            .user-summary {
                padding: 15px;
                border-radius: 10px;
                margin-bottom: 15px;
            }

            .user-summary h3 {
                font-size: 15px;
                margin-bottom: 15px;
            }

            .summary-grid {
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }

            .summary-item {
                padding: 10px;
                border-radius: 8px;
            }

            .summary-label {
                font-size: 11px;
            }

            .summary-value {
                font-size: 14px;
            }

            .quick-tips {
                padding: 12px;
                border-radius: 10px;
                margin-bottom: 15px;
            }

            .quick-tips h4 {
                font-size: 14px;
                margin-bottom: 10px;
            }

            .quick-tips li {
                font-size: 13px;
                padding: 6px 0;
            }

            .recommendation-card {
                padding: 15px;
                border-radius: 10px;
            }

            .recommendation-header {
                margin-bottom: 15px;
                padding-bottom: 10px;
            }

            .recommendation-header h2 {
                font-size: 16px;
            }

            #generatedTime {
                font-size: 12px !important;
            }

            .recommendation-content {
                font-size: 14px;
                line-height: 1.6;
            }

            .recommendation-content h1 {
                font-size: 1.2em;
                margin: 20px 0 12px 0;
            }

            .recommendation-content h2 {
                font-size: 1.1em;
                margin: 16px 0 10px 0;
            }

            .recommendation-content h3 {
                font-size: 1em;
                margin: 12px 0 8px 0;
            }

            .recommendation-content ul,
            .recommendation-content ol {
                padding-left: 20px;
            }

            .recommendation-content li {
                margin: 6px 0;
            }

            .recommendation-content blockquote {
                padding: 12px 15px;
                font-size: 13px;
            }

            .recommendation-content hr {
                margin: 20px 0;
            }

            .no-profile {
                padding: 30px 15px;
                border-radius: 10px;
            }

            .no-profile-icon {
                font-size: 40px;
                margin-bottom: 15px;
            }

            .no-profile h2 {
                font-size: 18px;
                margin-bottom: 10px;
            }

            .no-profile p {
                font-size: 13px;
                margin-bottom: 20px;
            }

            .loading {
                padding: 30px 15px;
                border-radius: 10px;
            }

            .spinner {
                width: 40px;
                height: 40px;
            }

            .loading p {
                font-size: 14px;
            }

            .error-message {
                padding: 12px;
                font-size: 13px;
                border-radius: 8px;
            }
        }

        /* è§¸æ§è£ç½®å„ªåŒ– */
        @media (hover: none) and (pointer: coarse) {
            .btn {
                min-height: 44px;
            }

            .btn:active {
                transform: scale(0.98);
            }

            .summary-item:active {
                transform: scale(0.98);
            }
        }

        /* åº•éƒ¨å°èˆªæ¬„ */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 8px 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: #666;
            font-size: 12px;
            padding: 5px 10px;
            border-radius: 10px;
            transition: all 0.3s;
            min-width: 60px;
        }

        .nav-item:hover {
            background: #f0f4ff;
            color: #667eea;
        }

        .nav-item.active {
            color: #667eea;
        }

        .nav-item.active .nav-icon {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .nav-icon {
            font-size: 20px;
            margin-bottom: 3px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            transition: all 0.3s;
        }

        .nav-label {
            font-weight: 500;
        }

        @media (max-width: 480px) {
            .nav-item {
                font-size: 10px;
                padding: 5px 5px;
                min-width: 50px;
            }

            .nav-icon {
                font-size: 18px;
                width: 35px;
                height: 35px;
            }

            .bottom-nav {
                padding: 5px 0;
            }
        }

        /* æ·±è‰²æ¨¡å¼ */
        html.dark-mode {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }

        html.dark-mode .header {
            background: #1e1e1e;
        }

        html.dark-mode .header h1 {
            color: #667eea;
        }

        html.dark-mode .btn-secondary {
            background: #333;
            color: #e0e0e0;
        }

        html.dark-mode .btn-secondary:hover {
            background: #444;
        }

        html.dark-mode .profile-summary {
            background: #1e1e1e;
        }

        html.dark-mode .profile-item {
            background: #2a2a2a;
        }

        html.dark-mode .profile-item span:first-child {
            color: #888;
        }

        html.dark-mode .profile-item span:last-child {
            color: #e0e0e0;
        }

        html.dark-mode .recommendation-card {
            background: #1e1e1e;
        }

        html.dark-mode .recommendation-title {
            color: #667eea;
        }

        html.dark-mode .recommendation-content {
            color: #e0e0e0;
        }

        html.dark-mode .recommendation-content h1,
        html.dark-mode .recommendation-content h2,
        html.dark-mode .recommendation-content h3 {
            color: #667eea;
        }

        html.dark-mode .recommendation-content blockquote {
            background: #2a2a2a;
            color: #ccc;
        }

        html.dark-mode .recommendation-content code {
            background: #333;
        }

        html.dark-mode .loading-card {
            background: #1e1e1e;
        }

        html.dark-mode .loading-card p {
            color: #888;
        }

        html.dark-mode .empty-card {
            background: #1e1e1e;
        }

        html.dark-mode .empty-card h3 {
            color: #667eea;
        }

        html.dark-mode .empty-card p {
            color: #888;
        }

        html.dark-mode .bottom-nav {
            background: #1e1e1e;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
        }

        html.dark-mode .nav-item {
            color: #888;
        }

        html.dark-mode .nav-item:hover,
        html.dark-mode .nav-item.active {
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- é é¦– -->
        <div class="header">
            <h1>
                <img src="logo.png" alt="Logo" class="header-logo">
                å€‹äººåŒ–é‹å‹•å»ºè­°
            </h1>
            <div class="header-actions">
                <button class="btn btn-refresh" onclick="refreshRecommendation()">
                    &#x21BB; é‡æ–°ç”Ÿæˆ
                </button>
                <button class="btn btn-secondary" onclick="window.location.href='profile_setup.html'">
                    &#9998; ç·¨è¼¯è³‡æ–™
                </button>
                <button class="btn btn-secondary" onclick="window.location.href='dashboard.html'">
                    &#8592; è¿”å›ä¸»é 
                </button>
            </div>
        </div>

        <!-- è¼‰å…¥ä¸­ -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>æ­£åœ¨ç”Ÿæˆæ‚¨çš„å€‹äººåŒ–é‹å‹•å»ºè­°...</p>
            <p style="font-size: 14px; color: #999; margin-top: 10px;">é€™å¯èƒ½éœ€è¦å¹¾ç§’é˜</p>
        </div>

        <!-- ç„¡è³‡æ–™æç¤º -->
        <div id="noProfile" class="no-profile" style="display: none;">
            <div class="no-profile-icon">&#128170;</div>
            <h2>å°šæœªè¨­å®šé‹å‹•è³‡æ–™</h2>
            <p>
                è«‹å…ˆå®Œæˆå€‹äººè³‡æ–™è¨­å®šä¸­çš„ã€Œé‹å‹•ç¿’æ…£ã€éƒ¨åˆ†ï¼Œ<br>
                ç³»çµ±æ‰èƒ½ç‚ºæ‚¨ç”Ÿæˆå€‹äººåŒ–çš„é‹å‹•å»ºè­°ã€‚
            </p>
            <button class="btn btn-primary" onclick="window.location.href='profile_setup.html'">
                &#9989; å‰å¾€è¨­å®š
            </button>
        </div>

        <!-- éŒ¯èª¤è¨Šæ¯ -->
        <div id="errorMessage" class="error-message" style="display: none;"></div>

        <!-- é€²åº¦è¿½è¹¤å¡ç‰‡ -->
        <div id="progressCard" class="progress-card" style="display: none;">
            <h3>
                <span>&#128200;</span>
                æ‚¨çš„é‹å‹•é€²åº¦è¿½è¹¤
            </h3>
            <div class="progress-stats">
                <div class="progress-stat">
                    <div class="progress-stat-value" id="historyCount">0</div>
                    <div class="progress-stat-label">ç´¯è¨ˆå»ºè­°æ¬¡æ•¸</div>
                </div>
                <div class="progress-stat">
                    <div class="progress-stat-value" id="currentWeight">-</div>
                    <div class="progress-stat-label">ç›®å‰é«”é‡</div>
                    <div class="progress-change" id="weightChange"></div>
                </div>
                <div class="progress-stat">
                    <div class="progress-stat-value" id="currentBMI">-</div>
                    <div class="progress-stat-label">ç›®å‰ BMI</div>
                    <div class="progress-change" id="bmiChange"></div>
                </div>
                <div class="progress-stat">
                    <div class="progress-stat-value" id="executedCount">0</div>
                    <div class="progress-stat-label">å·²åŸ·è¡Œå»ºè­°</div>
                </div>
            </div>
            <!-- æ–°æ‰‹æ­¡è¿æç¤º -->
            <div id="welcomeTip" class="welcome-tip" style="display: none;">
                <span class="welcome-tip-icon">ğŸ‰</span>
                <div class="welcome-tip-content">
                    <strong>æ­¡è¿é–‹å§‹æ‚¨çš„å¥èº«ä¹‹æ—…ï¼</strong>
                    <p>AI æ­£åœ¨æ ¹æ“šæ‚¨çš„å€‹äººè³‡æ–™ç”Ÿæˆå°ˆå±¬é‹å‹•è¨ˆç•«ï¼Œæ¯æ¬¡åŸ·è¡Œå¾Œåˆ¥å¿˜äº†çµ¦æˆ‘å€‘åé¥‹å“¦ï½</p>
                </div>
            </div>
        </div>

        <!-- ç”¨æˆ¶æ‘˜è¦ -->
        <div id="userSummary" class="user-summary" style="display: none;">
            <h3>
                <span>&#128100;</span>
                æ‚¨çš„é‹å‹•è³‡æ–™æ‘˜è¦
                <span style="font-size: 12px; color: #999; font-weight: normal; margin-left: auto;">
                    (æ ¹æ“šæœ€æ–°å€‹äººè³‡æ–™å‹•æ…‹ç”Ÿæˆ)
                </span>
            </h3>
            <div class="summary-grid">
                <div class="summary-item">
                    <div class="summary-label">å¥åº·ç›®æ¨™</div>
                    <div class="summary-value" id="goalText">-</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">ç›®å‰é«”é‡</div>
                    <div class="summary-value" id="weightText">-</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">BMI</div>
                    <div class="summary-value" id="bmiText">-</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">é‹å‹•é »ç‡</div>
                    <div class="summary-value" id="frequencyText">-</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">é‹å‹•ç¶“é©—</div>
                    <div class="summary-value" id="experienceText">-</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">æ¯æ¬¡æ™‚é–“</div>
                    <div class="summary-value" id="timeText">-</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">èº«é«”é™åˆ¶</div>
                    <div class="summary-value" id="limitationsText">ç„¡</div>
                </div>
            </div>
        </div>

        <!-- å¿«é€Ÿæç¤º -->
        <div id="quickTips" class="quick-tips" style="display: none;">
            <h4>
                <span>&#128161;</span>
                ä»Šæ—¥é‹å‹•å°æç¤º
            </h4>
            <ul id="tipsList"></ul>
        </div>

        <!-- é‹å‹•å»ºè­°å…§å®¹ -->
        <div id="recommendationCard" class="recommendation-card" style="display: none;">
            <div class="recommendation-header">
                <h2>
                    <span>&#128203;</span>
                    æ‚¨çš„å°ˆå±¬é‹å‹•è¨ˆç•«
                </h2>
                <span style="color: #999; font-size: 14px;" id="generatedTime"></span>
            </div>
            <div class="recommendation-content" id="recommendationContent"></div>

            <!-- åé¥‹å€å¡Š -->
            <div class="feedback-section" id="feedbackSection" style="display: none;">
                <h4>
                    <span>&#128172;</span>
                    é€™å€‹å»ºè­°å°æ‚¨æœ‰å¹«åŠ©å—ï¼Ÿ
                </h4>
                <div class="feedback-buttons">
                    <button class="feedback-btn" data-feedback="helpful" onclick="submitFeedback('helpful')">
                        <span>&#128077;</span> æœ‰å¹«åŠ©
                    </button>
                    <button class="feedback-btn" data-feedback="executed" onclick="submitFeedback('executed')">
                        <span>&#9989;</span> æˆ‘æœƒåŸ·è¡Œ
                    </button>
                    <button class="feedback-btn" data-feedback="partially_executed" onclick="submitFeedback('partially_executed')">
                        <span>&#128221;</span> éƒ¨åˆ†åŸ·è¡Œ
                    </button>
                    <button class="feedback-btn" data-feedback="not_helpful" onclick="submitFeedback('not_helpful')">
                        <span>&#128078;</span> éœ€è¦èª¿æ•´
                    </button>
                </div>
                <div class="feedback-success" id="feedbackSuccess">
                    <span>&#10003;</span> æ„Ÿè¬æ‚¨çš„åé¥‹ï¼ä¸‹æ¬¡å»ºè­°å°‡æ ¹æ“šæ‚¨çš„å›é¥‹é€²è¡Œèª¿æ•´ã€‚
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <script>
        // Firebase é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyCk4GY-VkG4dd_zXP5HZQDlZbjdY0k0img",
            authDomain: "fooddata-92fa8.firebaseapp.com",
            projectId: "fooddata-92fa8",
            storageBucket: "fooddata-92fa8.firebasestorage.app",
            messagingSenderId: "459965557703",
            appId: "1:459965557703:web:6a16b3937935219eb887e2",
            measurementId: "G-R16CYV7QC2"
        };

        // åˆå§‹åŒ– Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        let currentIdToken = null;
        let currentHistoryId = null;  // ç›®å‰å»ºè­°çš„æ­·å²è¨˜éŒ„ ID
        let currentProfile = null;    // ç›®å‰ç”¨æˆ¶è³‡æ–™

        // å°æ‡‰è¡¨
        const goalMap = {
            0: 'ç¶­æŒé«”é‡',
            1: 'æ¸›é‡æ¸›è„‚',
            2: 'å¢è‚Œå¢é‡',
            3: 'æ”¹å–„å¥åº·'
        };

        const frequencyMap = {
            0: 'å¹¾ä¹ä¸é‹å‹•',
            1: 'æ¯é€±1-2æ¬¡',
            2: 'æ¯é€±3-4æ¬¡',
            3: 'æ¯é€±5æ¬¡ä»¥ä¸Š'
        };

        const experienceMap = {
            0: 'æ–°æ‰‹',
            1: 'åˆå­¸è€…',
            2: 'ä¸­ç´šè€…',
            3: 'é€²éšè€…'
        };

        const timeMap = {
            0: '15-30åˆ†é˜',
            1: '30-60åˆ†é˜',
            2: '60-90åˆ†é˜',
            3: '90åˆ†é˜ä»¥ä¸Š'
        };

        // ç›£è¯ç™»å…¥ç‹€æ…‹
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentIdToken = await user.getIdToken();
                // å…ˆè¼‰å…¥é€²åº¦è³‡æ–™ï¼Œå†è¼‰å…¥å»ºè­°
                await loadProgressData();
                loadExerciseRecommendation();
            } else {
                alert('è«‹å…ˆç™»å…¥');
                window.location.href = 'login.html';
            }
        });

        // è¼‰å…¥é€²åº¦è³‡æ–™
        async function loadProgressData() {
            try {
                const response = await fetch('https://bentoai-api-30594327640.asia-east1.run.app/api/exercise/progress', {
                    headers: {
                        'Authorization': `Bearer ${currentIdToken}`
                    }
                });

                const data = await response.json();

                if (data.success && data.progress) {
                    displayProgressCard(data.progress);
                }
            } catch (error) {
                console.error('è¼‰å…¥é€²åº¦è³‡æ–™å¤±æ•—:', error);
            }
        }

        // é¡¯ç¤ºé€²åº¦å¡ç‰‡
        function displayProgressCard(progress) {
            document.getElementById('historyCount').textContent = progress.history_count || 0;

            // é«”é‡è®ŠåŒ–
            const weightChanges = progress.weight_changes || [];
            if (weightChanges.length > 0) {
                const currentWeight = weightChanges[0].weight;
                document.getElementById('currentWeight').textContent = currentWeight + ' kg';

                if (weightChanges.length >= 2) {
                    const firstWeight = weightChanges[weightChanges.length - 1].weight;
                    const diff = currentWeight - firstWeight;
                    const changeEl = document.getElementById('weightChange');
                    if (diff !== 0) {
                        const direction = diff < 0 ? 'positive' : 'negative';
                        const arrow = diff < 0 ? '&#9660;' : '&#9650;';
                        changeEl.innerHTML = arrow + ' ' + Math.abs(diff).toFixed(1) + ' kg';
                        changeEl.className = 'progress-change ' + direction;
                    }
                }
            }

            // BMI è®ŠåŒ–
            const bmiChanges = progress.bmi_changes || [];
            if (bmiChanges.length > 0) {
                const currentBMI = bmiChanges[0].bmi;
                document.getElementById('currentBMI').textContent = currentBMI.toFixed(1);

                if (bmiChanges.length >= 2) {
                    const firstBMI = bmiChanges[bmiChanges.length - 1].bmi;
                    const diff = currentBMI - firstBMI;
                    const changeEl = document.getElementById('bmiChange');
                    if (diff !== 0) {
                        const direction = diff < 0 ? 'positive' : 'negative';
                        const arrow = diff < 0 ? '&#9660;' : '&#9650;';
                        changeEl.innerHTML = arrow + ' ' + Math.abs(diff).toFixed(1);
                        changeEl.className = 'progress-change ' + direction;
                    }
                }
            }

            // å·²åŸ·è¡Œæ¬¡æ•¸
            const feedback = progress.feedback_summary || {};
            const executed = (feedback.executed || 0) + (feedback.partially_executed || 0);
            document.getElementById('executedCount').textContent = executed;

            // æ–°æ‰‹æ­¡è¿æç¤ºï¼ˆé¦–æ¬¡ä½¿ç”¨æˆ–ä½¿ç”¨æ¬¡æ•¸å°‘æ–¼ 3 æ¬¡ï¼‰
            const historyCount = progress.history_count || 0;
            const welcomeTip = document.getElementById('welcomeTip');
            if (historyCount <= 2) {
                welcomeTip.style.display = 'flex';
            } else {
                welcomeTip.style.display = 'none';
            }

            // é¡¯ç¤ºé€²åº¦å¡ç‰‡
            document.getElementById('progressCard').style.display = 'block';
        }

        // è¼‰å…¥é‹å‹•å»ºè­°
        async function loadExerciseRecommendation() {
            showLoading(true);

            try {
                // å…ˆå–å¾—ç”¨æˆ¶è³‡æ–™
                const profileResponse = await fetch('https://bentoai-api-30594327640.asia-east1.run.app/api/user/profile', {
                    headers: {
                        'Authorization': `Bearer ${currentIdToken}`
                    }
                });

                const profileData = await profileResponse.json();

                if (!profileData.success || !profileData.profile) {
                    showNoProfile();
                    return;
                }

                const profile = profileData.profile;

                // æª¢æŸ¥æ˜¯å¦æœ‰é‹å‹•è³‡æ–™
                if (!profile.hasExerciseProfile) {
                    showNoProfile();
                    return;
                }

                // é¡¯ç¤ºç”¨æˆ¶æ‘˜è¦
                displayUserSummary(profile);

                // åŒæ­¥æ›´æ–°é€²åº¦å¡ç‰‡çš„é«”é‡å’Œ BMIï¼ˆä½¿ç”¨æœ€æ–° profile æ•¸æ“šï¼‰
                if (profile.weight) {
                    document.getElementById('currentWeight').textContent = profile.weight + ' kg';
                }
                if (profile.BMI) {
                    document.getElementById('currentBMI').textContent = profile.BMI.toFixed(1);
                }

                // å–å¾—é‹å‹•å»ºè­°
                const recommendationResponse = await fetch('https://bentoai-api-30594327640.asia-east1.run.app/api/exercise/recommendation', {
                    headers: {
                        'Authorization': `Bearer ${currentIdToken}`
                    }
                });

                const recommendationData = await recommendationResponse.json();

                if (recommendationData.success && recommendationData.recommendation) {
                    // å„²å­˜ history_id ä¾›åé¥‹ä½¿ç”¨
                    currentHistoryId = recommendationData.history_id;

                    displayRecommendation(recommendationData.recommendation);

                    // å–å¾—å¿«é€Ÿæç¤º
                    loadQuickTips();
                } else if (recommendationData.error === 'no_exercise_data') {
                    showNoProfile();
                } else {
                    showError(recommendationData.message || 'ç”Ÿæˆé‹å‹•å»ºè­°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
                }

            } catch (error) {
                console.error('è¼‰å…¥é‹å‹•å»ºè­°å¤±æ•—:', error);
                showError('è¼‰å…¥å¤±æ•—: ' + error.message);
            }
        }

        // è¼‰å…¥å¿«é€Ÿæç¤º
        async function loadQuickTips() {
            try {
                const response = await fetch('https://bentoai-api-30594327640.asia-east1.run.app/api/exercise/quick-tips', {
                    headers: {
                        'Authorization': `Bearer ${currentIdToken}`
                    }
                });

                const data = await response.json();

                if (data.success && data.tips && data.tips.length > 0) {
                    displayQuickTips(data.tips);
                }
            } catch (error) {
                console.error('è¼‰å…¥å¿«é€Ÿæç¤ºå¤±æ•—:', error);
            }
        }

        // é¡¯ç¤ºç”¨æˆ¶æ‘˜è¦
        function displayUserSummary(profile) {
            document.getElementById('goalText').textContent = goalMap[profile.goal] || '-';
            document.getElementById('weightText').textContent = profile.weight ? `${profile.weight} kg` : '-';
            document.getElementById('frequencyText').textContent = frequencyMap[profile.exerciseFrequency] || '-';
            document.getElementById('experienceText').textContent = experienceMap[profile.exerciseExperience] || '-';
            document.getElementById('timeText').textContent = timeMap[profile.exerciseTimePerSession] || '-';
            document.getElementById('bmiText').textContent = profile.BMI ? profile.BMI.toFixed(1) : '-';

            // èº«é«”é™åˆ¶
            const limitations = profile.physicalLimitations || [];
            const limitMap = {
                'knee': 'è†è“‹', 'back': 'è…°èƒŒ', 'shoulder': 'è‚©é ¸',
                'heart': 'å¿ƒè¡€ç®¡', 'joint': 'é—œç¯€', 'pregnancy': 'å­•æœŸ',
                'elderly': 'å¹´é•·', 'obesity': 'é«”é‡'
            };
            const limitText = limitations.length > 0
                ? limitations.map(l => limitMap[l] || l).join('ã€')
                : 'ç„¡';
            document.getElementById('limitationsText').textContent = limitText;

            document.getElementById('userSummary').style.display = 'block';
        }

        // é¡¯ç¤ºå¿«é€Ÿæç¤º
        function displayQuickTips(tips) {
            const tipsList = document.getElementById('tipsList');
            tipsList.innerHTML = tips.map(tip => `<li>${tip}</li>`).join('');
            document.getElementById('quickTips').style.display = 'block';
        }

        // é¡¯ç¤ºé‹å‹•å»ºè­°
        function displayRecommendation(recommendation) {
            showLoading(false);

            // ä½¿ç”¨ marked.js è§£æ Markdownï¼ˆæ­é…å®‰å…¨éæ¿¾ï¼‰
            if (typeof marked !== 'undefined') {
                marked.setOptions({ breaks: true, gfm: true });
                let html = marked.parse(recommendation);
                // ä½¿ç”¨å®‰å…¨å·¥å…·éæ¿¾ XSS
                if (typeof BentoAISecurity !== 'undefined') {
                    html = BentoAISecurity.sanitizeHtml(html);
                }
                document.getElementById('recommendationContent').innerHTML = html;
            } else {
                document.getElementById('recommendationContent').innerHTML =
                    BentoAISecurity ? BentoAISecurity.escapeHtml(recommendation).replace(/\n/g, '<br>') :
                    recommendation.replace(/\n/g, '<br>');
            }

            // é¡¯ç¤ºç”Ÿæˆæ™‚é–“
            const now = new Date();
            document.getElementById('generatedTime').textContent =
                'ç”Ÿæˆæ™‚é–“: ' + now.toLocaleString('zh-TW');

            document.getElementById('recommendationCard').style.display = 'block';

            // é¡¯ç¤ºåé¥‹å€å¡Š
            document.getElementById('feedbackSection').style.display = 'block';

            // é‡ç½®åé¥‹æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('.feedback-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            document.getElementById('feedbackSuccess').style.display = 'none';
        }

        // æäº¤åé¥‹
        async function submitFeedback(feedback) {
            if (!currentHistoryId) {
                console.error('æ²’æœ‰ history_id ç„¡æ³•æäº¤åé¥‹');
                return;
            }

            try {
                const response = await fetch('https://bentoai-api-30594327640.asia-east1.run.app/api/exercise/feedback', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${currentIdToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        history_id: currentHistoryId,
                        feedback: feedback
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
                    document.querySelectorAll('.feedback-btn').forEach(btn => {
                        btn.classList.remove('selected');
                    });
                    document.querySelector(`[data-feedback="${feedback}"]`).classList.add('selected');

                    // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                    document.getElementById('feedbackSuccess').style.display = 'block';
                } else {
                    alert('åé¥‹æäº¤å¤±æ•—: ' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
                }
            } catch (error) {
                console.error('æäº¤åé¥‹å¤±æ•—:', error);
                alert('æäº¤åé¥‹å¤±æ•—: ' + error.message);
            }
        }

        // é‡æ–°ç”Ÿæˆå»ºè­°
        async function refreshRecommendation() {
            if (confirm('ç¢ºå®šè¦é‡æ–°ç”Ÿæˆé‹å‹•å»ºè­°å—ï¼Ÿ\né€™å°‡æ ¹æ“šæ‚¨ç›®å‰çš„è³‡æ–™é‡æ–°è¨ˆç®—ã€‚')) {
                document.getElementById('recommendationCard').style.display = 'none';
                document.getElementById('quickTips').style.display = 'none';
                loadExerciseRecommendation();
            }
        }

        // é¡¯ç¤ºè¼‰å…¥ä¸­
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        // é¡¯ç¤ºç„¡è³‡æ–™æç¤º
        function showNoProfile() {
            showLoading(false);
            document.getElementById('noProfile').style.display = 'block';
        }

        // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
        function showError(message) {
            showLoading(false);
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
        }
    </script>

    <!-- åº•éƒ¨å°èˆªæ¬„ -->
    <nav class="bottom-nav">
        <a href="dashboard.html" class="nav-item">
            <div class="nav-icon">ğŸ </div>
            <span class="nav-label">é¦–é </span>
        </a>
        <a href="diet_records.html" class="nav-item">
            <div class="nav-icon">ğŸ½ï¸</div>
            <span class="nav-label">è¨˜éŒ„</span>
        </a>
        <a href="food-detect.html" class="nav-item">
            <div class="nav-icon">ğŸ“·</div>
            <span class="nav-label">è¾¨è­˜</span>
        </a>
        <a href="statistics.html" class="nav-item">
            <div class="nav-icon">ğŸ“Š</div>
            <span class="nav-label">çµ±è¨ˆ</span>
        </a>
        <a href="chat.html" class="nav-item">
            <div class="nav-icon">ğŸ’¬</div>
            <span class="nav-label">è«®è©¢</span>
        </a>
        <a href="exercise.html" class="nav-item active">
            <div class="nav-icon">ğŸƒ</div>
            <span class="nav-label">é‹å‹•</span>
        </a>
        <a href="settings.html" class="nav-item">
            <div class="nav-icon">âš™ï¸</div>
            <span class="nav-label">è¨­å®š</span>
        </a>
    </nav>
</body>
</html>

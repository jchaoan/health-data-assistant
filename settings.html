<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¸³è™Ÿè¨­å®š - ç‡Ÿé¤Šè¿½è¹¤ç³»çµ±</title>
    <!-- PWA æ”¯æ´ -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="å¥åº·åŠ©ç†">
    <link rel="apple-touch-icon" href="logo.png">
    <!-- PWA å®‰è£æç¤º -->
    <script src="/js/pwa-install.js" defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* é é¢æ¨™é¡Œ */
        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header h1 {
            color: #667eea;
            font-size: 2.5em;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-logo {
            width: 45px;
            height: 45px;
            object-fit: contain;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1em;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        /* ç”¨æˆ¶è³‡è¨Šå¡ç‰‡ */
        .user-card {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }

        .user-avatar-large {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 5px solid #667eea;
            margin-bottom: 20px;
            object-fit: cover;
        }

        /* å¤§é ­è²¼ä¸Šå‚³å€åŸŸ */
        .avatar-upload-container {
            position: relative;
            display: inline-block;
            margin-bottom: 20px;
        }

        .avatar-upload-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s;
            cursor: pointer;
        }

        .avatar-upload-container:hover .avatar-upload-overlay {
            opacity: 1;
        }

        .avatar-upload-overlay span {
            color: white;
            font-size: 0.9em;
            font-weight: bold;
            text-align: center;
        }

        .avatar-upload-input {
            display: none;
        }

        .user-name {
            font-size: 2em;
            color: #333;
            margin-bottom: 10px;
        }

        .user-email {
            font-size: 1.2em;
            color: #666;
            margin-bottom: 20px;
        }

        /* è¨­å®šå€å¡Š */
        .settings-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .settings-section h2 {
            color: #667eea;
            font-size: 1.8em;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .settings-item {
            padding: 20px 0;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .settings-item:last-child {
            border-bottom: none;
        }

        .settings-label {
            flex: 1;
            min-width: 200px;
        }

        .settings-label h3 {
            color: #333;
            font-size: 1.2em;
            margin-bottom: 8px;
        }

        .settings-label p {
            color: #666;
            font-size: 0.95em;
        }

        .settings-value {
            font-size: 1.3em;
            color: #667eea;
            font-weight: bold;
        }

        .settings-action {
            display: flex;
            gap: 10px;
        }

        /* å€‹äººè³‡æ–™ç¶²æ ¼ */
        .profile-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .profile-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .profile-item-label {
            color: #666;
            font-size: 0.95em;
            margin-bottom: 8px;
        }

        .profile-item-value {
            color: #333;
            font-size: 1.5em;
            font-weight: bold;
        }

        .profile-item-unit {
            color: #999;
            font-size: 0.9em;
            margin-left: 5px;
        }

        /* çµ±è¨ˆå¡ç‰‡ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-icon {
            font-size: 2.5em;
            margin-bottom: 15px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 1em;
            color: #666;
        }

        /* ç·¨è¼¯è¡¨å–® */
        .edit-form {
            display: none;
            margin-top: 20px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .edit-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: #333;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        /* è¼‰å…¥ä¸­ */
        .loading {
            text-align: center;
            padding: 60px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        /* ç¢ºèªå°è©±æ¡† */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 15px;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-content h3 {
            color: #333;
            font-size: 1.8em;
            margin-bottom: 15px;
        }

        .modal-content p {
            color: #666;
            font-size: 1.1em;
            margin-bottom: 30px;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                text-align: center;
            }

            .settings-item {
                flex-direction: column;
                align-items: flex-start;
            }

            .settings-action {
                width: 100%;
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }

        /* ===== åº•éƒ¨å°èˆªæ¬„ ===== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 8px 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: #666;
            font-size: 12px;
            padding: 5px 10px;
            border-radius: 10px;
            transition: all 0.3s;
            min-width: 60px;
        }

        .nav-item:hover {
            background: #f0f4ff;
            color: #667eea;
        }

        .nav-item.active {
            color: #667eea;
        }

        .nav-item.active .nav-icon {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .nav-icon {
            font-size: 20px;
            margin-bottom: 3px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            transition: all 0.3s;
        }

        .nav-label {
            font-weight: 500;
        }

        /* ç‚ºåº•éƒ¨å°èˆªç•™å‡ºç©ºé–“ */
        body {
            padding-bottom: 80px;
        }

        /* æ‰‹æ©Ÿç‰ˆåº•éƒ¨å°èˆªå„ªåŒ– */
        @media (max-width: 480px) {
            .nav-item {
                font-size: 10px;
                padding: 5px 5px;
                min-width: 50px;
            }

            .nav-icon {
                font-size: 18px;
                width: 35px;
                height: 35px;
            }

            .bottom-nav {
                padding: 5px 0;
            }
        }

        /* ===== é–‹é—œå…ƒä»¶æ¨£å¼ ===== */
        .toggle-switch {
            position: relative;
            width: 56px;
            height: 28px;
            background: #ccc;
            border-radius: 14px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .toggle-switch.active::after {
            transform: translateX(28px);
        }

        /* é¸æ“‡å™¨æ¨£å¼ */
        .settings-select {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            background: white;
            cursor: pointer;
            min-width: 150px;
        }

        .settings-select:focus {
            outline: none;
            border-color: #667eea;
        }

        /* é€£çµæŒ‰éˆ•æ¨£å¼ */
        .settings-link {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            padding: 10px 20px;
            border: 2px solid #667eea;
            border-radius: 25px;
            transition: all 0.3s;
        }

        .settings-link:hover {
            background: #667eea;
            color: white;
        }

        /* ç‰ˆæœ¬è³‡è¨Šæ¨£å¼ */
        .version-info {
            text-align: center;
            padding: 20px;
            color: #999;
            font-size: 0.9em;
        }

        /* æ„è¦‹å›é¥‹ Modal */
        .feedback-form {
            text-align: left;
        }

        .feedback-form textarea {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            resize: vertical;
            margin-bottom: 15px;
        }

        .feedback-form textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .feedback-type {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .feedback-type-btn {
            padding: 8px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 20px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .feedback-type-btn.active {
            border-color: #667eea;
            background: #f0f4ff;
            color: #667eea;
        }

        /* é—œæ–¼ APP å…§å®¹ */
        .about-content {
            text-align: left;
        }

        .about-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .about-item:last-child {
            border-bottom: none;
        }

        .about-label {
            color: #666;
        }

        .about-value {
            color: #333;
            font-weight: 600;
        }

        .tech-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
        }

        .tech-badge {
            padding: 6px 12px;
            background: #f0f4ff;
            color: #667eea;
            border-radius: 15px;
            font-size: 0.85em;
        }

        /* ===== æ·±è‰²æ¨¡å¼ ===== */
        body.dark-mode {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }

        body.dark-mode .header,
        body.dark-mode .user-card,
        body.dark-mode .settings-section,
        body.dark-mode .stat-card,
        body.dark-mode .modal-content {
            background: #1e1e2e;
            color: #e0e0e0;
        }

        body.dark-mode .header h1,
        body.dark-mode .settings-section h2 {
            color: #a78bfa;
        }

        body.dark-mode .user-name,
        body.dark-mode .settings-label h3,
        body.dark-mode .profile-item-value,
        body.dark-mode .stat-value {
            color: #e0e0e0;
        }

        body.dark-mode .user-email,
        body.dark-mode .settings-label p,
        body.dark-mode .profile-item-label,
        body.dark-mode .stat-label {
            color: #a0a0a0;
        }

        body.dark-mode .profile-item {
            background: #2a2a3e;
            border-left-color: #a78bfa;
        }

        body.dark-mode .settings-item {
            border-bottom-color: #3a3a4e;
        }

        body.dark-mode .edit-form {
            background: #2a2a3e;
        }

        body.dark-mode .form-group input,
        body.dark-mode .form-group select,
        body.dark-mode .settings-select,
        body.dark-mode .feedback-form textarea {
            background: #1e1e2e;
            color: #e0e0e0;
            border-color: #3a3a4e;
        }

        body.dark-mode .form-group input:focus,
        body.dark-mode .form-group select:focus,
        body.dark-mode .settings-select:focus,
        body.dark-mode .feedback-form textarea:focus {
            border-color: #a78bfa;
        }

        body.dark-mode .bottom-nav {
            background: #1e1e2e;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
        }

        body.dark-mode .nav-item {
            color: #a0a0a0;
        }

        body.dark-mode .nav-item:hover {
            background: #2a2a3e;
            color: #a78bfa;
        }

        body.dark-mode .nav-item.active {
            color: #a78bfa;
        }

        body.dark-mode .btn-secondary {
            background: #3a3a4e;
            color: #e0e0e0;
        }

        body.dark-mode .btn-secondary:hover {
            background: #4a4a5e;
        }

        body.dark-mode .settings-link {
            color: #a78bfa;
            border-color: #a78bfa;
        }

        body.dark-mode .settings-link:hover {
            background: #a78bfa;
            color: #1e1e2e;
        }

        body.dark-mode .modal {
            background: rgba(0,0,0,0.7);
        }

        body.dark-mode .about-item {
            border-bottom-color: #3a3a4e;
        }

        body.dark-mode .about-label {
            color: #a0a0a0;
        }

        body.dark-mode .about-value {
            color: #e0e0e0;
        }

        body.dark-mode .tech-badge {
            background: #2a2a3e;
            color: #a78bfa;
        }

        body.dark-mode .feedback-type-btn {
            background: #1e1e2e;
            color: #a0a0a0;
            border-color: #3a3a4e;
        }

        body.dark-mode .feedback-type-btn.active {
            background: #2a2a3e;
            color: #a78bfa;
            border-color: #a78bfa;
        }

        body.dark-mode .version-info {
            color: #666;
        }

        body.dark-mode .loading {
            background: #1e1e2e;
            color: #e0e0e0;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- é é¢æ¨™é¡Œ -->
        <div class="header">
            <h1><img src="logo.png" alt="Logo" class="header-logo">å¸³è™Ÿè¨­å®š</h1>
            <div class="nav-buttons">
                <button class="btn btn-secondary" onclick="window.location.href='dashboard.html'">è¿”å›ä¸»é </button>
                <button class="btn btn-secondary" onclick="window.location.href='diet_records.html'">é£²é£Ÿè¨˜éŒ„</button>
                <button class="btn btn-secondary" onclick="window.location.href='statistics.html'">çµ±è¨ˆåˆ†æ</button>
            </div>
        </div>

        <!-- è¼‰å…¥ä¸­ -->
        <div id="loading" class="loading">
            <p>â³ è¼‰å…¥è¨­å®šä¸­...</p>
        </div>

        <!-- ç”¨æˆ¶è³‡è¨Š -->
        <div id="userCard" class="user-card" style="display: none;">
            <div class="avatar-upload-container">
                <img id="userAvatarLarge" class="user-avatar-large" src="" alt="ç”¨æˆ¶é ­åƒ">
                <div class="avatar-upload-overlay" onclick="document.getElementById('avatarInput').click()">
                    <span>ğŸ“·<br>æ›´æ›é ­åƒ</span>
                </div>
                <input type="file" id="avatarInput" class="avatar-upload-input" accept="image/*" onchange="uploadAvatar(event)">
            </div>
            <div class="user-name" id="displayName"></div>
            <div class="user-email" id="userEmail"></div>
        </div>

        <!-- å€‹äººè³‡æ–™ -->
        <div id="profileSection" class="settings-section" style="display: none;">
            <h2>ğŸ‘¤ å€‹äººè³‡æ–™</h2>

            <div class="profile-grid" id="profileGrid">
                <!-- å‹•æ…‹è¼‰å…¥ -->
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-primary" onclick="toggleEditForm()">âœï¸ ç·¨è¼¯è³‡æ–™</button>
            </div>

            <!-- ç·¨è¼¯è¡¨å–® -->
            <div id="editForm" class="edit-form">
                <h3 style="color: #667eea; margin-bottom: 20px;">ç·¨è¼¯å€‹äººè³‡æ–™</h3>

                <div class="form-row">
                    <div class="form-group">
                        <label>å¹´é½¡</label>
                        <input type="number" id="editAge" min="1" max="150">
                    </div>
                    <div class="form-group">
                        <label>æ€§åˆ¥</label>
                        <select id="editGender">
                            <option value="true">ç”·æ€§</option>
                            <option value="false">å¥³æ€§</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>èº«é«˜ (cm)</label>
                        <input type="number" id="editHeight" min="100" max="250" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>é«”é‡ (kg)</label>
                        <input type="number" id="editWeight" min="30" max="300" step="0.1">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>å¥åº·ç›®æ¨™</label>
                        <select id="editGoal">
                            <option value="0">ç¶­æŒé«”é‡</option>
                            <option value="1">æ¸›é‡</option>
                            <option value="2">å¢é‡</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>æ´»å‹•é‡</label>
                        <select id="editActivityLevel">
                            <option value="sedentary">ä¹…åï¼ˆå¾ˆå°‘é‹å‹•ï¼‰</option>
                            <option value="lightly_active">è¼•åº¦æ´»å‹•ï¼ˆæ¯é€±é‹å‹•1-3å¤©ï¼‰</option>
                            <option value="moderately_active">ä¸­åº¦æ´»å‹•ï¼ˆæ¯é€±é‹å‹•3-5å¤©ï¼‰</option>
                            <option value="very_active">é«˜åº¦æ´»å‹•ï¼ˆæ¯é€±é‹å‹•6-7å¤©ï¼‰</option>
                            <option value="extra_active">æ¥µé«˜æ´»å‹•ï¼ˆæ¯å¤©è¨“ç·´ï¼Œé«”åŠ›å·¥ä½œï¼‰</option>
                        </select>
                    </div>
                </div>

                <div style="display: flex; gap: 15px; margin-top: 30px;">
                    <button class="btn btn-success" onclick="saveProfile()" style="flex: 1;">ğŸ’¾ å„²å­˜</button>
                    <button class="btn btn-secondary" onclick="toggleEditForm()" style="flex: 1;">âŒ å–æ¶ˆ</button>
                </div>
            </div>
        </div>

        <!-- å¸³è™Ÿçµ±è¨ˆ -->
        <div id="statsSection" style="display: none;">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">ğŸ“</div>
                    <div class="stat-value" id="totalRecords">0</div>
                    <div class="stat-label">ç¸½è¨˜éŒ„æ•¸</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">ğŸ“…</div>
                    <div class="stat-value" id="daysWithRecords">0</div>
                    <div class="stat-label">æœ‰è¨˜éŒ„çš„å¤©æ•¸</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">ğŸ”¥</div>
                    <div class="stat-value" id="totalCalories">0</div>
                    <div class="stat-label">ç¸½ç†±é‡ (å¤§å¡)</div>
                </div>
            </div>
        </div>

        <!-- è³‡æ–™ç®¡ç† -->
        <div id="dataManagement" class="settings-section" style="display: none;">
            <h2>ğŸ—‚ï¸ è³‡æ–™ç®¡ç†</h2>

            <div class="settings-item">
                <div class="settings-label">
                    <h3>åŒ¯å‡ºè³‡æ–™</h3>
                    <p>ä¸‹è¼‰æ‚¨çš„æ‰€æœ‰é£²é£Ÿè¨˜éŒ„ç‚º JSON æ ¼å¼</p>
                </div>
                <div class="settings-action">
                    <button class="btn btn-primary" onclick="exportData()">åŒ¯å‡º</button>
                </div>
            </div>

            <div class="settings-item">
                <div class="settings-label">
                    <h3>æ¸…ç©ºæ‰€æœ‰è¨˜éŒ„</h3>
                    <p>âš ï¸ è­¦å‘Šï¼šæ­¤æ“ä½œå°‡æ°¸ä¹…åˆªé™¤æ‰€æœ‰é£²é£Ÿè¨˜éŒ„ï¼Œç„¡æ³•å¾©åŸ</p>
                </div>
                <div class="settings-action">
                    <button class="btn btn-danger" onclick="showClearAllModal()">æ¸…ç©ºè¨˜éŒ„</button>
                </div>
            </div>
        </div>

        <!-- å¸³è™Ÿç®¡ç† -->
        <div id="accountManagement" class="settings-section" style="display: none;">
            <h2>ğŸ‘¤ å¸³è™Ÿç®¡ç†</h2>

            <div class="settings-item">
                <div class="settings-label">
                    <h3>ç™»å‡º</h3>
                    <p>ç™»å‡ºæ‚¨çš„å¸³è™Ÿ</p>
                </div>
                <div class="settings-action">
                    <button class="btn btn-secondary" onclick="logout()">ç™»å‡º</button>
                </div>
            </div>
        </div>

        <!-- æ‡‰ç”¨ç¨‹å¼è¨­å®š -->
        <div id="appSettings" class="settings-section" style="display: none;">
            <h2>âš™ï¸ æ‡‰ç”¨ç¨‹å¼è¨­å®š</h2>

            <div class="settings-item">
                <div class="settings-label">
                    <h3>ç”¨é¤æé†’</h3>
                    <p>åœ¨ç”¨é¤æ™‚é–“æé†’æ‚¨è¨˜éŒ„é£²é£Ÿ</p>
                </div>
                <div class="settings-action">
                    <div class="toggle-switch" id="mealReminderToggle" onclick="toggleMealReminder()"></div>
                </div>
            </div>

            <div class="settings-item">
                <div class="settings-label">
                    <h3>ç›®æ¨™é”æˆé€šçŸ¥</h3>
                    <p>ç•¶æ‚¨é”æˆæ¯æ—¥ç‡Ÿé¤Šç›®æ¨™æ™‚é€šçŸ¥æ‚¨</p>
                </div>
                <div class="settings-action">
                    <div class="toggle-switch" id="goalNotificationToggle" onclick="toggleGoalNotification()"></div>
                </div>
            </div>

            <div class="settings-item">
                <div class="settings-label">
                    <h3>æ·±è‰²æ¨¡å¼</h3>
                    <p>åˆ‡æ›æ·±è‰²ä¸»é¡Œä»¥ä¿è­·çœ¼ç›</p>
                </div>
                <div class="settings-action">
                    <div class="toggle-switch" id="darkModeToggle" onclick="toggleDarkMode()"></div>
                </div>
            </div>

            <div class="settings-item">
                <div class="settings-label">
                    <h3>å–®ä½è¨­å®š</h3>
                    <p>é¸æ“‡èº«é«˜é«”é‡çš„é¡¯ç¤ºå–®ä½</p>
                </div>
                <div class="settings-action">
                    <select class="settings-select" id="unitSelect" onchange="changeUnit()">
                        <option value="metric">å…¬åˆ¶ (cm/kg)</option>
                        <option value="imperial">è‹±åˆ¶ (ft/lb)</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- é—œæ–¼èˆ‡å¹«åŠ© -->
        <div id="aboutSection" class="settings-section" style="display: none;">
            <h2>â“ é—œæ–¼èˆ‡å¹«åŠ©</h2>

            <div class="settings-item">
                <div class="settings-label">
                    <h3>æ“ä½œèªªæ˜</h3>
                    <p>äº†è§£å¦‚ä½•ä½¿ç”¨æœ¬ç³»çµ±çš„å„é …åŠŸèƒ½</p>
                </div>
                <div class="settings-action">
                    <a href="welcome.html" class="settings-link">ğŸ“– æŸ¥çœ‹èªªæ˜</a>
                </div>
            </div>

            <div class="settings-item">
                <div class="settings-label">
                    <h3>é—œæ–¼ APP</h3>
                    <p>æŸ¥çœ‹ç‰ˆæœ¬è³‡è¨Šèˆ‡æŠ€è¡“èªªæ˜</p>
                </div>
                <div class="settings-action">
                    <button class="btn btn-primary" onclick="showAboutModal()">æŸ¥çœ‹</button>
                </div>
            </div>

            <div class="settings-item">
                <div class="settings-label">
                    <h3>æ„è¦‹å›é¥‹</h3>
                    <p>æäº¤æ‚¨çš„å»ºè­°æˆ–å›å ±å•é¡Œ</p>
                </div>
                <div class="settings-action">
                    <button class="btn btn-primary" onclick="showFeedbackModal()">ğŸ“ æäº¤å›é¥‹</button>
                </div>
            </div>
        </div>

        <!-- ç‰ˆæœ¬è³‡è¨Š -->
        <div class="version-info" id="versionInfo" style="display: none;">
            å¥åº·æ•¸æ“šåŠ©ç† v1.0.0 | Made with â¤ï¸
        </div>
    </div>

    <!-- åº•éƒ¨å°èˆªæ¬„ -->
    <nav class="bottom-nav">
        <a href="dashboard.html" class="nav-item">
            <div class="nav-icon">ğŸ </div>
            <span class="nav-label">é¦–é </span>
        </a>
        <a href="diet_records.html" class="nav-item">
            <div class="nav-icon">ğŸ½ï¸</div>
            <span class="nav-label">è¨˜éŒ„</span>
        </a>
        <a href="food-detect.html" class="nav-item">
            <div class="nav-icon">ğŸ“·</div>
            <span class="nav-label">è¾¨è­˜</span>
        </a>
        <a href="statistics.html" class="nav-item">
            <div class="nav-icon">ğŸ“Š</div>
            <span class="nav-label">çµ±è¨ˆ</span>
        </a>
        <a href="chat.html" class="nav-item">
            <div class="nav-icon">ğŸ’¬</div>
            <span class="nav-label">è«®è©¢</span>
        </a>
        <a href="exercise.html" class="nav-item">
            <div class="nav-icon">ğŸƒ</div>
            <span class="nav-label">é‹å‹•</span>
        </a>
        <a href="settings.html" class="nav-item active">
            <div class="nav-icon">âš™ï¸</div>
            <span class="nav-label">è¨­å®š</span>
        </a>
    </nav>

    <!-- ç¢ºèªå°è©±æ¡† -->
    <div id="clearAllModal" class="modal">
        <div class="modal-content">
            <h3>âš ï¸ ç¢ºèªæ¸…ç©ºæ‰€æœ‰è¨˜éŒ„</h3>
            <p>æ­¤æ“ä½œå°‡æ°¸ä¹…åˆªé™¤æ‚¨çš„æ‰€æœ‰é£²é£Ÿè¨˜éŒ„ï¼ŒåŒ…æ‹¬ï¼š</p>
            <ul style="text-align: left; margin: 20px 0; padding-left: 40px;">
                <li>æ‰€æœ‰è¾¨è­˜è¨˜éŒ„</li>
                <li>ç‡Ÿé¤Šåˆ†æè³‡æ–™</li>
                <li>æ­·å²çµ±è¨ˆè³‡è¨Š</li>
            </ul>
            <p style="color: #dc3545; font-weight: bold;">æ­¤æ“ä½œç„¡æ³•å¾©åŸï¼Œç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ</p>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="hideClearAllModal()">å–æ¶ˆ</button>
                <button class="btn btn-danger" onclick="clearAllRecords()">ç¢ºå®šåˆªé™¤</button>
            </div>
        </div>
    </div>

    <!-- é—œæ–¼ APP Modal -->
    <div id="aboutModal" class="modal">
        <div class="modal-content" style="max-width: 450px;">
            <h3 style="margin-bottom: 25px;">ğŸ“± é—œæ–¼å¥åº·æ•¸æ“šåŠ©ç†</h3>
            <div class="about-content">
                <div class="about-item">
                    <span class="about-label">æ‡‰ç”¨ç¨‹å¼åç¨±</span>
                    <span class="about-value">å¥åº·æ•¸æ“šåŠ©ç†</span>
                </div>
                <div class="about-item">
                    <span class="about-label">ç‰ˆæœ¬</span>
                    <span class="about-value">1.0.0</span>
                </div>
                <div class="about-item">
                    <span class="about-label">æ›´æ–°æ—¥æœŸ</span>
                    <span class="about-value">2024-11-28</span>
                </div>
                <div class="about-item">
                    <span class="about-label">é–‹ç™¼è€…</span>
                    <span class="about-value">å¥åº·æ•¸æ“šåŠ©ç†åœ˜éšŠ</span>
                </div>
                <div style="margin-top: 20px;">
                    <p style="color: #666; font-size: 0.95em; margin-bottom: 10px;">ä½¿ç”¨æŠ€è¡“</p>
                    <div class="tech-badges">
                        <span class="tech-badge">YOLOv8</span>
                        <span class="tech-badge">Google Gemini</span>
                        <span class="tech-badge">Firebase</span>
                        <span class="tech-badge">RAG</span>
                        <span class="tech-badge">PWA</span>
                    </div>
                </div>
            </div>
            <div class="modal-buttons" style="margin-top: 25px;">
                <button class="btn btn-primary" onclick="hideAboutModal()">é—œé–‰</button>
            </div>
        </div>
    </div>

    <!-- æ„è¦‹å›é¥‹ Modal -->
    <div id="feedbackModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <h3 style="margin-bottom: 20px;">ğŸ“ æ„è¦‹å›é¥‹</h3>
            <div class="feedback-form">
                <p style="color: #666; margin-bottom: 15px;">è«‹é¸æ“‡å›é¥‹é¡å‹ï¼š</p>
                <div class="feedback-type">
                    <button class="feedback-type-btn active" onclick="selectFeedbackType(this, 'suggestion')">ğŸ’¡ å»ºè­°</button>
                    <button class="feedback-type-btn" onclick="selectFeedbackType(this, 'bug')">ğŸ› å•é¡Œå›å ±</button>
                    <button class="feedback-type-btn" onclick="selectFeedbackType(this, 'other')">ğŸ’¬ å…¶ä»–</button>
                </div>
                <textarea id="feedbackContent" placeholder="è«‹æè¿°æ‚¨çš„å»ºè­°æˆ–é‡åˆ°çš„å•é¡Œ..."></textarea>
                <p style="color: #999; font-size: 0.85em; margin-bottom: 15px;">
                    æ‚¨çš„å›é¥‹å°‡å¹«åŠ©æˆ‘å€‘æ”¹é€²æœå‹™ï¼Œæ„Ÿè¬æ‚¨çš„å¯¶è²´æ„è¦‹ï¼
                </p>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="hideFeedbackModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="submitFeedback()">æäº¤å›é¥‹</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

    <script>
        // Firebase é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyCk4GY-VkG4dd_zXP5HZQDlZbjdY0k0img",
            authDomain: "fooddata-92fa8.firebaseapp.com",
            projectId: "fooddata-92fa8",
            storageBucket: "fooddata-92fa8.firebasestorage.app",
            messagingSenderId: "459965557703",
            appId: "1:459965557703:web:6a16b3937935219eb887e2",
            measurementId: "G-R16CYV7QC2"
        };

        // åˆå§‹åŒ– Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        let currentUser = null;
        let hasCheckedAuth = false;
        let profileData = null;

        // ç›£è½ç™»å…¥ç‹€æ…‹
        auth.onAuthStateChanged(async (user) => {
            if (hasCheckedAuth) return;
            hasCheckedAuth = true;

            if (user) {
                console.log('[è¨­å®š] ç”¨æˆ¶å·²ç™»å…¥:', user.email);
                currentUser = user;

                // é¡¯ç¤ºç”¨æˆ¶è³‡è¨Š
                document.getElementById('displayName').textContent = user.displayName || 'ä½¿ç”¨è€…';
                document.getElementById('userEmail').textContent = user.email;

                if (user.photoURL) {
                    document.getElementById('userAvatarLarge').src = user.photoURL;
                } else {
                    document.getElementById('userAvatarLarge').src = 'https://via.placeholder.com/120';
                }

                // è¼‰å…¥å€‹äººè³‡æ–™
                await loadProfile();

                // è¼‰å…¥çµ±è¨ˆè³‡æ–™
                await loadStatistics();

                document.getElementById('loading').style.display = 'none';
                document.getElementById('userCard').style.display = 'block';
                document.getElementById('profileSection').style.display = 'block';
                document.getElementById('statsSection').style.display = 'block';
                document.getElementById('dataManagement').style.display = 'block';
                document.getElementById('accountManagement').style.display = 'block';
                document.getElementById('appSettings').style.display = 'block';
                document.getElementById('aboutSection').style.display = 'block';
                document.getElementById('versionInfo').style.display = 'block';

                // è¼‰å…¥è¨­å®šç‹€æ…‹
                loadAppSettings();
            } else {
                console.log('[è¨­å®š] æœªç™»å…¥ï¼Œå°å‘ç™»å…¥é ');
                alert('è«‹å…ˆç™»å…¥');
                window.location.href = 'login.html';
            }
        });

        // è¼‰å…¥å€‹äººè³‡æ–™
        async function loadProfile() {
            try {
                const doc = await db.collection('member').doc(currentUser.uid).get();

                if (doc.exists) {
                    profileData = doc.data();
                    console.log('[è¨­å®š] å€‹äººè³‡æ–™:', profileData);
                    displayProfile(profileData);
                } else {
                    console.log('[è¨­å®š] å°šæœªè¨­å®šå€‹äººè³‡æ–™');
                    document.getElementById('profileGrid').innerHTML = `
                        <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #666;">
                            <p style="font-size: 1.2em; margin-bottom: 15px;">å°šæœªè¨­å®šå€‹äººè³‡æ–™</p>
                            <p>è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•é–‹å§‹è¨­å®š</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('[è¨­å®š] è¼‰å…¥å€‹äººè³‡æ–™å¤±æ•—:', error);
            }
        }

        // é¡¯ç¤ºå€‹äººè³‡æ–™
        function displayProfile(data) {
            const genderMap = { true: 'ç”·æ€§', false: 'å¥³æ€§' };
            const goalMap = { 0: 'ç¶­æŒé«”é‡', 1: 'æ¸›é‡', 2: 'å¢é‡' };
            const activityMap = {
                'sedentary': 'ä¹…å',
                'lightly_active': 'è¼•åº¦æ´»å‹•',
                'moderately_active': 'ä¸­åº¦æ´»å‹•',
                'very_active': 'é«˜åº¦æ´»å‹•',
                'extra_active': 'æ¥µé«˜æ´»å‹•'
            };

            const bmi = data.weight && data.height ? (data.weight / Math.pow(data.height / 100, 2)).toFixed(1) : '-';

            // æ ¹æ“šå–®ä½è¨­å®šè½‰æ›æ•¸å€¼
            const isImperial = appSettings.unit === 'imperial';
            const heightDisplay = data.height ? (isImperial ? convertUnit(data.height, 'height', true) : data.height) : '-';
            const weightDisplay = data.weight ? (isImperial ? convertUnit(data.weight, 'weight', true) : data.weight) : '-';
            const heightUnit = isImperial ? '' : 'cm';
            const weightUnit = isImperial ? 'lb' : 'kg';

            const profileHTML = `
                <div class="profile-item">
                    <div class="profile-item-label">å¹´é½¡</div>
                    <div class="profile-item-value">${data.age || '-'}<span class="profile-item-unit">æ­²</span></div>
                </div>
                <div class="profile-item">
                    <div class="profile-item-label">æ€§åˆ¥</div>
                    <div class="profile-item-value">${genderMap[data.gender] || '-'}</div>
                </div>
                <div class="profile-item">
                    <div class="profile-item-label">èº«é«˜</div>
                    <div class="profile-item-value">${heightDisplay}<span class="profile-item-unit">${heightUnit}</span></div>
                </div>
                <div class="profile-item">
                    <div class="profile-item-label">é«”é‡</div>
                    <div class="profile-item-value">${weightDisplay}<span class="profile-item-unit">${weightUnit}</span></div>
                </div>
                <div class="profile-item">
                    <div class="profile-item-label">BMI</div>
                    <div class="profile-item-value">${bmi}</div>
                </div>
                <div class="profile-item">
                    <div class="profile-item-label">å¥åº·ç›®æ¨™</div>
                    <div class="profile-item-value">${goalMap[data.goal] || '-'}</div>
                </div>
                <div class="profile-item">
                    <div class="profile-item-label">æ´»å‹•é‡</div>
                    <div class="profile-item-value">${activityMap[data.activityLevel] || '-'}</div>
                </div>
                <div class="profile-item">
                    <div class="profile-item-label">åŸºç¤ä»£è¬ç‡ (BMR)</div>
                    <div class="profile-item-value">${data.BMR || '-'}<span class="profile-item-unit">kcal</span></div>
                </div>
                <div class="profile-item">
                    <div class="profile-item-label">æ¯æ—¥ç¸½æ¶ˆè€— (TDEE)</div>
                    <div class="profile-item-value">${data.TDEE_level || '-'}<span class="profile-item-unit">kcal</span></div>
                </div>
                <div class="profile-item">
                    <div class="profile-item-label">å»ºè­°ç†±é‡</div>
                    <div class="profile-item-value">${data.suggested_calories || '-'}<span class="profile-item-unit">kcal</span></div>
                </div>
                <div class="profile-item">
                    <div class="profile-item-label">ç›®æ¨™è›‹ç™½è³ª</div>
                    <div class="profile-item-value">${data.targetProtein || '-'}<span class="profile-item-unit">g</span></div>
                </div>
                <div class="profile-item">
                    <div class="profile-item-label">ç›®æ¨™ç¢³æ°´åŒ–åˆç‰©</div>
                    <div class="profile-item-value">${data.targetCarbs || '-'}<span class="profile-item-unit">g</span></div>
                </div>
                <div class="profile-item">
                    <div class="profile-item-label">ç›®æ¨™è„‚è‚ª</div>
                    <div class="profile-item-value">${data.targetFat || '-'}<span class="profile-item-unit">g</span></div>
                </div>
            `;

            document.getElementById('profileGrid').innerHTML = profileHTML;

            // å¡«å……ç·¨è¼¯è¡¨å–®
            if (data.age) document.getElementById('editAge').value = data.age;
            if (data.gender !== undefined) document.getElementById('editGender').value = data.gender;
            if (data.height) document.getElementById('editHeight').value = data.height;
            if (data.weight) document.getElementById('editWeight').value = data.weight;
            if (data.goal !== undefined) document.getElementById('editGoal').value = data.goal;
            if (data.activityLevel) document.getElementById('editActivityLevel').value = data.activityLevel;
        }

        // åˆ‡æ›ç·¨è¼¯è¡¨å–®
        function toggleEditForm() {
            const form = document.getElementById('editForm');
            form.classList.toggle('active');
        }

        // è¨ˆç®— BMR
        function calculateBMR(age, height, weight, isMale) {
            if (isMale) {
                return 88.362 + (13.397 * weight) + (4.799 * height) - (5.677 * age);
            } else {
                return 447.593 + (9.247 * weight) + (3.098 * height) - (4.330 * age);
            }
        }

        // è¨ˆç®— TDEE
        function calculateTDEE(bmr, activityLevel) {
            const multipliers = {
                'sedentary': 1.2,
                'lightly_active': 1.375,
                'moderately_active': 1.55,
                'very_active': 1.725,
                'extra_active': 1.9
            };
            return bmr * (multipliers[activityLevel] || 1.55);
        }

        // è¨ˆç®—å»ºè­°ç†±é‡
        function calculateSuggestedCalories(tdee, goal) {
            let suggested;
            switch (parseInt(goal)) {
                case 1: // æ¸›é‡
                    suggested = tdee - 500;
                    break;
                case 2: // å¢é‡
                    suggested = tdee + 500;
                    break;
                default: // ç¶­æŒ
                    suggested = tdee;
            }
            return Math.max(suggested, 1200); // æœ€ä½ 1200 kcal
        }

        // å„²å­˜å€‹äººè³‡æ–™
        async function saveProfile() {
            try {
                const age = parseInt(document.getElementById('editAge').value);
                const gender = document.getElementById('editGender').value === 'true';
                const height = parseFloat(document.getElementById('editHeight').value);
                const weight = parseFloat(document.getElementById('editWeight').value);
                const goal = parseInt(document.getElementById('editGoal').value);
                const activityLevel = document.getElementById('editActivityLevel').value;

                if (!age || !height || !weight) {
                    alert('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½');
                    return;
                }

                // è¨ˆç®—ç‡Ÿé¤Šæ•¸æ“š
                const bmr = Math.round(calculateBMR(age, height, weight, gender));
                const tdee = Math.round(calculateTDEE(bmr, activityLevel));
                const suggestedCalories = Math.round(calculateSuggestedCalories(tdee, goal));

                // è¨ˆç®—ç‡Ÿé¤Šç›®æ¨™
                const targetProtein = Math.round((suggestedCalories * 0.3) / 4);
                const targetCarbs = Math.round((suggestedCalories * 0.45) / 4);
                const targetFat = Math.round((suggestedCalories * 0.25) / 9);

                // æ›´æ–° Firestore
                await db.collection('member').doc(currentUser.uid).set({
                    age: age,
                    gender: gender,
                    height: height,
                    weight: weight,
                    goal: goal,
                    activityLevel: activityLevel,
                    BMR: bmr,
                    TDEE_level: tdee,
                    suggested_calories: suggestedCalories,
                    targetCalories: suggestedCalories,
                    targetProtein: targetProtein,
                    targetCarbs: targetCarbs,
                    targetFat: targetFat,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });

                alert('å€‹äººè³‡æ–™æ›´æ–°æˆåŠŸï¼');
                toggleEditForm();
                await loadProfile();

            } catch (error) {
                console.error('[è¨­å®š] å„²å­˜å¤±æ•—:', error);
                alert('å„²å­˜å¤±æ•—: ' + error.message);
            }
        }

        // è¼‰å…¥çµ±è¨ˆè³‡æ–™
        async function loadStatistics() {
            try {
                const idToken = await currentUser.getIdToken();

                const response = await fetch('https://bentoai-api-30594327640.asia-east1.run.app/api/statistics?days=365', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${idToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();

                if (data.success) {
                    document.getElementById('totalRecords').textContent = data.summary.total_records;
                    document.getElementById('daysWithRecords').textContent = data.summary.days_with_records;
                    document.getElementById('totalCalories').textContent = Math.round(data.summary.total_calories).toLocaleString();
                }
            } catch (error) {
                console.error('[è¨­å®š] è¼‰å…¥çµ±è¨ˆå¤±æ•—:', error);
            }
        }

        // åŒ¯å‡ºè³‡æ–™
        async function exportData() {
            try {
                const idToken = await currentUser.getIdToken();

                const response = await fetch('https://bentoai-api-30594327640.asia-east1.run.app/api/diet-records?limit=10000', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${idToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();

                if (data.success && data.data) {
                    const jsonStr = JSON.stringify(data.data, null, 2);
                    const blob = new Blob([jsonStr], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);

                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `nutrition_records_${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                    alert(`æˆåŠŸåŒ¯å‡º ${data.data.length} ç­†è¨˜éŒ„ï¼`);
                } else {
                    alert('æ²’æœ‰è³‡æ–™å¯åŒ¯å‡º');
                }
            } catch (error) {
                console.error('[è¨­å®š] åŒ¯å‡ºå¤±æ•—:', error);
                alert('åŒ¯å‡ºå¤±æ•—: ' + error.message);
            }
        }

        // é¡¯ç¤ºæ¸…ç©ºç¢ºèªå°è©±æ¡†
        function showClearAllModal() {
            document.getElementById('clearAllModal').classList.add('active');
        }

        // éš±è—æ¸…ç©ºç¢ºèªå°è©±æ¡†
        function hideClearAllModal() {
            document.getElementById('clearAllModal').classList.remove('active');
        }

        // æ¸…ç©ºæ‰€æœ‰è¨˜éŒ„
        async function clearAllRecords() {
            try {
                const idToken = await currentUser.getIdToken();

                const response = await fetch('https://bentoai-api-30594327640.asia-east1.run.app/api/diet-records/clear-all', {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${idToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();

                if (data.success) {
                    alert(`æˆåŠŸåˆªé™¤ ${data.deleted_count} ç­†è¨˜éŒ„ï¼`);
                    hideClearAllModal();
                    await loadStatistics();
                } else {
                    alert('åˆªé™¤å¤±æ•—: ' + (data.error || 'Unknown'));
                }
            } catch (error) {
                console.error('[è¨­å®š] æ¸…ç©ºå¤±æ•—:', error);
                alert('æ¸…ç©ºå¤±æ•—: ' + error.message);
            }
        }

        // ç™»å‡º
        async function logout() {
            try {
                await auth.signOut();
                window.location.href = 'login.html';
            } catch (error) {
                console.error('[è¨­å®š] ç™»å‡ºå¤±æ•—:', error);
                alert('ç™»å‡ºå¤±æ•—: ' + error.message);
            }
        }

        // ä¸Šå‚³å¤§é ­è²¼
        async function uploadAvatar(event) {
            const file = event.target.files[0];
            if (!file) return;

            // é©—è­‰æª”æ¡ˆé¡å‹
            if (!file.type.startsWith('image/')) {
                alert('è«‹é¸æ“‡åœ–ç‰‡æª”æ¡ˆï¼');
                return;
            }

            // é©—è­‰æª”æ¡ˆå¤§å° (é™åˆ¶ 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('åœ–ç‰‡å¤§å°ä¸å¯è¶…é 5MBï¼');
                return;
            }

            try {
                // é¡¯ç¤ºä¸Šå‚³ä¸­çš„æç¤º
                const overlay = document.querySelector('.avatar-upload-overlay span');
                const originalText = overlay.innerHTML;
                overlay.innerHTML = 'â³<br>ä¸Šå‚³ä¸­...';

                // âœ… ä½¿ç”¨èˆ‡ Flutter ä¸€è‡´çš„è·¯å¾‘ï¼šuser-profiles/{uid}/profile-photo.jpg
                const storageRef = storage.ref();
                const avatarRef = storageRef.child(`user-profiles/${currentUser.uid}/profile-photo.jpg`);

                // è¨­å®š metadata
                const metadata = {
                    contentType: file.type,
                    customMetadata: {
                        uploadedBy: currentUser.uid,
                        uploadedAt: new Date().toISOString(),
                        uploadSource: 'web'
                    }
                };

                // ä¸Šå‚³æª”æ¡ˆ
                const snapshot = await avatarRef.put(file, metadata);
                console.log('[é ­åƒ] ä¸Šå‚³æˆåŠŸ:', snapshot);

                // å–å¾—ä¸‹è¼‰ URL
                const downloadURL = await snapshot.ref.getDownloadURL();
                console.log('[é ­åƒ] ä¸‹è¼‰ URL:', downloadURL);

                // âœ… æ›´æ–° Firestore member è³‡æ–™ï¼ˆèˆ‡ Flutter ä¸€è‡´ï¼‰
                await db.collection('member').doc(currentUser.uid).set({
                    profilePhotoUrl: downloadURL,
                    hasProfilePhoto: true,
                    photoURL: downloadURL,  // åŒæ™‚æ›´æ–°é€™å€‹æ¬„ä½ä»¥ä¾¿å‘å¾Œç›¸å®¹
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });

                // âœ… åŒæ™‚æ›´æ–° Firebase Auth å€‹äººè³‡æ–™
                await currentUser.updateProfile({
                    photoURL: downloadURL
                });

                // æ›´æ–°é é¢é¡¯ç¤º
                document.getElementById('userAvatarLarge').src = downloadURL;

                // æ¢å¾©åŸå§‹æ–‡å­—
                overlay.innerHTML = originalText;

                alert('å¤§é ­è²¼æ›´æ–°æˆåŠŸï¼');

                // é‡æ–°è¼‰å…¥ç”¨æˆ¶è³‡è¨Šä»¥ç¢ºä¿åŒæ­¥
                await currentUser.reload();

            } catch (error) {
                console.error('[é ­åƒ] ä¸Šå‚³å¤±æ•—:', error);
                alert('ä¸Šå‚³å¤±æ•—: ' + error.message);

                // æ¢å¾©åŸå§‹æ–‡å­—
                const overlay = document.querySelector('.avatar-upload-overlay span');
                overlay.innerHTML = 'ğŸ“·<br>æ›´æ›é ­åƒ';
            }
        }

        // ===== æ‡‰ç”¨ç¨‹å¼è¨­å®šåŠŸèƒ½ =====

        // è¨­å®šå­˜å„²éµ
        const SETTINGS_KEY = 'bentoai_settings';
        let appSettings = {
            mealReminder: false,
            goalNotification: false,
            darkMode: false,
            unit: 'metric'
        };
        let feedbackType = 'suggestion';

        // è¼‰å…¥æ‡‰ç”¨ç¨‹å¼è¨­å®š
        function loadAppSettings() {
            const saved = localStorage.getItem(SETTINGS_KEY);
            if (saved) {
                appSettings = JSON.parse(saved);
            }

            // æ›´æ–° UI
            updateToggle('mealReminderToggle', appSettings.mealReminder);
            updateToggle('goalNotificationToggle', appSettings.goalNotification);
            updateToggle('darkModeToggle', appSettings.darkMode);
            document.getElementById('unitSelect').value = appSettings.unit;

            // å¥—ç”¨æ·±è‰²æ¨¡å¼
            if (appSettings.darkMode) {
                document.body.classList.add('dark-mode');
            }

            // å¦‚æœç”¨é¤æé†’å·²é–‹å•Ÿï¼Œå•Ÿå‹•æé†’æª¢æŸ¥
            if (appSettings.mealReminder) {
                startMealReminder();
            }
        }

        // æ›´æ–°é–‹é—œç‹€æ…‹
        function updateToggle(id, isActive) {
            const toggle = document.getElementById(id);
            if (toggle) {
                if (isActive) {
                    toggle.classList.add('active');
                } else {
                    toggle.classList.remove('active');
                }
            }
        }

        // å„²å­˜è¨­å®š
        function saveAppSettings() {
            localStorage.setItem(SETTINGS_KEY, JSON.stringify(appSettings));
        }

        // ç”¨é¤æé†’æ™‚é–“è¨­å®š (24å°æ™‚åˆ¶)
        const MEAL_TIMES = {
            breakfast: { hour: 8, minute: 0, name: 'æ—©é¤' },
            lunch: { hour: 12, minute: 0, name: 'åˆé¤' },
            dinner: { hour: 18, minute: 30, name: 'æ™šé¤' }
        };

        let mealReminderInterval = null;

        // åˆ‡æ›ç”¨é¤æé†’
        async function toggleMealReminder() {
            appSettings.mealReminder = !appSettings.mealReminder;
            updateToggle('mealReminderToggle', appSettings.mealReminder);
            saveAppSettings();

            if (appSettings.mealReminder) {
                const permission = await requestNotificationPermission();
                if (permission === 'granted') {
                    startMealReminder();
                    showToast('ç”¨é¤æé†’å·²é–‹å•Ÿï¼å°‡åœ¨ 8:00ã€12:00ã€18:30 æé†’æ‚¨');
                } else {
                    appSettings.mealReminder = false;
                    updateToggle('mealReminderToggle', false);
                    saveAppSettings();
                    showToast('è«‹å…è¨±é€šçŸ¥æ¬Šé™ä»¥é–‹å•Ÿæé†’');
                }
            } else {
                stopMealReminder();
                showToast('ç”¨é¤æé†’å·²é—œé–‰');
            }
        }

        // é–‹å§‹ç”¨é¤æé†’
        function startMealReminder() {
            // æ¯åˆ†é˜æª¢æŸ¥ä¸€æ¬¡æ˜¯å¦åˆ°ç”¨é¤æ™‚é–“
            mealReminderInterval = setInterval(checkMealTime, 60000);
            // ç«‹å³æª¢æŸ¥ä¸€æ¬¡
            checkMealTime();
            console.log('ç”¨é¤æé†’å·²å•Ÿå‹•');
        }

        // åœæ­¢ç”¨é¤æé†’
        function stopMealReminder() {
            if (mealReminderInterval) {
                clearInterval(mealReminderInterval);
                mealReminderInterval = null;
            }
            console.log('ç”¨é¤æé†’å·²åœæ­¢');
        }

        // æª¢æŸ¥æ˜¯å¦åˆ°ç”¨é¤æ™‚é–“
        function checkMealTime() {
            const now = new Date();
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();

            for (const [meal, time] of Object.entries(MEAL_TIMES)) {
                if (currentHour === time.hour && currentMinute === time.minute) {
                    // æª¢æŸ¥ä»Šå¤©æ˜¯å¦å·²ç¶“æé†’éé€™é¤
                    const lastReminder = localStorage.getItem(`lastReminder_${meal}`);
                    const today = now.toDateString();

                    if (lastReminder !== today) {
                        sendMealNotification(time.name);
                        localStorage.setItem(`lastReminder_${meal}`, today);
                    }
                }
            }
        }

        // ç™¼é€ç”¨é¤é€šçŸ¥
        function sendMealNotification(mealName) {
            if ('Notification' in window && Notification.permission === 'granted') {
                const notification = new Notification('å¥åº·æ•¸æ“šåŠ©ç† ç”¨é¤æé†’', {
                    body: `ç¾åœ¨æ˜¯${mealName}æ™‚é–“ï¼åˆ¥å¿˜äº†è¨˜éŒ„æ‚¨çš„é£²é£Ÿ ğŸ“¸`,
                    icon: 'logo.png',
                    badge: 'logo.png',
                    tag: 'meal-reminder',
                    requireInteraction: true
                });

                notification.onclick = () => {
                    window.focus();
                    window.location.href = 'food-detect.html';
                    notification.close();
                };
            }
        }

        // åˆ‡æ›ç›®æ¨™é”æˆé€šçŸ¥
        async function toggleGoalNotification() {
            appSettings.goalNotification = !appSettings.goalNotification;
            updateToggle('goalNotificationToggle', appSettings.goalNotification);
            saveAppSettings();

            if (appSettings.goalNotification) {
                const permission = await requestNotificationPermission();
                if (permission === 'granted') {
                    showToast('ç›®æ¨™é”æˆé€šçŸ¥å·²é–‹å•Ÿï¼');
                } else {
                    appSettings.goalNotification = false;
                    updateToggle('goalNotificationToggle', false);
                    saveAppSettings();
                    showToast('è«‹å…è¨±é€šçŸ¥æ¬Šé™ä»¥é–‹å•Ÿé€šçŸ¥');
                }
            } else {
                showToast('ç›®æ¨™é”æˆé€šçŸ¥å·²é—œé–‰');
            }
        }

        // é¡¯ç¤º Toast è¨Šæ¯
        function showToast(message) {
            // ç§»é™¤èˆŠçš„ toast
            const oldToast = document.querySelector('.toast-message');
            if (oldToast) oldToast.remove();

            const toast = document.createElement('div');
            toast.className = 'toast-message';
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                bottom: 100px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0,0,0,0.8);
                color: white;
                padding: 12px 24px;
                border-radius: 25px;
                font-size: 14px;
                z-index: 9999;
                animation: fadeInOut 3s ease;
            `;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Toast å‹•ç•« CSS
        const toastStyle = document.createElement('style');
        toastStyle.textContent = `
            @keyframes fadeInOut {
                0% { opacity: 0; transform: translateX(-50%) translateY(20px); }
                15% { opacity: 1; transform: translateX(-50%) translateY(0); }
                85% { opacity: 1; transform: translateX(-50%) translateY(0); }
                100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
            }
        `;
        document.head.appendChild(toastStyle);

        // åˆ‡æ›æ·±è‰²æ¨¡å¼
        function toggleDarkMode() {
            appSettings.darkMode = !appSettings.darkMode;
            updateToggle('darkModeToggle', appSettings.darkMode);
            saveAppSettings();

            if (appSettings.darkMode) {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
        }

        // æ›´æ”¹å–®ä½
        function changeUnit() {
            appSettings.unit = document.getElementById('unitSelect').value;
            saveAppSettings();

            // é‡æ–°é¡¯ç¤ºå€‹äººè³‡æ–™ï¼ˆå¥—ç”¨æ–°å–®ä½ï¼‰
            if (profileData) {
                displayProfile(profileData);
            }
            showToast(`å·²åˆ‡æ›è‡³${appSettings.unit === 'metric' ? 'å…¬åˆ¶ (cm/kg)' : 'è‹±åˆ¶ (ft/lb)'}`);
        }

        // è«‹æ±‚é€šçŸ¥æ¬Šé™
        async function requestNotificationPermission() {
            if ('Notification' in window) {
                const permission = await Notification.requestPermission();
                console.log('é€šçŸ¥æ¬Šé™:', permission);
                return permission;
            }
            return 'denied';
        }

        // å–®ä½è½‰æ›å‡½æ•¸
        function convertUnit(value, type, toImperial) {
            if (toImperial) {
                // å…¬åˆ¶è½‰è‹±åˆ¶
                if (type === 'height') {
                    // cm to feet and inches
                    const totalInches = value / 2.54;
                    const feet = Math.floor(totalInches / 12);
                    const inches = Math.round(totalInches % 12);
                    return `${feet}'${inches}"`;
                } else if (type === 'weight') {
                    // kg to lb
                    return (value * 2.205).toFixed(1);
                }
            } else {
                // è‹±åˆ¶è½‰å…¬åˆ¶ (ä¿æŒåŸå€¼)
                return value;
            }
            return value;
        }

        // å–å¾—å–®ä½æ¨™ç±¤
        function getUnitLabel(type) {
            const isImperial = appSettings.unit === 'imperial';
            if (type === 'height') {
                return isImperial ? '' : 'cm';
            } else if (type === 'weight') {
                return isImperial ? 'lb' : 'kg';
            }
            return '';
        }

        // ===== Modal åŠŸèƒ½ =====

        // é¡¯ç¤ºé—œæ–¼ Modal
        function showAboutModal() {
            document.getElementById('aboutModal').classList.add('active');
        }

        // éš±è—é—œæ–¼ Modal
        function hideAboutModal() {
            document.getElementById('aboutModal').classList.remove('active');
        }

        // é¡¯ç¤ºæ„è¦‹å›é¥‹ Modal
        function showFeedbackModal() {
            document.getElementById('feedbackModal').classList.add('active');
        }

        // éš±è—æ„è¦‹å›é¥‹ Modal
        function hideFeedbackModal() {
            document.getElementById('feedbackModal').classList.remove('active');
            document.getElementById('feedbackContent').value = '';
        }

        // é¸æ“‡å›é¥‹é¡å‹
        function selectFeedbackType(btn, type) {
            feedbackType = type;
            document.querySelectorAll('.feedback-type-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        // æäº¤æ„è¦‹å›é¥‹
        async function submitFeedback() {
            const content = document.getElementById('feedbackContent').value.trim();

            if (!content) {
                alert('è«‹è¼¸å…¥æ‚¨çš„æ„è¦‹æˆ–å»ºè­°');
                return;
            }

            try {
                // å„²å­˜åˆ° Firestore
                await db.collection('feedback').add({
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    type: feedbackType,
                    content: content,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'pending'
                });

                alert('æ„Ÿè¬æ‚¨çš„å›é¥‹ï¼æˆ‘å€‘æœƒèªçœŸé–±è®€æ¯ä¸€æ¢å»ºè­°ã€‚');
                hideFeedbackModal();
            } catch (error) {
                console.error('æäº¤å›é¥‹å¤±æ•—:', error);
                alert('æäº¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        }

        // é»æ“Š Modal å¤–éƒ¨é—œé–‰
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });
    </script>
</body>
</html>

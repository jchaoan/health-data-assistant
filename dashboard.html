<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <!-- æ·±è‰²æ¨¡å¼ï¼ˆå…§è¯è…³æœ¬+æ¨£å¼ï¼Œé¿å…é–ƒçˆï¼‰ -->
    <script>try{if(JSON.parse(localStorage.getItem('bentoai_settings')||'{}').darkMode)document.documentElement.classList.add('dark-mode')}catch(e){}</script>
    <style>html.dark-mode,html.dark-mode body{background:linear-gradient(135deg,#1a1a2e 0%,#16213e 100%)!important}</style>
    <meta charset="UTF-8">
    <script src="/js/dark-mode.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <title>å¥åº·æ•¸æ“šåŠ©ç† - æ™ºæ…§ç‡Ÿé¤Šç®¡ç†</title>
    <!-- PWA æ”¯æ´ -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="å¥åº·åŠ©ç†">
    <link rel="apple-touch-icon" href="logo.png">
    <link rel="icon" href="logo.png" type="image/png">
    <!-- PWA å„ªåŒ–æ¨£å¼ -->
    <link rel="stylesheet" href="/css/pwa.css">
    <!-- PWA å®‰è£æç¤º -->
    <script src="/js/pwa-install.js" defer></script>
    <script src="/js/pwa-utils.js" defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 15px;
            padding-bottom: 85px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        /* é ‚éƒ¨ç”¨æˆ¶è³‡è¨Šå€ */
        .user-header {
            background: white;
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.8em;
            font-weight: bold;
        }

        .user-details h2 {
            color: #333;
            font-size: 1.5em;
            margin-bottom: 4px;
        }

        .user-details p {
            color: #888;
            font-size: 1em;
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .btn-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            border: none;
            background: #f5f5f5;
            cursor: pointer;
            font-size: 1.3em;
            transition: all 0.3s;
        }

        .btn-icon:hover {
            background: #667eea;
            color: white;
        }

        /* ä»Šæ—¥ç‡Ÿé¤Šå¡ç‰‡ - ç²¾ç°¡ç‰ˆ */
        .nutrition-card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        .nutrition-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .nutrition-title {
            color: #333;
            font-size: 1.2em;
            font-weight: 600;
        }

        .nutrition-date {
            color: #888;
            font-size: 0.95em;
        }

        /* ä¸»è¦ç†±é‡é¡¯ç¤º */
        .calories-main {
            text-align: center;
            padding: 20px 0;
            border-bottom: 1px solid #f0f0f0;
            margin-bottom: 20px;
        }

        .calories-circle {
            position: relative;
            width: 180px;
            height: 180px;
            margin: 0 auto 15px;
        }

        .calories-circle svg {
            transform: rotate(-90deg);
        }

        .calories-circle .bg {
            fill: none;
            stroke: #f0f0f0;
            stroke-width: 10;
        }

        .calories-circle .progress {
            fill: none;
            stroke: url(#gradient);
            stroke-width: 10;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s ease;
        }

        .calories-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .calories-current {
            font-size: 2.4em;
            font-weight: bold;
            color: #667eea;
            line-height: 1;
        }

        .calories-target {
            font-size: 1em;
            color: #888;
        }

        .calories-status {
            font-size: 1.05em;
            color: #666;
            margin-top: 8px;
        }

        .calories-status.over {
            color: #e74c3c;
        }

        .calories-status.good {
            color: #27ae60;
        }

        /* ä¸‰å¤§ç‡Ÿé¤Šç´  */
        .macros-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .macro-item {
            text-align: center;
            padding: 15px 10px;
            background: #f8f9ff;
            border-radius: 14px;
        }

        .macro-icon {
            font-size: 1.5em;
            margin-bottom: 8px;
        }

        .macro-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }

        .macro-label {
            font-size: 0.9em;
            color: #888;
            margin-top: 4px;
        }

        .macro-bar {
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            margin-top: 10px;
            overflow: hidden;
        }

        .macro-bar-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.5s;
        }

        .macro-bar-fill.protein { background: linear-gradient(90deg, #FF6B6B, #FF8E53); }
        .macro-bar-fill.carbs { background: linear-gradient(90deg, #4ECDC4, #44A08D); }
        .macro-bar-fill.fat { background: linear-gradient(90deg, #667eea, #764ba2); }

        /* æœ€è¿‘è¨˜éŒ„å¡ç‰‡ */
        .recent-card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        .recent-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
        }

        .recent-title {
            color: #333;
            font-size: 1.2em;
            font-weight: 600;
        }

        .recent-link {
            color: #667eea;
            font-size: 1em;
            text-decoration: none;
        }

        .recent-list {
            list-style: none;
        }

        .recent-item {
            display: flex;
            align-items: center;
            padding: 14px 0;
            border-bottom: 1px solid #f5f5f5;
        }

        .recent-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .recent-item:first-child {
            padding-top: 0;
        }

        .recent-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: #f8f9ff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4em;
            margin-right: 15px;
        }

        .recent-info {
            flex: 1;
        }

        .recent-name {
            color: #333;
            font-size: 1.05em;
            font-weight: 500;
        }

        .recent-time {
            color: #888;
            font-size: 0.9em;
        }

        .recent-calories {
            color: #667eea;
            font-weight: 600;
            font-size: 1.05em;
        }

        .no-records {
            text-align: center;
            color: #888;
            padding: 25px;
            font-size: 1em;
        }

        /* ä»Šæ—¥æç¤ºå¡ç‰‡ */
        .tips-card {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-radius: 18px;
            padding: 20px 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }

        .tips-icon {
            font-size: 1.8em;
            flex-shrink: 0;
        }

        .tips-content {
            flex: 1;
        }

        .tips-title {
            color: #2e7d32;
            font-size: 1.05em;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .tip-text {
            color: #33691e;
            font-size: 1em;
            line-height: 1.6;
        }

        /* åº•éƒ¨å°èˆªæ¬„ */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 8px 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: #666;
            font-size: 12px;
            padding: 5px 10px;
            border-radius: 10px;
            transition: all 0.3s;
            min-width: 60px;
        }

        .nav-item:hover {
            background: #f0f4ff;
            color: #667eea;
        }

        .nav-item.active {
            color: #667eea;
        }

        .nav-item.active .nav-icon {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .nav-icon {
            font-size: 20px;
            margin-bottom: 3px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            transition: all 0.3s;
        }

        .nav-label {
            font-weight: 500;
        }

        /* è¼‰å…¥ä¸­ */
        .loading {
            text-align: center;
            padding: 100px 20px;
            color: white;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* æ·±è‰²æ¨¡å¼ */
        body.dark-mode {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }

        body.dark-mode .user-header,
        body.dark-mode .nutrition-card,
        body.dark-mode .recent-card {
            background: #1e1e1e;
            color: #e0e0e0;
        }

        body.dark-mode .user-details h2 {
            color: #e0e0e0;
        }

        body.dark-mode .user-details p {
            color: #aaa;
        }

        body.dark-mode .btn-icon {
            background: #333;
            color: #e0e0e0;
        }

        body.dark-mode .btn-icon:hover {
            background: #667eea;
            color: white;
        }

        body.dark-mode .nutrition-title,
        body.dark-mode .recent-title {
            color: #e0e0e0;
        }

        body.dark-mode .nutrition-date,
        body.dark-mode .recent-time {
            color: #888;
        }

        body.dark-mode .macro-item {
            background: #2a2a2a;
        }

        body.dark-mode .macro-value,
        body.dark-mode .recent-name {
            color: #e0e0e0;
        }

        body.dark-mode .macro-label {
            color: #888;
        }

        body.dark-mode .macro-bar {
            background: #333;
        }

        body.dark-mode .recent-item {
            border-bottom-color: #333;
        }

        body.dark-mode .recent-icon {
            background: #2a2a2a;
        }

        body.dark-mode .tips-card {
            background: linear-gradient(135deg, #1a3a1a 0%, #2a4a2a 100%);
        }

        body.dark-mode .tips-title {
            color: #7cb77c;
        }

        body.dark-mode .tip-text {
            color: #a5d6a5;
        }

        body.dark-mode .bottom-nav {
            background: #1e1e1e;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
        }

        body.dark-mode .nav-item {
            color: #888;
        }

        body.dark-mode .nav-item:hover,
        body.dark-mode .nav-item.active {
            color: #667eea;
        }

        body.dark-mode .calories-target {
            color: #888;
        }

        body.dark-mode .calories-status {
            color: #aaa;
        }

        body.dark-mode .no-records {
            color: #888;
        }

        /* éŸ¿æ‡‰å¼ - æ‰‹æ©Ÿç‰ˆ */
        @media (max-width: 768px) {
            body {
                padding: 10px;
                padding-bottom: 100px;
            }

            .user-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
                padding: 20px;
            }

            .user-info {
                flex-direction: column;
            }

            .header-actions {
                width: 100%;
                justify-content: center;
            }

            .nutrition-card, .recent-card {
                padding: 18px;
                border-radius: 15px;
            }

            .calories-circle {
                width: 140px;
                height: 140px;
            }

            .calories-circle svg {
                width: 140px;
                height: 140px;
            }

            .calories-current {
                font-size: 1.8em;
            }

            .calories-target {
                font-size: 0.85em;
            }

            .macros-grid {
                gap: 10px;
            }

            .macro-item {
                padding: 12px 8px;
                min-width: 0;
            }

            .macro-icon {
                font-size: 1.3em;
            }

            .macro-value {
                font-size: 0.9em;
                white-space: nowrap;
            }

            .macro-label {
                font-size: 0.8em;
            }
        }

        @media (max-width: 400px) {
            .calories-circle {
                width: 120px;
                height: 120px;
            }

            .calories-circle svg {
                width: 120px;
                height: 120px;
            }

            .calories-current {
                font-size: 1.5em;
            }

            .macros-grid {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .macro-item {
                display: flex;
                align-items: center;
                gap: 10px;
                text-align: left;
                padding: 10px 15px;
            }

            .macro-bar {
                flex: 1;
                margin-top: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- è¼‰å…¥ä¸­ -->
        <div id="loading" class="loading">
            <div class="loading-spinner"></div>
            <p>è¼‰å…¥ä¸­...</p>
        </div>

        <!-- ä¸»å…§å®¹ -->
        <div id="mainContent" style="display: none;">
            <!-- é ‚éƒ¨ç”¨æˆ¶è³‡è¨Š -->
            <div class="user-header">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div class="user-details">
                        <h2 id="greeting">åˆå®‰ï¼</h2>
                        <p id="userName">ä½¿ç”¨è€…</p>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="btn-icon" onclick="window.location.href='settings.html'" title="è¨­å®š">âš™ï¸</button>
                </div>
            </div>

            <!-- ä»Šæ—¥ç‡Ÿé¤Š -->
            <div class="nutrition-card">
                <div class="nutrition-header">
                    <span class="nutrition-title">ä»Šæ—¥ç‡Ÿé¤Šæ”å–</span>
                    <span class="nutrition-date" id="todayDate"></span>
                </div>

                <!-- ç†±é‡åœ“ç’° -->
                <div class="calories-main">
                    <div class="calories-circle">
                        <svg width="180" height="180" viewBox="0 0 180 180">
                            <defs>
                                <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                    <stop offset="0%" stop-color="#667eea"/>
                                    <stop offset="100%" stop-color="#764ba2"/>
                                </linearGradient>
                            </defs>
                            <circle class="bg" cx="90" cy="90" r="78"/>
                            <circle class="progress" id="caloriesCircle" cx="90" cy="90" r="78"
                                stroke-dasharray="490" stroke-dashoffset="490"/>
                        </svg>
                        <div class="calories-text">
                            <div class="calories-current" id="caloriesCurrent">0</div>
                            <div class="calories-target">/ <span id="caloriesTarget">2000</span></div>
                        </div>
                    </div>
                    <div class="calories-status" id="caloriesStatus">é‚„éœ€æ”å– 2000 å¤§å¡</div>
                </div>

                <!-- ä¸‰å¤§ç‡Ÿé¤Šç´  -->
                <div class="macros-grid">
                    <div class="macro-item">
                        <div class="macro-icon">ğŸ¥©</div>
                        <div class="macro-value"><span id="proteinCurrent">0</span>/<span id="proteinTarget">60</span>g</div>
                        <div class="macro-label">è›‹ç™½è³ª</div>
                        <div class="macro-bar">
                            <div class="macro-bar-fill protein" id="proteinBar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="macro-item">
                        <div class="macro-icon">ğŸš</div>
                        <div class="macro-value"><span id="carbsCurrent">0</span>/<span id="carbsTarget">250</span>g</div>
                        <div class="macro-label">ç¢³æ°´</div>
                        <div class="macro-bar">
                            <div class="macro-bar-fill carbs" id="carbsBar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="macro-item">
                        <div class="macro-icon">ğŸ¥‘</div>
                        <div class="macro-value"><span id="fatCurrent">0</span>/<span id="fatTarget">65</span>g</div>
                        <div class="macro-label">è„‚è‚ª</div>
                        <div class="macro-bar">
                            <div class="macro-bar-fill fat" id="fatBar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æœ€è¿‘è¨˜éŒ„ -->
            <div class="recent-card">
                <div class="recent-header">
                    <span class="recent-title">æœ€è¿‘é£²é£Ÿ</span>
                    <a href="diet_records.html" class="recent-link">æŸ¥çœ‹å…¨éƒ¨ â€º</a>
                </div>
                <ul class="recent-list" id="recentList">
                    <li class="no-records">ä»Šå¤©é‚„æ²’æœ‰è¨˜éŒ„ï¼Œå¿«å»æ‹ç…§è¨˜éŒ„å§ï¼</li>
                </ul>
            </div>

            <!-- ä»Šæ—¥æç¤º -->
            <div class="tips-card">
                <div class="tips-icon">ğŸ’¡</div>
                <div class="tips-content">
                    <div class="tips-title">ä»Šæ—¥å»ºè­°</div>
                    <div class="tip-text" id="dailyTip">å‡è¡¡é£²é£Ÿæ˜¯å¥åº·çš„åŸºç¤ï¼Œè¨˜å¾—å¤šæ”å–è”¬æœï¼</div>
                </div>
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨å°èˆªæ¬„ -->
    <nav class="bottom-nav">
        <a href="dashboard.html" class="nav-item active">
            <div class="nav-icon">ğŸ </div>
            <span class="nav-label">é¦–é </span>
        </a>
        <a href="diet_records.html" class="nav-item">
            <div class="nav-icon">ğŸ½ï¸</div>
            <span class="nav-label">è¨˜éŒ„</span>
        </a>
        <a href="food-detect.html" class="nav-item">
            <div class="nav-icon">ğŸ“·</div>
            <span class="nav-label">è¾¨è­˜</span>
        </a>
        <a href="statistics.html" class="nav-item">
            <div class="nav-icon">ğŸ“Š</div>
            <span class="nav-label">çµ±è¨ˆ</span>
        </a>
        <a href="chat.html" class="nav-item">
            <div class="nav-icon">ğŸ’¬</div>
            <span class="nav-label">è«®è©¢</span>
        </a>
        <a href="exercise.html" class="nav-item">
            <div class="nav-icon">ğŸƒ</div>
            <span class="nav-label">é‹å‹•</span>
        </a>
        <a href="settings.html" class="nav-item">
            <div class="nav-icon">âš™ï¸</div>
            <span class="nav-label">è¨­å®š</span>
        </a>
    </nav>

    <!-- PWA Service Worker è¨»å†Š -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(reg => console.log('å¥åº·æ•¸æ“šåŠ©ç† PWA å·²å•Ÿç”¨'))
                    .catch(err => console.log('Service Worker è¨»å†Šå¤±æ•—:', err));
            });
        }
    </script>

    <!-- å…±ç”¨å·¥å…·å‡½æ•¸ -->
    <script src="/js/utils.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script>
        // Firebase é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyCk4GY-VkG4dd_zXP5HZQDlZbjdY0k0img",
            authDomain: "fooddata-92fa8.firebaseapp.com",
            projectId: "fooddata-92fa8",
            storageBucket: "fooddata-92fa8.firebasestorage.app",
            messagingSenderId: "459965557703",
            appId: "1:459965557703:web:6a16b3937935219eb887e2",
            measurementId: "G-R16CYV7QC2"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUser = null;
        let userProfile = null;
        let todayData = { calories: 0, protein: 0, carbs: 0, fat: 0 };
        let targets = { calories: 2000, protein: 60, carbs: 250, fat: 65 };

        // è¨­å®šä»Šæ—¥æ—¥æœŸ
        const today = new Date();
        document.getElementById('todayDate').textContent =
            `${today.getMonth() + 1}/${today.getDate()} ${['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][today.getDay()]}`;

        // ç›£è½ç™»å…¥ç‹€æ…‹
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;

                // è¨­å®šå•å€™èªå’Œç”¨æˆ¶å
                setGreeting();
                const displayName = user.displayName || user.email.split('@')[0];
                document.getElementById('userName').textContent = displayName;
                document.getElementById('userAvatar').textContent = displayName.charAt(0).toUpperCase();

                // è¼‰å…¥è³‡æ–™
                await loadUserProfile();
                await loadTodayStats();
                await loadRecentRecords();

                // ç”Ÿæˆå€‹äººåŒ–æç¤º
                generateTip();

                // é¡¯ç¤ºä¸»å…§å®¹
                document.getElementById('loading').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
            } else {
                window.location.href = 'login.html';
            }
        });

        function setGreeting() {
            const hour = new Date().getHours();
            let greeting = 'ä½ å¥½ï¼';
            if (hour >= 5 && hour < 12) greeting = 'æ—©å®‰ï¼';
            else if (hour >= 12 && hour < 18) greeting = 'åˆå®‰ï¼';
            else greeting = 'æ™šå®‰ï¼';
            document.getElementById('greeting').textContent = greeting;
        }

        async function loadUserProfile() {
            try {
                const doc = await db.collection('member').doc(currentUser.uid).get();
                if (doc.exists) {
                    userProfile = doc.data();
                    // æ›´æ–°ç›®æ¨™å€¼
                    targets.calories = userProfile.targetCalories || 2000;
                    targets.protein = userProfile.targetProtein || 60;
                    targets.carbs = userProfile.targetCarbs || 250;
                    targets.fat = userProfile.targetFat || 65;

                    // æ›´æ–°é¡¯ç¤º
                    document.getElementById('caloriesTarget').textContent = targets.calories;
                    document.getElementById('proteinTarget').textContent = targets.protein;
                    document.getElementById('carbsTarget').textContent = targets.carbs;
                    document.getElementById('fatTarget').textContent = targets.fat;
                }
            } catch (error) {
                console.error('è¼‰å…¥ç”¨æˆ¶è³‡æ–™å¤±æ•—:', error);
            }
        }

        async function loadTodayStats() {
            try {
                const idToken = await currentUser.getIdToken();
                const response = await fetch('https://bentoai-api-de2tsulgza-de.a.run.app/api/statistics?days=1', {
                    headers: { 'Authorization': `Bearer ${idToken}` }
                });

                const data = await response.json();

                if (data.success && data.daily_trend && data.daily_trend.length > 0) {
                    const today = data.daily_trend[data.daily_trend.length - 1];
                    todayData = {
                        calories: Math.round(today.calories || 0),
                        protein: Math.round(today.protein || 0),
                        carbs: Math.round(today.carbs || 0),
                        fat: Math.round(today.fat || 0)
                    };
                }

                updateNutritionDisplay();
            } catch (error) {
                console.error('è¼‰å…¥çµ±è¨ˆå¤±æ•—:', error);
                updateNutritionDisplay();
            }
        }

        function updateNutritionDisplay() {
            // æ›´æ–°ç†±é‡åœ“ç’°
            const caloriesPercent = Math.min(100, (todayData.calories / targets.calories) * 100);
            const circumference = 2 * Math.PI * 78; // r=78
            const offset = circumference - (caloriesPercent / 100) * circumference;
            document.getElementById('caloriesCircle').style.strokeDashoffset = offset;
            document.getElementById('caloriesCurrent').textContent = todayData.calories;

            // æ›´æ–°ç‹€æ…‹æ–‡å­—
            const remaining = targets.calories - todayData.calories;
            const statusEl = document.getElementById('caloriesStatus');
            if (remaining > 0) {
                statusEl.textContent = `é‚„éœ€æ”å– ${remaining} å¤§å¡`;
                statusEl.className = 'calories-status';
            } else if (remaining === 0) {
                statusEl.textContent = 'å·²é”æˆç›®æ¨™ï¼';
                statusEl.className = 'calories-status good';
            } else {
                statusEl.textContent = `å·²è¶…é ${Math.abs(remaining)} å¤§å¡`;
                statusEl.className = 'calories-status over';
            }

            // æ›´æ–°ä¸‰å¤§ç‡Ÿé¤Šç´ 
            document.getElementById('proteinCurrent').textContent = todayData.protein;
            document.getElementById('carbsCurrent').textContent = todayData.carbs;
            document.getElementById('fatCurrent').textContent = todayData.fat;

            document.getElementById('proteinBar').style.width =
                Math.min(100, (todayData.protein / targets.protein) * 100) + '%';
            document.getElementById('carbsBar').style.width =
                Math.min(100, (todayData.carbs / targets.carbs) * 100) + '%';
            document.getElementById('fatBar').style.width =
                Math.min(100, (todayData.fat / targets.fat) * 100) + '%';
        }

        async function loadRecentRecords() {
            try {
                const idToken = await currentUser.getIdToken();
                const response = await fetch('https://bentoai-api-de2tsulgza-de.a.run.app/api/diet-records?limit=1', {
                    headers: { 'Authorization': `Bearer ${idToken}` }
                });

                const data = await response.json();
                console.log('Diet records response:', data);
                if (data.data && data.data[0]) {
                    console.log('First record:', data.data[0]);
                    console.log('Predictions:', data.data[0].predictions);
                    if (data.data[0].predictions && data.data[0].predictions[0]) {
                        console.log('First prediction keys:', Object.keys(data.data[0].predictions[0]));
                        console.log('First prediction:', data.data[0].predictions[0]);
                    }
                }

                if (data.success && data.data && data.data.length > 0) {
                    const listEl = document.getElementById('recentList');
                    listEl.innerHTML = data.data.map(record => {
                        // è§£ææ™‚é–“
                        const time = new Date(record.created_at);
                        const timeStr = `${time.getHours()}:${time.getMinutes().toString().padStart(2, '0')}`;
                        const mealIcon = getMealIcon(time.getHours());

                        // å¾ predictions é™£åˆ—å–å¾—é£Ÿç‰©åç¨±
                        let displayName = 'é£²é£Ÿè¨˜éŒ„';
                        let totalCalories = 0;
                        let itemCount = 0;

                        if (record.predictions && record.predictions.length > 0) {
                            itemCount = record.predictions.length;
                            const names = record.predictions
                                .map(p => {
                                    let name = p.class_name_zh || p.class_name || p.name || '';
                                    // ç§»é™¤é–‹é ­çš„ â• ç¬¦è™Ÿå’Œå¤šé¤˜ç©ºæ ¼
                                    name = name.replace(/^â•\s*/, '').trim();
                                    // ç§»é™¤æ‹¬è™Ÿéƒ¨åˆ†å¦‚ (1ç¢—)
                                    name = name.replace(/\s*\([^)]*\)\s*$/, '').trim();
                                    return name;
                                })
                                .filter(n => n);

                            // é¡¯ç¤ºå‰2é …ï¼Œå¦‚æœè¶…é2é …å‰‡é¡¯ç¤ºã€Œç­‰Xé …ã€
                            if (names.length > 2) {
                                displayName = names.slice(0, 2).join('ã€') + ` ç­‰${names.length}é …`;
                            } else if (names.length > 0) {
                                displayName = names.join('ã€');
                            }
                        }

                        // å¾ total_nutrition å–å¾—ç†±é‡ (æ¬„ä½æ˜¯ total_cal)
                        totalCalories = record.total_nutrition?.total_cal || 0;

                        return `
                            <li class="recent-item">
                                <div class="recent-icon">${mealIcon}</div>
                                <div class="recent-info">
                                    <div class="recent-name">${displayName}</div>
                                    <div class="recent-time">${timeStr}</div>
                                </div>
                                <div class="recent-calories">${Math.round(totalCalories)} å¡</div>
                            </li>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('è¼‰å…¥æœ€è¿‘è¨˜éŒ„å¤±æ•—:', error);
            }
        }

        function getMealIcon(hour) {
            if (hour >= 5 && hour < 10) return 'ğŸŒ…';      // æ—©é¤
            if (hour >= 10 && hour < 14) return 'â˜€ï¸';    // åˆé¤
            if (hour >= 14 && hour < 17) return 'ğŸµ';    // ä¸‹åˆèŒ¶
            if (hour >= 17 && hour < 21) return 'ğŸŒ™';    // æ™šé¤
            return 'ğŸŒƒ';                                   // å®µå¤œ
        }

        function generateTip() {
            const tips = [];

            // æ ¹æ“šç‡Ÿé¤Šæ”å–ç‹€æ³çµ¦å»ºè­°
            const proteinPercent = (todayData.protein / targets.protein) * 100;
            const carbsPercent = (todayData.carbs / targets.carbs) * 100;
            const caloriesPercent = (todayData.calories / targets.calories) * 100;

            if (proteinPercent < 50) {
                tips.push('è›‹ç™½è³ªæ”å–ä¸è¶³ï¼Œå»ºè­°å¤šåƒè±†é¡ã€é­šè‚‰ã€é›è›‹ç­‰é£Ÿç‰©ã€‚');
            }
            if (carbsPercent > 100) {
                tips.push('ç¢³æ°´åŒ–åˆç‰©æ”å–åå¤šï¼Œå¯ä»¥æ¸›å°‘ç™½é£¯ã€éºµåŒ…çš„ä»½é‡ã€‚');
            }
            if (caloriesPercent < 30 && new Date().getHours() > 12) {
                tips.push('ä»Šå¤©åƒå¾—æ¯”è¼ƒå°‘ï¼Œè¨˜å¾—æŒ‰æ™‚ç”¨é¤ç¶­æŒé«”åŠ›ï¼');
            }
            if (caloriesPercent > 90 && caloriesPercent <= 100) {
                tips.push('ä»Šå¤©ç‡Ÿé¤Šæ”å–æ¥è¿‘ç›®æ¨™ï¼Œåšå¾—å¾ˆå¥½ï¼');
            }

            // é è¨­æç¤º
            const defaultTips = [
                'å‡è¡¡é£²é£Ÿæ˜¯å¥åº·çš„åŸºç¤ï¼Œè¨˜å¾—å¤šæ”å–è”¬æœï¼',
                'æ¯å¤©å–è¶³ 2000ml çš„æ°´ï¼Œå¹«åŠ©æ–°é™³ä»£è¬ã€‚',
                'ç´°åš¼æ…¢åš¥æœ‰åŠ©æ–¼æ¶ˆåŒ–ï¼Œä¹Ÿèƒ½å¢åŠ é£½è¶³æ„Ÿã€‚',
                'ä¸‰é¤å®šæ™‚å®šé‡ï¼Œé¿å…æš´é£²æš´é£Ÿã€‚'
            ];

            const finalTip = tips.length > 0 ? tips[0] :
                defaultTips[Math.floor(Math.random() * defaultTips.length)];

            document.getElementById('dailyTip').textContent = finalTip;
        }
    </script>
</body>
</html>

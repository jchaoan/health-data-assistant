<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <!-- æ·±è‰²/æ·ºè‰²æ¨¡å¼ï¼ˆå…§è¯è…³æœ¬+æ¨£å¼ï¼Œé¿å…é–ƒçˆï¼‰ -->
    <script>try{var s=JSON.parse(localStorage.getItem('bentoai_settings')||'{}');if(s.darkMode){document.documentElement.classList.add('dark-mode')}else{document.documentElement.classList.remove('dark-mode')}}catch(e){document.documentElement.classList.remove('dark-mode')}</script>
    <style>html:not(.dark-mode),html:not(.dark-mode) body{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)!important}html:not(.dark-mode) .bottom-nav{background:white!important;box-shadow:0 -2px 12px rgba(0,0,0,0.08)!important}html:not(.dark-mode) .nav-item{color:#999!important}html:not(.dark-mode) .header,html:not(.dark-mode) .user-card,html:not(.dark-mode) .settings-section,html:not(.dark-mode) .card,html:not(.dark-mode) .loading{background:white!important;color:#333!important}html:not(.dark-mode) .btn-secondary{background:#6c757d!important;color:white!important}html.dark-mode,html.dark-mode body{background:linear-gradient(135deg,#1a1a2e 0%,#16213e 100%)!important}html.dark-mode .bottom-nav{background:#1a1a2e!important;border-top:1px solid #2a2a3e}html.dark-mode .nav-item{color:#888!important}html.dark-mode .container,html.dark-mode .header,html.dark-mode .section,html.dark-mode .form-section,html.dark-mode .form-group,html.dark-mode .settings-section,html.dark-mode .settings-item,html.dark-mode .user-card,html.dark-mode .user-header,html.dark-mode .user-info,html.dark-mode .profile-item,html.dark-mode .profile-grid,html.dark-mode .profile-panel,html.dark-mode .option-card,html.dark-mode .feature-card,html.dark-mode .stat-card,html.dark-mode .summary-item,html.dark-mode .nutrition-item,html.dark-mode .nutrition-card,html.dark-mode .chart-container,html.dark-mode .chart-section,html.dark-mode .insight-card,html.dark-mode .tips-card,html.dark-mode .recent-card,html.dark-mode .card,html.dark-mode .chat-container,html.dark-mode .chat-header,html.dark-mode .chat-messages,html.dark-mode .chat-input-area,html.dark-mode .quick-questions,html.dark-mode .welcome-message,html.dark-mode .edit-form,html.dark-mode .stats-grid,html.dark-mode .loading,html.dark-mode .step,html.dark-mode .total-item,html.dark-mode .input-wrapper,html.dark-mode .options-grid,html.dark-mode .multi-option,html.dark-mode .tech-item,html.dark-mode .empty-state,html.dark-mode .filter-btn,html.dark-mode .time-selector,html.dark-mode .controls,html.dark-mode .record-card,html.dark-mode .meal-section,html.dark-mode .food-item,html.dark-mode .modal-content,html.dark-mode .upload-area,html.dark-mode .result-card,html.dark-mode .analysis-card{background:#1e1e2e!important;color:#e0e0e0!important}html.dark-mode input,html.dark-mode select,html.dark-mode textarea{background:#2a2a3e!important;color:#e0e0e0!important;border-color:#3a3a4e!important}html.dark-mode .btn-secondary{background:#3a3a4e!important;color:#e0e0e0!important}</style>
    <meta charset="UTF-8">
    <script src="/js/dark-mode.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å€‹äººè³‡æ–™è¨­å®š - ç‡Ÿé¤Šè¿½è¹¤ç³»çµ±</title>
    <!-- PWA æ”¯æ´ -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="å¥åº·åŠ©ç†">
    <link rel="apple-touch-icon" href="logo.png">
    <link rel="icon" href="logo.png" type="image/png">

    <!-- å…±ç”¨å·¥å…·å‡½æ•¸ -->
    <script src="/js/utils.js"></script>
    <!-- PWA å®‰è£æç¤º -->
    <script src="/js/pwa-install.js" defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
        }

        .setup-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            width: 100%;
            max-width: 700px;
            margin: 20px 0;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #333;
            font-size: 28px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-logo {
            width: 45px;
            height: 45px;
            object-fit: contain;
        }

        .header p {
            color: #666;
            font-size: 16px;
        }

        .progress-bar {
            height: 8px;
            background: #e0e0e0;
            border-radius: 10px;
            margin-bottom: 30px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
        }

        /* æ­¥é©ŸæŒ‡ç¤ºå™¨ */
        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            gap: 10px;
        }

        .step-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e0e0e0;
            transition: all 0.3s;
        }

        .step-dot.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transform: scale(1.2);
        }

        .step-dot.completed {
            background: #27ae60;
        }

        .form-section {
            margin-bottom: 30px;
            display: none;
        }

        .form-section.active {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .section-title {
            color: #333;
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-subtitle {
            color: #666;
            font-size: 14px;
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            color: #555;
            font-weight: 500;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .required-mark {
            color: #e74c3c;
            margin-left: 3px;
        }

        .optional-mark {
            color: #999;
            font-size: 12px;
            font-weight: normal;
            margin-left: 5px;
        }

        input[type="number"],
        input[type="text"],
        select,
        textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s;
        }

        input[type="number"]:focus,
        input[type="text"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .gender-options,
        .goal-options,
        .frequency-options,
        .experience-options,
        .time-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }

        .option-card {
            padding: 15px 10px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .option-card:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .option-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .option-icon {
            font-size: 28px;
            margin-bottom: 8px;
        }

        .option-label {
            font-size: 13px;
            font-weight: 600;
        }

        .option-desc {
            font-size: 11px;
            opacity: 0.8;
            margin-top: 4px;
        }

        /* å¤šé¸å¡ç‰‡æ¨£å¼ */
        .multi-select-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
        }

        .multi-option {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .multi-option:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .multi-option.selected {
            border-color: #667eea;
            background: #f0f3ff;
            color: #667eea;
        }

        .multi-option .option-icon {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .multi-option .option-label {
            font-size: 12px;
        }

        .calculated-values {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
        }

        .calc-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #dee2e6;
        }

        .calc-row:last-child {
            border-bottom: none;
        }

        .calc-label {
            color: #666;
            font-weight: 500;
        }

        .calc-value {
            color: #333;
            font-weight: 700;
            font-size: 18px;
        }

        .btn-container {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .btn-prev,
        .btn-next,
        .btn-submit {
            flex: 1;
            padding: 15px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-prev {
            background: #e0e0e0;
            color: #666;
            border: none;
        }

        .btn-prev:hover {
            background: #d0d0d0;
        }

        .btn-next,
        .btn-submit {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
        }

        .btn-next:hover,
        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        .btn-next:disabled,
        .btn-submit:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-skip {
            width: 100%;
            padding: 12px;
            background: transparent;
            color: #999;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 10px;
        }

        .btn-skip:hover {
            color: #667eea;
            text-decoration: underline;
        }

        .info-box {
            background: #e8f4fd;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
        }

        .info-box p {
            color: #0277BD;
            font-size: 14px;
            line-height: 1.6;
        }

        .info-box.optional {
            background: #fff3e0;
            border-left-color: #ff9800;
        }

        .info-box.optional p {
            color: #e65100;
        }

        .divider {
            border-top: 2px dashed #e0e0e0;
            margin: 30px 0;
        }

        /* é‹å‹•å»ºè­°é è¦½ */
        .exercise-preview {
            background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }

        .exercise-preview.show {
            display: block;
        }

        .exercise-preview h4 {
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .exercise-preview-content {
            color: #555;
            font-size: 14px;
            line-height: 1.8;
        }

        @media (max-width: 480px) {
            .setup-container {
                padding: 25px 15px;
            }

            .header h1 {
                font-size: 22px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .gender-options,
            .goal-options,
            .frequency-options,
            .experience-options,
            .time-options {
                grid-template-columns: repeat(2, 1fr);
            }

            .multi-select-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .btn-container {
                flex-direction: column;
            }
        }

        /* æ·±è‰²æ¨¡å¼ */
        html.dark-mode {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }

        html.dark-mode .setup-container {
            background: #1e1e1e;
        }

        html.dark-mode .header h1 {
            color: #667eea;
        }

        html.dark-mode .header p {
            color: #888;
        }

        html.dark-mode .step-number {
            background: #333;
            color: #667eea;
        }

        html.dark-mode .step-title {
            color: #e0e0e0;
        }

        html.dark-mode label {
            color: #ccc;
        }

        html.dark-mode input[type="number"],
        html.dark-mode input[type="text"],
        html.dark-mode select {
            background: #2a2a2a;
            border-color: #444;
            color: #e0e0e0;
        }

        html.dark-mode input:focus,
        html.dark-mode select:focus {
            border-color: #667eea;
        }

        html.dark-mode .option-card {
            background: #2a2a2a;
            border-color: #444;
            color: #e0e0e0;
        }

        html.dark-mode .option-card:hover {
            border-color: #667eea;
        }

        html.dark-mode .option-card.selected {
            border-color: #667eea;
            background: #333;
        }

        html.dark-mode .multi-option {
            background: #2a2a2a;
            border-color: #444;
            color: #e0e0e0;
        }

        html.dark-mode .multi-option:hover {
            border-color: #667eea;
        }

        html.dark-mode .multi-option.selected {
            border-color: #667eea;
            background: #333;
        }

        html.dark-mode .calculated-results {
            background: #2a2a2a;
        }

        html.dark-mode .result-item {
            background: #333;
        }

        html.dark-mode .result-label {
            color: #aaa;
        }

        html.dark-mode .btn-secondary {
            background: #444;
            color: #e0e0e0;
        }
    </style>
</head>
<body>
    <div class="setup-container">
        <div class="header">
            <h1><img src="logo.png" alt="Logo" class="header-logo">å€‹äººè³‡æ–™è¨­å®š</h1>
            <p>å®Œå–„æ‚¨çš„è³‡æ–™ï¼Œç²å¾—å€‹äººåŒ–ç‡Ÿé¤Šèˆ‡é‹å‹•å»ºè­°</p>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>

        <div class="step-indicator">
            <div class="step-dot active" id="step1Dot"></div>
            <div class="step-dot" id="step2Dot"></div>
            <div class="step-dot" id="step3Dot"></div>
            <div class="step-dot" id="step4Dot"></div>
        </div>

        <form id="profileForm">
            <!-- ç¬¬ä¸€æ­¥ï¼šåŸºæœ¬è³‡æ–™ -->
            <div class="form-section active" id="step1">
                <h2 class="section-title">ğŸ“‹ åŸºæœ¬è³‡æ–™</h2>
                <p class="section-subtitle">é€™äº›è³‡æ–™å°‡ç”¨æ–¼è¨ˆç®—æ‚¨çš„åŸºç¤ä»£è¬ç‡å’Œç‡Ÿé¤Šéœ€æ±‚</p>

                <div class="form-group">
                    <label>æ€§åˆ¥ <span class="required-mark">*</span></label>
                    <div class="gender-options">
                        <div class="option-card" onclick="selectGender(true)">
                            <div class="option-icon">ğŸ‘¨</div>
                            <div class="option-label">ç”·æ€§</div>
                        </div>
                        <div class="option-card" onclick="selectGender(false)">
                            <div class="option-icon">ğŸ‘©</div>
                            <div class="option-label">å¥³æ€§</div>
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="age">å¹´é½¡ <span class="required-mark">*</span></label>
                        <input type="number" id="age" placeholder="ä¾‹å¦‚ï¼š25" min="10" max="120" required>
                    </div>
                    <div class="form-group">
                        <label for="height">èº«é«˜ (cm) <span class="required-mark">*</span></label>
                        <input type="number" id="height" placeholder="ä¾‹å¦‚ï¼š170" min="100" max="250" step="0.1" required>
                    </div>
                    <div class="form-group">
                        <label for="weight">é«”é‡ (kg) <span class="required-mark">*</span></label>
                        <input type="number" id="weight" placeholder="ä¾‹å¦‚ï¼š65" min="20" max="300" step="0.1" required>
                    </div>
                </div>
            </div>

            <!-- ç¬¬äºŒæ­¥ï¼šå¥åº·ç›®æ¨™ -->
            <div class="form-section" id="step2">
                <h2 class="section-title">ğŸ¯ å¥åº·ç›®æ¨™</h2>
                <p class="section-subtitle">é¸æ“‡æ‚¨çš„å¥åº·ç›®æ¨™ï¼Œç³»çµ±å°‡æ“šæ­¤èª¿æ•´ç‡Ÿé¤Šå»ºè­°</p>

                <div class="form-group">
                    <label>æ‚¨çš„ç›®æ¨™ <span class="required-mark">*</span></label>
                    <div class="goal-options">
                        <div class="option-card" onclick="selectGoal(0)">
                            <div class="option-icon">âš–ï¸</div>
                            <div class="option-label">ç¶­æŒé«”é‡</div>
                            <div class="option-desc">ä¿æŒå¥åº·</div>
                        </div>
                        <div class="option-card" onclick="selectGoal(1)">
                            <div class="option-icon">ğŸ“‰</div>
                            <div class="option-label">æ¸›é‡</div>
                            <div class="option-desc">æ¸›å°‘é«”è„‚</div>
                        </div>
                        <div class="option-card" onclick="selectGoal(2)">
                            <div class="option-icon">ğŸ’ª</div>
                            <div class="option-label">å¢è‚Œ</div>
                            <div class="option-desc">å¢åŠ è‚Œè‚‰</div>
                        </div>
                        <div class="option-card" onclick="selectGoal(3)">
                            <div class="option-icon">â¤ï¸</div>
                            <div class="option-label">æ”¹å–„å¥åº·</div>
                            <div class="option-desc">æ…¢æ€§ç—…ç®¡ç†</div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="activityLevel">æ—¥å¸¸æ´»å‹•é‡ <span class="required-mark">*</span></label>
                    <select id="activityLevel">
                        <option value="sedentary">ä¹…å - å¹¾ä¹ä¸é‹å‹•ï¼Œè¾¦å…¬å®¤å·¥ä½œ</option>
                        <option value="lightly_active">è¼•åº¦æ´»å‹• - å¶çˆ¾èµ°å‹•ï¼Œæ¯é€±é‹å‹•1-2æ¬¡</option>
                        <option value="moderately_active" selected>ä¸­åº¦æ´»å‹• - æ¯é€±é‹å‹•3-5æ¬¡</option>
                        <option value="very_active">é«˜åº¦æ´»å‹• - æ¯é€±é‹å‹•6-7æ¬¡ï¼Œé«”åŠ›å·¥ä½œ</option>
                        <option value="extra_active">æ¥µé«˜æ´»å‹• - æ¯å¤©é«˜å¼·åº¦é‹å‹•æˆ–å‹å‹•</option>
                    </select>
                </div>

                <!-- è¨ˆç®—çµæœ -->
                <div class="calculated-values" id="calculatedValues" style="display: none;">
                    <h3 style="margin-bottom: 15px; color: #333;">ğŸ“Š æ‚¨çš„ç‡Ÿé¤Šè¨ˆç®—çµæœ</h3>
                    <div class="calc-row">
                        <span class="calc-label">BMI æŒ‡æ•¸</span>
                        <span class="calc-value" id="bmiValue">-</span>
                    </div>
                    <div class="calc-row">
                        <span class="calc-label">åŸºç¤ä»£è¬ç‡ (BMR)</span>
                        <span class="calc-value" id="bmrValue">-</span>
                    </div>
                    <div class="calc-row">
                        <span class="calc-label">æ¯æ—¥ç¸½æ¶ˆè€— (TDEE)</span>
                        <span class="calc-value" id="tdeeValue">-</span>
                    </div>
                    <div class="calc-row">
                        <span class="calc-label">å»ºè­°ç†±é‡æ”å–</span>
                        <span class="calc-value" id="suggestedCalories">-</span>
                    </div>
                </div>
            </div>

            <!-- ç¬¬ä¸‰æ­¥ï¼šé‹å‹•ç¿’æ…£ï¼ˆé¸å¡«ï¼‰-->
            <div class="form-section" id="step3">
                <h2 class="section-title">ğŸƒ é‹å‹•ç¿’æ…£</h2>
                <div class="info-box optional">
                    <p>ğŸ’¡ ä»¥ä¸‹ç‚ºé¸å¡«é …ç›®ã€‚å¡«å¯«å¾Œç³»çµ±å¯ç‚ºæ‚¨ç”Ÿæˆå€‹äººåŒ–çš„é‹å‹•å»ºè­°ï¼Œå¹«åŠ©æ‚¨æ›´æœ‰æ•ˆé”æˆå¥åº·ç›®æ¨™ã€‚</p>
                </div>

                <div class="form-group">
                    <label>ç›®å‰é‹å‹•é »ç‡ <span class="optional-mark">(é¸å¡«)</span></label>
                    <div class="frequency-options">
                        <div class="option-card" onclick="selectFrequency(0)">
                            <div class="option-icon">ğŸ›‹ï¸</div>
                            <div class="option-label">å¹¾ä¹ä¸é‹å‹•</div>
                        </div>
                        <div class="option-card" onclick="selectFrequency(1)">
                            <div class="option-icon">ğŸš¶</div>
                            <div class="option-label">æ¯é€±1-2æ¬¡</div>
                        </div>
                        <div class="option-card" onclick="selectFrequency(2)">
                            <div class="option-icon">ğŸƒ</div>
                            <div class="option-label">æ¯é€±3-4æ¬¡</div>
                        </div>
                        <div class="option-card" onclick="selectFrequency(3)">
                            <div class="option-icon">ğŸ‹ï¸</div>
                            <div class="option-label">æ¯é€±5æ¬¡ä»¥ä¸Š</div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>é‹å‹•ç¶“é©—ç¨‹åº¦ <span class="optional-mark">(é¸å¡«)</span></label>
                    <div class="experience-options">
                        <div class="option-card" onclick="selectExperience(0)">
                            <div class="option-icon">ğŸŒ±</div>
                            <div class="option-label">æ–°æ‰‹</div>
                            <div class="option-desc">å‰›é–‹å§‹é‹å‹•</div>
                        </div>
                        <div class="option-card" onclick="selectExperience(1)">
                            <div class="option-icon">ğŸŒ¿</div>
                            <div class="option-label">åˆå­¸è€…</div>
                            <div class="option-desc">æœ‰äº›åŸºç¤</div>
                        </div>
                        <div class="option-card" onclick="selectExperience(2)">
                            <div class="option-icon">ğŸŒ³</div>
                            <div class="option-label">ä¸­ç´šè€…</div>
                            <div class="option-desc">è¦å¾‹é‹å‹•ä¸­</div>
                        </div>
                        <div class="option-card" onclick="selectExperience(3)">
                            <div class="option-icon">ğŸ†</div>
                            <div class="option-label">é€²éšè€…</div>
                            <div class="option-desc">é‹å‹•æ„›å¥½è€…</div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>æ¯æ¬¡å¯é‹å‹•æ™‚é–“ <span class="optional-mark">(é¸å¡«)</span></label>
                    <div class="time-options">
                        <div class="option-card" onclick="selectTime(0)">
                            <div class="option-icon">â±ï¸</div>
                            <div class="option-label">15-30 åˆ†é˜</div>
                        </div>
                        <div class="option-card" onclick="selectTime(1)">
                            <div class="option-icon">â°</div>
                            <div class="option-label">30-60 åˆ†é˜</div>
                        </div>
                        <div class="option-card" onclick="selectTime(2)">
                            <div class="option-icon">ğŸ•</div>
                            <div class="option-label">60-90 åˆ†é˜</div>
                        </div>
                        <div class="option-card" onclick="selectTime(3)">
                            <div class="option-icon">ğŸ•‘</div>
                            <div class="option-label">90 åˆ†é˜ä»¥ä¸Š</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç¬¬å››æ­¥ï¼šé‹å‹•åå¥½èˆ‡é™åˆ¶ï¼ˆé¸å¡«ï¼‰-->
            <div class="form-section" id="step4">
                <h2 class="section-title">âš™ï¸ é‹å‹•åå¥½èˆ‡é™åˆ¶</h2>
                <p class="section-subtitle">é¸æ“‡æ‚¨å–œæ­¡çš„é‹å‹•é¡å‹å’Œèº«é«”é™åˆ¶ï¼Œè®“å»ºè­°æ›´ç²¾æº–</p>

                <div class="form-group">
                    <label>åå¥½é‹å‹•é¡å‹ <span class="optional-mark">(å¯è¤‡é¸)</span></label>
                    <div class="multi-select-grid">
                        <div class="multi-option" onclick="toggleExerciseType('cardio')">
                            <div class="option-icon">ğŸƒ</div>
                            <div class="option-label">æœ‰æ°§é‹å‹•</div>
                        </div>
                        <div class="multi-option" onclick="toggleExerciseType('strength')">
                            <div class="option-icon">ğŸ‹ï¸</div>
                            <div class="option-label">é‡é‡è¨“ç·´</div>
                        </div>
                        <div class="multi-option" onclick="toggleExerciseType('hiit')">
                            <div class="option-icon">âš¡</div>
                            <div class="option-label">HIIT é–“æ­‡</div>
                        </div>
                        <div class="multi-option" onclick="toggleExerciseType('yoga')">
                            <div class="option-icon">ğŸ§˜</div>
                            <div class="option-label">ç‘œä¼½ä¼¸å±•</div>
                        </div>
                        <div class="multi-option" onclick="toggleExerciseType('swimming')">
                            <div class="option-icon">ğŸŠ</div>
                            <div class="option-label">æ¸¸æ³³</div>
                        </div>
                        <div class="multi-option" onclick="toggleExerciseType('cycling')">
                            <div class="option-icon">ğŸš´</div>
                            <div class="option-label">é¨è»Š</div>
                        </div>
                        <div class="multi-option" onclick="toggleExerciseType('ball')">
                            <div class="option-icon">âš½</div>
                            <div class="option-label">çƒé¡é‹å‹•</div>
                        </div>
                        <div class="multi-option" onclick="toggleExerciseType('outdoor')">
                            <div class="option-icon">ğŸ¥¾</div>
                            <div class="option-label">æˆ¶å¤–æ´»å‹•</div>
                        </div>
                        <div class="multi-option" onclick="toggleExerciseType('home')">
                            <div class="option-icon">ğŸ </div>
                            <div class="option-label">å±…å®¶é‹å‹•</div>
                        </div>
                        <div class="multi-option" onclick="toggleExerciseType('dance')">
                            <div class="option-icon">ğŸ’ƒ</div>
                            <div class="option-label">èˆè¹ˆæœ‰æ°§</div>
                        </div>
                    </div>
                </div>

                <div class="divider"></div>

                <div class="form-group">
                    <label>å¯ä½¿ç”¨å™¨æ <span class="optional-mark">(å¯è¤‡é¸)</span></label>
                    <div class="multi-select-grid">
                        <div class="multi-option" onclick="toggleEquipment('none')">
                            <div class="option-icon">ğŸ¤¸</div>
                            <div class="option-label">ç„¡å™¨æ</div>
                        </div>
                        <div class="multi-option" onclick="toggleEquipment('dumbbell')">
                            <div class="option-icon">ğŸ‹ï¸</div>
                            <div class="option-label">å•éˆ´</div>
                        </div>
                        <div class="multi-option" onclick="toggleEquipment('barbell')">
                            <div class="option-icon">ğŸ‹ï¸â€â™‚ï¸</div>
                            <div class="option-label">æ§“éˆ´</div>
                        </div>
                        <div class="multi-option" onclick="toggleEquipment('band')">
                            <div class="option-icon">ğŸ—ï¸</div>
                            <div class="option-label">å½ˆåŠ›å¸¶</div>
                        </div>
                        <div class="multi-option" onclick="toggleEquipment('kettlebell')">
                            <div class="option-icon">ğŸ””</div>
                            <div class="option-label">å£ºéˆ´</div>
                        </div>
                        <div class="multi-option" onclick="toggleEquipment('treadmill')">
                            <div class="option-icon">ğŸƒâ€â™‚ï¸</div>
                            <div class="option-label">è·‘æ­¥æ©Ÿ</div>
                        </div>
                        <div class="multi-option" onclick="toggleEquipment('bike')">
                            <div class="option-icon">ğŸš²</div>
                            <div class="option-label">é£›è¼ª/å¥èº«è»Š</div>
                        </div>
                        <div class="multi-option" onclick="toggleEquipment('gym')">
                            <div class="option-icon">ğŸ¢</div>
                            <div class="option-label">å¥èº«æˆ¿å™¨æ</div>
                        </div>
                    </div>
                </div>

                <div class="divider"></div>

                <div class="form-group">
                    <label>èº«é«”ç‹€æ³é™åˆ¶ <span class="optional-mark">(å¯è¤‡é¸ï¼Œè‹¥ç„¡å¯ä¸é¸)</span></label>
                    <div class="multi-select-grid">
                        <div class="multi-option" onclick="toggleLimitation('knee')">
                            <div class="option-icon">ğŸ¦µ</div>
                            <div class="option-label">è†è“‹ä¸é©</div>
                        </div>
                        <div class="multi-option" onclick="toggleLimitation('back')">
                            <div class="option-icon">ğŸ”™</div>
                            <div class="option-label">è…°èƒŒå•é¡Œ</div>
                        </div>
                        <div class="multi-option" onclick="toggleLimitation('shoulder')">
                            <div class="option-icon">ğŸ’ª</div>
                            <div class="option-label">è‚©é ¸å•é¡Œ</div>
                        </div>
                        <div class="multi-option" onclick="toggleLimitation('heart')">
                            <div class="option-icon">â¤ï¸</div>
                            <div class="option-label">å¿ƒè¡€ç®¡ç–¾ç—…</div>
                        </div>
                        <div class="multi-option" onclick="toggleLimitation('joint')">
                            <div class="option-icon">ğŸ¦´</div>
                            <div class="option-label">é—œç¯€ç‚</div>
                        </div>
                        <div class="multi-option" onclick="toggleLimitation('pregnancy')">
                            <div class="option-icon">ğŸ¤°</div>
                            <div class="option-label">æ‡·å­•/ç”¢å¾Œ</div>
                        </div>
                        <div class="multi-option" onclick="toggleLimitation('elderly')">
                            <div class="option-icon">ğŸ‘´</div>
                            <div class="option-label">å¹´é•·è€…</div>
                        </div>
                        <div class="multi-option" onclick="toggleLimitation('obesity')">
                            <div class="option-icon">âš–ï¸</div>
                            <div class="option-label">é«”é‡éé‡</div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="otherNotes">å…¶ä»–å‚™è¨» <span class="optional-mark">(é¸å¡«)</span></label>
                    <textarea id="otherNotes" placeholder="ä¾‹å¦‚ï¼šæœ‰èˆŠå‚·ã€ç‰¹æ®Šéœ€æ±‚ã€éæ•ç­‰..."></textarea>
                </div>

                <!-- é‹å‹•å»ºè­°é è¦½ -->
                <div class="exercise-preview" id="exercisePreview">
                    <h4>ğŸ¯ é‹å‹•å»ºè­°é è¦½</h4>
                    <div class="exercise-preview-content" id="exercisePreviewContent">
                        æ ¹æ“šæ‚¨å¡«å¯«çš„è³‡æ–™ï¼Œç³»çµ±å°‡ç‚ºæ‚¨ç”Ÿæˆå€‹äººåŒ–é‹å‹•å»ºè­°...
                    </div>
                </div>
            </div>

            <!-- æŒ‰éˆ•å€ -->
            <div class="btn-container">
                <button type="button" class="btn-prev" id="btnPrev" onclick="prevStep()" style="display: none;">
                    ä¸Šä¸€æ­¥
                </button>
                <button type="button" class="btn-next" id="btnNext" onclick="nextStep()">
                    ä¸‹ä¸€æ­¥
                </button>
                <button type="submit" class="btn-submit" id="btnSubmit" style="display: none;">
                    å®Œæˆè¨­å®š
                </button>
            </div>

            <button type="button" class="btn-skip" onclick="skipSetup()">
                æš«æ™‚è·³éï¼Œç¨å¾Œå†è¨­å®š
            </button>
        </form>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script>
        // Firebase é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyCk4GY-VkG4dd_zXP5HZQDlZbjdY0k0img",
            authDomain: "fooddata-92fa8.firebaseapp.com",
            projectId: "fooddata-92fa8",
            storageBucket: "fooddata-92fa8.firebasestorage.app",
            messagingSenderId: "459965557703",
            appId: "1:459965557703:web:6a16b3937935219eb887e2",
            measurementId: "G-R16CYV7QC2"
        };

        // åˆå§‹åŒ– Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // å…¨åŸŸè®Šæ•¸
        let currentStep = 1;
        const totalSteps = 4;

        // å¿…å¡«æ¬„ä½
        let selectedGender = null;
        let selectedGoal = null;

        // é¸å¡«æ¬„ä½ï¼ˆé‹å‹•ç›¸é—œï¼‰
        let selectedFrequency = null;
        let selectedExperience = null;
        let selectedTime = null;
        let selectedExerciseTypes = [];
        let selectedEquipment = [];
        let selectedLimitations = [];

        // æ­¥é©Ÿæ§åˆ¶
        function updateStepUI() {
            // æ›´æ–°è¡¨å–®å€å¡Šé¡¯ç¤º
            for (let i = 1; i <= totalSteps; i++) {
                const section = document.getElementById('step' + i);
                const dot = document.getElementById('step' + i + 'Dot');

                if (i === currentStep) {
                    section.classList.add('active');
                    dot.classList.add('active');
                    dot.classList.remove('completed');
                } else if (i < currentStep) {
                    section.classList.remove('active');
                    dot.classList.remove('active');
                    dot.classList.add('completed');
                } else {
                    section.classList.remove('active');
                    dot.classList.remove('active');
                    dot.classList.remove('completed');
                }
            }

            // æ›´æ–°æŒ‰éˆ•é¡¯ç¤º
            document.getElementById('btnPrev').style.display = currentStep > 1 ? 'block' : 'none';
            document.getElementById('btnNext').style.display = currentStep < totalSteps ? 'block' : 'none';
            document.getElementById('btnSubmit').style.display = currentStep === totalSteps ? 'block' : 'none';

            // æ›´æ–°é€²åº¦æ¢
            const progress = (currentStep / totalSteps) * 100;
            document.getElementById('progressFill').style.width = progress + '%';

            // ç¬¬å››æ­¥æ™‚æ›´æ–°é‹å‹•å»ºè­°é è¦½
            if (currentStep === 4) {
                updateExercisePreview();
            }
        }

        function nextStep() {
            // é©—è­‰å¿…å¡«æ¬„ä½
            if (currentStep === 1) {
                if (selectedGender === null) {
                    alert('è«‹é¸æ“‡æ€§åˆ¥');
                    return;
                }
                if (!document.getElementById('age').value) {
                    alert('è«‹å¡«å¯«å¹´é½¡');
                    return;
                }
                if (!document.getElementById('height').value) {
                    alert('è«‹å¡«å¯«èº«é«˜');
                    return;
                }
                if (!document.getElementById('weight').value) {
                    alert('è«‹å¡«å¯«é«”é‡');
                    return;
                }
            }

            if (currentStep === 2) {
                if (selectedGoal === null) {
                    alert('è«‹é¸æ“‡å¥åº·ç›®æ¨™');
                    return;
                }
                updateCalculations();
            }

            if (currentStep < totalSteps) {
                currentStep++;
                updateStepUI();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                currentStep--;
                updateStepUI();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        // é¸æ“‡æ€§åˆ¥
        function selectGender(isMale) {
            selectedGender = isMale;
            const cards = document.querySelectorAll('.gender-options .option-card');
            cards.forEach((card, index) => {
                if ((isMale && index === 0) || (!isMale && index === 1)) {
                    card.classList.add('selected');
                } else {
                    card.classList.remove('selected');
                }
            });
        }

        // é¸æ“‡ç›®æ¨™
        function selectGoal(goal) {
            selectedGoal = goal;
            const cards = document.querySelectorAll('.goal-options .option-card');
            cards.forEach((card, index) => {
                card.classList.toggle('selected', index === goal);
            });
            updateCalculations();
        }

        // é¸æ“‡é‹å‹•é »ç‡
        function selectFrequency(freq) {
            selectedFrequency = freq;
            const cards = document.querySelectorAll('.frequency-options .option-card');
            cards.forEach((card, index) => {
                card.classList.toggle('selected', index === freq);
            });
        }

        // é¸æ“‡é‹å‹•ç¶“é©—
        function selectExperience(exp) {
            selectedExperience = exp;
            const cards = document.querySelectorAll('.experience-options .option-card');
            cards.forEach((card, index) => {
                card.classList.toggle('selected', index === exp);
            });
        }

        // é¸æ“‡é‹å‹•æ™‚é–“
        function selectTime(time) {
            selectedTime = time;
            const cards = document.querySelectorAll('.time-options .option-card');
            cards.forEach((card, index) => {
                card.classList.toggle('selected', index === time);
            });
        }

        // åˆ‡æ›é‹å‹•é¡å‹ï¼ˆå¤šé¸ï¼‰
        function toggleExerciseType(type) {
            const index = selectedExerciseTypes.indexOf(type);
            if (index > -1) {
                selectedExerciseTypes.splice(index, 1);
            } else {
                selectedExerciseTypes.push(type);
            }
            updateMultiSelectUI('.form-group:has([onclick*="toggleExerciseType"]) .multi-option', selectedExerciseTypes, 'toggleExerciseType');
        }

        // åˆ‡æ›å™¨æï¼ˆå¤šé¸ï¼‰
        function toggleEquipment(equip) {
            const index = selectedEquipment.indexOf(equip);
            if (index > -1) {
                selectedEquipment.splice(index, 1);
            } else {
                selectedEquipment.push(equip);
            }
            updateMultiSelectUI('.form-group:has([onclick*="toggleEquipment"]) .multi-option', selectedEquipment, 'toggleEquipment');
        }

        // åˆ‡æ›èº«é«”é™åˆ¶ï¼ˆå¤šé¸ï¼‰
        function toggleLimitation(limit) {
            const index = selectedLimitations.indexOf(limit);
            if (index > -1) {
                selectedLimitations.splice(index, 1);
            } else {
                selectedLimitations.push(limit);
            }
            updateMultiSelectUI('.form-group:has([onclick*="toggleLimitation"]) .multi-option', selectedLimitations, 'toggleLimitation');
        }

        // æ›´æ–°å¤šé¸ UI
        function updateMultiSelectUI(selector, selectedArray, funcName) {
            const allOptions = document.querySelectorAll('.multi-option');
            allOptions.forEach(option => {
                const onclick = option.getAttribute('onclick');
                if (onclick && onclick.includes(funcName)) {
                    const match = onclick.match(/'([^']+)'/);
                    if (match) {
                        const value = match[1];
                        option.classList.toggle('selected', selectedArray.includes(value));
                    }
                }
            });
        }

        // è¨ˆç®— BMR
        function calculateBMR(age, height, weight, isMale) {
            if (isMale) {
                return 88.362 + (13.397 * weight) + (4.799 * height) - (5.677 * age);
            } else {
                return 447.593 + (9.247 * weight) + (3.098 * height) - (4.330 * age);
            }
        }

        // è¨ˆç®— TDEE
        function calculateTDEE(bmr, activityLevel) {
            const multipliers = {
                'sedentary': 1.2,
                'lightly_active': 1.375,
                'moderately_active': 1.55,
                'very_active': 1.725,
                'extra_active': 1.9
            };
            return bmr * (multipliers[activityLevel] || 1.55);
        }

        // è¨ˆç®—å»ºè­°ç†±é‡
        function calculateSuggestedCalories(tdee, goal) {
            let suggested;
            switch(goal) {
                case 1: // æ¸›é‡
                    suggested = tdee - 500;
                    break;
                case 2: // å¢è‚Œ
                    suggested = tdee + 300;
                    break;
                case 3: // æ”¹å–„å¥åº·
                    suggested = tdee - 200;
                    break;
                default: // ç¶­æŒ
                    suggested = tdee;
            }
            return Math.max(suggested, 1200);
        }

        // æ›´æ–°è¨ˆç®—çµæœ
        function updateCalculations() {
            const age = parseInt(document.getElementById('age').value);
            const height = parseFloat(document.getElementById('height').value);
            const weight = parseFloat(document.getElementById('weight').value);
            const activityLevel = document.getElementById('activityLevel').value;

            if (!age || !height || !weight || selectedGender === null || selectedGoal === null) {
                document.getElementById('calculatedValues').style.display = 'none';
                return;
            }

            const bmi = weight / Math.pow(height / 100, 2);
            const bmr = calculateBMR(age, height, weight, selectedGender);
            const tdee = calculateTDEE(bmr, activityLevel);
            const suggestedCalories = calculateSuggestedCalories(tdee, selectedGoal);

            // BMI è©•ä¼°
            let bmiStatus = '';
            if (bmi < 18.5) bmiStatus = '(éè¼•)';
            else if (bmi < 24) bmiStatus = '(æ­£å¸¸)';
            else if (bmi < 27) bmiStatus = '(éé‡)';
            else bmiStatus = '(è‚¥èƒ–)';

            document.getElementById('calculatedValues').style.display = 'block';
            document.getElementById('bmiValue').textContent = bmi.toFixed(1) + ' ' + bmiStatus;
            document.getElementById('bmrValue').textContent = Math.round(bmr) + ' å¤§å¡';
            document.getElementById('tdeeValue').textContent = Math.round(tdee) + ' å¤§å¡';
            document.getElementById('suggestedCalories').textContent = Math.round(suggestedCalories) + ' å¤§å¡';
        }

        // æ›´æ–°é‹å‹•å»ºè­°é è¦½
        function updateExercisePreview() {
            const preview = document.getElementById('exercisePreview');
            const content = document.getElementById('exercisePreviewContent');

            // æª¢æŸ¥æ˜¯å¦æœ‰å¡«å¯«é‹å‹•ç›¸é—œè³‡æ–™
            const hasExerciseData = selectedFrequency !== null ||
                                     selectedExperience !== null ||
                                     selectedTime !== null ||
                                     selectedExerciseTypes.length > 0;

            if (!hasExerciseData) {
                preview.classList.remove('show');
                return;
            }

            preview.classList.add('show');

            // ç”Ÿæˆç°¡å–®çš„é è¦½æ–‡å­—
            let previewText = 'æ ¹æ“šæ‚¨çš„è³‡æ–™ï¼Œç³»çµ±å°‡æ¨è–¦ï¼š\n\n';

            // é »ç‡å»ºè­°
            const freqLabels = ['å»ºè­°å¾æ¯é€±1-2æ¬¡é–‹å§‹', 'å¯ç¶­æŒç›®å‰é »ç‡æˆ–å¢åŠ è‡³æ¯é€±3æ¬¡', 'å¾ˆå¥½çš„é‹å‹•ç¿’æ…£ï¼Œå»ºè­°ç¶­æŒ', 'æ³¨æ„é©ç•¶ä¼‘æ¯èˆ‡æ¢å¾©'];
            if (selectedFrequency !== null) {
                previewText += 'â€¢ ' + freqLabels[selectedFrequency] + '\n';
            }

            // æ™‚é–“å»ºè­°
            const timeLabels = ['çŸ­æ™‚é–“é«˜æ•ˆè¨“ç·´', 'æ¨™æº–è¨“ç·´æ™‚é•·', 'å……è¶³çš„è¨“ç·´æ™‚é–“', 'å¯å®‰æ’å®Œæ•´è¨“ç·´è¨ˆç•«'];
            if (selectedTime !== null) {
                previewText += 'â€¢ ' + timeLabels[selectedTime] + '\n';
            }

            // é‹å‹•é¡å‹
            if (selectedExerciseTypes.length > 0) {
                const typeNames = {
                    'cardio': 'æœ‰æ°§', 'strength': 'é‡è¨“', 'hiit': 'HIIT',
                    'yoga': 'ç‘œä¼½', 'swimming': 'æ¸¸æ³³', 'cycling': 'é¨è»Š',
                    'ball': 'çƒé¡', 'outdoor': 'æˆ¶å¤–', 'home': 'å±…å®¶', 'dance': 'èˆè¹ˆ'
                };
                const types = selectedExerciseTypes.map(t => typeNames[t]).join('ã€');
                previewText += 'â€¢ åå¥½é‹å‹•ï¼š' + types + '\n';
            }

            // èº«é«”é™åˆ¶
            if (selectedLimitations.length > 0) {
                previewText += 'â€¢ å°‡é¿å…å¯èƒ½é€ æˆè² æ“”çš„å‹•ä½œ\n';
            }

            previewText += '\nå®Œæˆè¨­å®šå¾Œï¼Œå¯åœ¨ä¸»é æŸ¥çœ‹å®Œæ•´çš„å€‹äººåŒ–é‹å‹•å»ºè­°ã€‚';

            content.textContent = previewText;
        }

        // è¡¨å–®æäº¤
        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const submitBtn = document.getElementById('btnSubmit');
            submitBtn.disabled = true;
            submitBtn.textContent = 'å„²å­˜ä¸­...';

            try {
                const user = auth.currentUser;
                if (!user) {
                    throw new Error('è«‹å…ˆç™»å…¥');
                }

                const age = parseInt(document.getElementById('age').value);
                const height = parseFloat(document.getElementById('height').value);
                const weight = parseFloat(document.getElementById('weight').value);
                const activityLevel = document.getElementById('activityLevel').value;
                const otherNotes = document.getElementById('otherNotes').value.trim();

                // è¨ˆç®—æ•¸å€¼
                const bmi = weight / Math.pow(height / 100, 2);
                const bmr = calculateBMR(age, height, weight, selectedGender);
                const tdee = calculateTDEE(bmr, activityLevel);
                const suggestedCalories = calculateSuggestedCalories(tdee, selectedGoal);
                const targetProtein = (suggestedCalories * 0.3) / 4;
                const targetCarbs = (suggestedCalories * 0.45) / 4;
                const targetFat = (suggestedCalories * 0.25) / 9;

                // çµ„åˆè³‡æ–™
                const profileData = {
                    // åŸºæœ¬è³‡æ–™ï¼ˆå¿…å¡«ï¼‰
                    age: age,
                    gender: selectedGender,
                    height: height,
                    weight: weight,
                    goal: selectedGoal,
                    activityLevel: activityLevel,

                    // è¨ˆç®—æ•¸å€¼
                    BMI: parseFloat(bmi.toFixed(1)),
                    BMR: Math.round(bmr),
                    TDEE_level: Math.round(tdee),
                    suggested_calories: Math.round(suggestedCalories),

                    // ç‡Ÿé¤Šç›®æ¨™
                    targetCalories: Math.round(suggestedCalories),
                    targetProtein: Math.round(targetProtein),
                    targetCarbs: Math.round(targetCarbs),
                    targetFat: Math.round(targetFat),

                    // é‹å‹•ç›¸é—œï¼ˆé¸å¡«ï¼‰
                    exerciseFrequency: selectedFrequency,
                    exerciseExperience: selectedExperience,
                    exerciseTimePerSession: selectedTime,
                    preferredExerciseTypes: selectedExerciseTypes,
                    availableEquipment: selectedEquipment,
                    physicalLimitations: selectedLimitations,
                    otherNotes: otherNotes,

                    // æ¨™è¨˜æ˜¯å¦æœ‰å¡«å¯«é‹å‹•è³‡æ–™
                    hasExerciseProfile: selectedFrequency !== null ||
                                        selectedExperience !== null ||
                                        selectedTime !== null ||
                                        selectedExerciseTypes.length > 0,

                    // æ™‚é–“æˆ³è¨˜
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                // å„²å­˜åˆ° Firestore
                await db.collection('member').doc(user.uid).set(profileData, { merge: true });

                console.log('[OK] å€‹äººè³‡æ–™å„²å­˜æˆåŠŸ');
                alert('å€‹äººè³‡æ–™è¨­å®šå®Œæˆï¼');

                // è·³è½‰åˆ°é¦–é 
                window.location.href = 'dashboard.html';

            } catch (error) {
                console.error('[ERROR] å„²å­˜å¤±æ•—:', error);
                alert('å„²å­˜å¤±æ•—ï¼š' + error.message);
                submitBtn.disabled = false;
                submitBtn.textContent = 'å®Œæˆè¨­å®š';
            }
        });

        // è·³éè¨­å®š
        function skipSetup() {
            if (confirm('ç¢ºå®šè¦è·³éå€‹äººè³‡æ–™è¨­å®šå—ï¼Ÿ\n\néƒ¨åˆ†åŠŸèƒ½éœ€è¦å®Œæ•´è³‡æ–™æ‰èƒ½ä½¿ç”¨ã€‚')) {
                window.location.href = 'dashboard.html';
            }
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            updateStepUI();

            // ç›£è½è¼¸å…¥è®ŠåŒ–æ›´æ–°è¨ˆç®—
            ['age', 'height', 'weight'].forEach(id => {
                document.getElementById(id).addEventListener('input', updateCalculations);
            });
            document.getElementById('activityLevel').addEventListener('change', updateCalculations);
        });

        // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
        auth.onAuthStateChanged((user) => {
            if (!user) {
                alert('è«‹å…ˆç™»å…¥');
                window.location.href = 'login.html';
            }
        });
    </script>
</body>
</html>

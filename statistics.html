<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <!-- æ·±è‰²æ¨¡å¼ï¼ˆå…§è¯è…³æœ¬+æ¨£å¼ï¼Œé¿å…é–ƒçˆï¼‰ -->
    <script>try{var s=JSON.parse(localStorage.getItem('bentoai_settings')||'{}');if(s.darkMode){document.documentElement.classList.add('dark-mode')}else{document.documentElement.classList.remove('dark-mode')}}catch(e){document.documentElement.classList.remove('dark-mode')}</script>
    <style>html.dark-mode,html.dark-mode body{background:linear-gradient(135deg,#1a1a2e 0%,#16213e 100%)!important}html.dark-mode .bottom-nav{background:#1a1a2e!important;border-top:1px solid #2a2a3e}html.dark-mode .nav-item{color:#888!important}html.dark-mode .container,html.dark-mode .header,html.dark-mode .section,html.dark-mode .form-section,html.dark-mode .form-group,html.dark-mode .settings-section,html.dark-mode .settings-item,html.dark-mode .user-card,html.dark-mode .user-header,html.dark-mode .user-info,html.dark-mode .profile-item,html.dark-mode .profile-grid,html.dark-mode .profile-panel,html.dark-mode .option-card,html.dark-mode .feature-card,html.dark-mode .stat-card,html.dark-mode .summary-item,html.dark-mode .nutrition-item,html.dark-mode .nutrition-card,html.dark-mode .chart-container,html.dark-mode .chart-section,html.dark-mode .insight-card,html.dark-mode .tips-card,html.dark-mode .recent-card,html.dark-mode .card,html.dark-mode .chat-container,html.dark-mode .chat-header,html.dark-mode .chat-messages,html.dark-mode .chat-input-area,html.dark-mode .quick-questions,html.dark-mode .welcome-message,html.dark-mode .edit-form,html.dark-mode .stats-grid,html.dark-mode .loading,html.dark-mode .step,html.dark-mode .total-item,html.dark-mode .input-wrapper,html.dark-mode .options-grid,html.dark-mode .multi-option,html.dark-mode .tech-item,html.dark-mode .empty-state,html.dark-mode .filter-btn,html.dark-mode .time-selector,html.dark-mode .controls,html.dark-mode .record-card,html.dark-mode .meal-section,html.dark-mode .food-item,html.dark-mode .modal-content,html.dark-mode .upload-area,html.dark-mode .result-card,html.dark-mode .analysis-card{background:#1e1e2e!important;color:#e0e0e0!important}html.dark-mode input,html.dark-mode select,html.dark-mode textarea{background:#2a2a3e!important;color:#e0e0e0!important;border-color:#3a3a4e!important}html.dark-mode .btn-secondary{background:#3a3a4e!important;color:#e0e0e0!important}</style>
    <meta charset="UTF-8">
    <script src="/js/dark-mode.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <title>é£²é£Ÿçµ±è¨ˆåˆ†æ - ç‡Ÿé¤Šè¿½è¹¤ç³»çµ±</title>
    <!-- PWA æ”¯æ´ -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="å¥åº·åŠ©ç†">
    <link rel="apple-touch-icon" href="logo.png">
    <link rel="icon" href="logo.png" type="image/png">
    <!-- PWA å„ªåŒ–æ¨£å¼ -->
    <link rel="stylesheet" href="/css/pwa.css">
    <!-- PWA å®‰è£æç¤º -->
    <script src="/js/pwa-install.js" defer></script>
    <script src="/js/pwa-utils.js" defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* é é¢æ¨™é¡Œ */
        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header h1 {
            color: #667eea;
            font-size: 2.5em;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-logo {
            width: 45px;
            height: 45px;
            object-fit: contain;
        }

        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .time-selector {
            display: flex;
            gap: 10px;
        }

        .time-btn {
            padding: 10px 20px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .time-btn:hover, .time-btn.active {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1em;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        /* ç”¨æˆ¶è³‡è¨Š */
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 3px solid #667eea;
        }

        /* è¼‰å…¥ä¸­ */
        .loading {
            text-align: center;
            padding: 60px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .loading p {
            font-size: 1.3em;
            color: #667eea;
            margin-top: 20px;
        }

        /* ç¸½é«”çµ±è¨ˆå¡ç‰‡ */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }

        .stat-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 1.1em;
            color: #666;
        }

        /* åœ–è¡¨å€åŸŸ */
        .charts-grid {
            display: flex;
            flex-direction: column;
            gap: 30px;
            margin-bottom: 30px;
        }

        .charts-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 30px;
        }

        .chart-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            min-height: 450px;
            display: flex;
            flex-direction: column;
        }

        .chart-container.full-width {
            grid-column: 1 / -1;
        }

        .chart-container h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }

        .chart-wrapper {
            position: relative;
            flex: 1;
            min-height: 300px;
            width: 100%;
        }

        .chart-note {
            margin-top: 15px;
            font-size: 0.9em;
            color: #666;
            flex-shrink: 0;
        }

        /* ç©ºç‹€æ…‹ */
        .empty-state {
            text-align: center;
            padding: 60px 30px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
            animation: floatEmoji 3s ease-in-out infinite;
        }

        @keyframes floatEmoji {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .empty-state h2 {
            color: #667eea;
            font-size: 1.8em;
            margin-bottom: 15px;
        }

        .empty-state p {
            color: #666;
            font-size: 1.1em;
            margin-bottom: 25px;
            line-height: 1.6;
        }

        .empty-state-tips {
            background: #f8f9ff;
            border-radius: 12px;
            padding: 20px;
            margin-top: 25px;
            text-align: left;
        }

        .empty-state-tips h4 {
            color: #667eea;
            font-size: 14px;
            margin-bottom: 12px;
        }

        .empty-state-tips ul {
            margin: 0;
            padding-left: 20px;
            color: #666;
            font-size: 13px;
        }

        .empty-state-tips li {
            margin-bottom: 8px;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ - å¹³æ¿ */
        @media (max-width: 1200px) {
            .charts-row {
                grid-template-columns: 1fr;
            }

            .chart-container {
                min-height: 400px;
            }
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ - æ‰‹æ©Ÿ */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .header {
                flex-direction: column;
                text-align: center;
                padding: 20px;
            }

            .header h1 {
                font-size: 1.5em;
            }

            .controls {
                flex-direction: column;
                width: 100%;
            }

            .time-selector {
                justify-content: center;
                flex-wrap: wrap;
            }

            .time-btn {
                padding: 8px 15px;
                font-size: 0.9em;
            }

            .user-info {
                flex-wrap: wrap;
                justify-content: center;
            }

            .btn {
                padding: 10px 15px;
                font-size: 0.85em;
            }

            .summary-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .stat-card {
                padding: 15px;
            }

            .stat-icon {
                font-size: 2em;
            }

            .stat-value {
                font-size: 1.8em;
            }

            .stat-label {
                font-size: 0.9em;
            }

            .charts-grid {
                gap: 20px;
            }

            .chart-container {
                padding: 15px;
                min-height: 350px;
            }

            .chart-container h2 {
                font-size: 1.2em;
            }

            .chart-wrapper {
                min-height: 250px;
            }
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ - å°æ‰‹æ©Ÿ */
        @media (max-width: 480px) {
            .summary-grid {
                grid-template-columns: 1fr;
            }

            .stat-card {
                padding: 12px;
            }

            .stat-value {
                font-size: 1.5em;
            }

            .chart-container {
                min-height: 320px;
            }

            .chart-wrapper {
                min-height: 220px;
            }
        }

        /* ===== åº•éƒ¨å°èˆªæ¬„ ===== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 8px 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: #666;
            font-size: 12px;
            padding: 5px 10px;
            border-radius: 10px;
            transition: all 0.3s;
            min-width: 60px;
        }

        .nav-item:hover {
            background: #f0f4ff;
            color: #667eea;
        }

        .nav-item.active {
            color: #667eea;
        }

        .nav-item.active .nav-icon {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .nav-icon {
            font-size: 20px;
            margin-bottom: 3px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            transition: all 0.3s;
        }

        .nav-label {
            font-weight: 500;
        }

        /* ç‚ºåº•éƒ¨å°èˆªç•™å‡ºç©ºé–“ */
        body {
            padding-bottom: 80px;
        }

        /* æ‰‹æ©Ÿç‰ˆåº•éƒ¨å°èˆªå„ªåŒ– */
        @media (max-width: 480px) {
            .nav-item-stat {
                font-size: 10px;
                padding: 5px 5px;
                min-width: 50px;
            }

            .nav-icon {
                font-size: 18px;
                width: 35px;
                height: 35px;
            }

            .bottom-nav {
                padding: 5px 0;
            }
        }

        /* æ·±è‰²æ¨¡å¼ */
        html.dark-mode {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }

        html.dark-mode .header {
            background: #1e1e1e;
        }

        html.dark-mode .header h1 {
            color: #667eea;
        }

        html.dark-mode .header p {
            color: #888 !important;
        }

        html.dark-mode .time-btn {
            background: #2a2a2a;
            border-color: #667eea;
            color: #667eea;
        }

        html.dark-mode .time-btn:hover,
        html.dark-mode .time-btn.active {
            background: #667eea;
            color: white;
        }

        html.dark-mode .btn-secondary {
            background: #444;
        }

        html.dark-mode .btn-secondary:hover {
            background: #555;
        }

        html.dark-mode .stat-card {
            background: #1e1e1e;
        }

        html.dark-mode .stat-value {
            color: #667eea;
        }

        html.dark-mode .stat-label {
            color: #aaa;
        }

        html.dark-mode .chart-container {
            background: #1e1e1e;
        }

        html.dark-mode .chart-container h2 {
            color: #667eea;
        }

        html.dark-mode .chart-note {
            color: #888;
        }

        html.dark-mode .chart-note p {
            color: #888;
        }

        html.dark-mode .loading {
            background: #1e1e1e;
        }

        html.dark-mode .loading p {
            color: #667eea;
        }

        html.dark-mode .empty-state {
            background: #1e1e1e;
        }

        html.dark-mode .empty-state h2 {
            color: #667eea;
        }

        html.dark-mode .empty-state p {
            color: #888;
        }

        html.dark-mode .empty-state-tips {
            background: #2a2a2a;
        }

        html.dark-mode .empty-state-tips h4 {
            color: #a0a0ff;
        }

        html.dark-mode .empty-state-tips ul {
            color: #888;
        }

        html.dark-mode #userName {
            color: #e0e0e0;
        }

        html.dark-mode .bottom-nav {
            background: #1e1e1e;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
        }

        html.dark-mode .nav-item {
            color: #888;
        }

        html.dark-mode .nav-item:hover,
        html.dark-mode .nav-item.active {
            color: #667eea;
        }

        /* AI æ´å¯Ÿå¡ç‰‡æ¨£å¼ */
        .insight-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 25px;
            color: white;
            margin-bottom: 30px;
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
        }

        .insight-card::after {
            content: '';
            position: absolute;
            top: -50px;
            right: -50px;
            width: 150px;
            height: 150px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
        }

        .insight-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .insight-icon {
            font-size: 2em;
            background: rgba(255,255,255,0.2);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .insight-title {
            font-size: 1.4em;
            font-weight: bold;
        }

        .insight-content {
            font-size: 1.1em;
            line-height: 1.6;
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            backdrop-filter: blur(5px);
        }

        .insight-content strong {
            color: #ffd700;
        }

        .insight-loading {
            display: flex;
            align-items: center;
            gap: 10px;
            font-style: italic;
            opacity: 0.8;
        }

        html.dark-mode .insight-card {
            background: linear-gradient(135deg, #4a3b89 0%, #2d2b55 100%);
        }

        /* AI å¥åº·é€±å ± Markdown å…§å®¹æ¨£å¼ */
        .insight-content h1,
        .insight-content h2,
        .insight-content h3 {
            color: #ffd700;
            margin: 15px 0 10px 0;
            font-weight: bold;
        }

        .insight-content h1 { font-size: 1.3em; }
        .insight-content h2 { font-size: 1.2em; }
        .insight-content h3 { font-size: 1.1em; }

        .insight-content p {
            margin: 10px 0;
            line-height: 1.8;
        }

        .insight-content ul,
        .insight-content ol {
            margin: 10px 0 10px 20px;
            padding-left: 10px;
        }

        .insight-content li {
            margin: 8px 0;
            line-height: 1.7;
        }

        .insight-content strong,
        .insight-content b {
            color: #ffd700;
            font-weight: bold;
        }

        .insight-content em {
            font-style: italic;
            color: #e0e0e0;
        }

        /* æ‰‹æ©Ÿç‰ˆ AI é€±å ±å„ªåŒ– */
        @media (max-width: 768px) {
            .insight-card {
                padding: 15px;
                margin-bottom: 20px;
            }

            .insight-header {
                gap: 10px;
                margin-bottom: 12px;
            }

            .insight-icon {
                font-size: 1.5em;
                width: 40px;
                height: 40px;
            }

            .insight-title {
                font-size: 1.2em;
            }

            .insight-content {
                font-size: 0.95em;
                padding: 12px;
                line-height: 1.6;
            }

            .insight-content h1 { font-size: 1.15em; }
            .insight-content h2 { font-size: 1.1em; }
            .insight-content h3 { font-size: 1.05em; }

            .insight-content ul,
            .insight-content ol {
                margin: 8px 0 8px 15px;
                padding-left: 5px;
            }

            .insight-content li {
                margin: 6px 0;
                line-height: 1.6;
            }
        }

        /* å°æ‰‹æ©Ÿç‰ˆ AI é€±å ±å„ªåŒ– */
        @media (max-width: 480px) {
            .insight-card {
                padding: 12px;
            }

            .insight-content {
                font-size: 0.9em;
                padding: 10px;
            }

            .insight-content ul,
            .insight-content ol {
                margin-left: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- é é¢æ¨™é¡Œ -->
        <div class="header">
            <div>
                <h1><img src="logo.png" alt="Logo" class="header-logo">é£²é£Ÿçµ±è¨ˆåˆ†æ</h1>
                <p style="color: #666; margin-top: 10px;">è¿½è¹¤æ‚¨çš„é£²é£Ÿç¿’æ…£ï¼Œé‚å‘å¥åº·ç”Ÿæ´»</p>
            </div>
            <div class="controls">
                <div class="time-selector">
                    <button class="time-btn" data-days="7">7 å¤©</button>
                    <button class="time-btn active" data-days="30">30 å¤©</button>
                    <button class="time-btn" data-days="90">90 å¤©</button>
                </div>
                <div class="user-info">
                    <img id="userAvatar" class="user-avatar" style="display: none;">
                    <span id="userName"></span>
                    <button class="btn btn-primary" onclick="fixNutritionData()">ğŸ”§ ä¿®å¾©è³‡æ–™</button>
                    <button class="btn btn-secondary" onclick="window.location.href='dashboard.html'">è¿”å›ä¸»é </button>
                    <button class="btn btn-secondary" onclick="window.location.href='diet_records.html'">é£²é£Ÿè¨˜éŒ„</button>
                </div>
            </div>
        </div>

        <!-- è¼‰å…¥ä¸­ -->
        <div id="loading" class="loading">
            <p>â³ è¼‰å…¥çµ±è¨ˆè³‡æ–™ä¸­...</p>
        </div>

        <!-- ç©ºç‹€æ…‹ -->
        <div id="emptyState" class="empty-state" style="display: none;">
            <div class="empty-state-icon">ğŸ“Š</div>
            <h2>é–‹å§‹è¿½è¹¤æ‚¨çš„ç‡Ÿé¤Šæ”å–</h2>
            <p>è¨˜éŒ„å¹¾é¤é£²é£Ÿå¾Œï¼Œé€™è£¡å°‡é¡¯ç¤ºç²¾ç¾çš„çµ±è¨ˆåœ–è¡¨<br>å¹«åŠ©æ‚¨äº†è§£ç‡Ÿé¤Šæ”å–è¶¨å‹¢ï¼</p>
            <button class="btn btn-primary" onclick="window.location.href='food-detect.html'">
                ğŸ“¸ æ‹ç…§è¨˜éŒ„ç¬¬ä¸€é¤
            </button>
            <div class="empty-state-tips">
                <h4>ğŸ’¡ çµ±è¨ˆåŠŸèƒ½åŒ…å«</h4>
                <ul>
                    <li>æ¯æ—¥/æ¯é€±ç‡Ÿé¤Šæ”å–è¶¨å‹¢åœ–</li>
                    <li>ç†±é‡ã€è›‹ç™½è³ªã€è„‚è‚ªã€ç¢³æ°´åˆ†å¸ƒ</li>
                    <li>AI å€‹äººåŒ–å¥åº·é€±å ±åˆ†æ</li>
                    <li>é¤é»é¡å‹åˆ†å¸ƒçµ±è¨ˆ</li>
                </ul>
            </div>
        </div>

        <!-- ç¸½é«”çµ±è¨ˆ -->
        <div id="summarySection" style="display: none;">
            <!-- AI å¥åº·é€±å ± -->
            <div class="insight-card" id="aiInsightCard" style="display: none;">
                <div class="insight-header">
                    <div class="insight-icon">ğŸ¤–</div>
                    <div class="insight-title">AI å¥åº·é€±å ±</div>
                </div>
                <div class="insight-content" id="aiInsightContent">
                    <div class="insight-loading">
                        <span>âœ¨</span> AI æ­£åœ¨åˆ†ææ‚¨çš„é£²é£Ÿæ•¸æ“š...
                    </div>
                </div>
            </div>

            <div class="summary-grid">
                <div class="stat-card">
                    <div class="stat-icon">ğŸ”¥</div>
                    <div class="stat-value" id="avgCalories">0</div>
                    <div class="stat-label">å¹³å‡æ¯æ—¥ç†±é‡ (å¤§å¡)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">ğŸ½ï¸</div>
                    <div class="stat-value" id="avgMeals">0</div>
                    <div class="stat-label">å¹³å‡æ¯æ—¥é¤æ¬¡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">ğŸ“…</div>
                    <div class="stat-value" id="totalDays">0</div>
                    <div class="stat-label">æœ‰è¨˜éŒ„çš„å¤©æ•¸</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">ğŸ¥—</div>
                    <div class="stat-value" id="uniqueFoods">0</div>
                    <div class="stat-label">ä¸åŒé£Ÿç‰©ç¨®é¡</div>
                </div>
            </div>

            <!-- åœ–è¡¨å€åŸŸ -->
            <div class="charts-grid">
                <!-- æ¯æ—¥ç†±é‡è¶¨å‹¢ (å…¨å¯¬) -->
                <div class="chart-container">
                    <h2>ğŸ“ˆ æ¯æ—¥ç†±é‡è¶¨å‹¢</h2>
                    <div class="chart-wrapper">
                        <div id="caloriesTrendChart"></div>
                    </div>
                </div>

                <!-- ç¬¬ä¸€æ’ï¼šç‡Ÿé¤Šç´ å æ¯” + é£Ÿç‰©é »ç‡ -->
                <div class="charts-row">
                    <div class="chart-container">
                        <h2>ğŸ¥™ ä¸‰å¤§ç‡Ÿé¤Šç´ ç†±é‡å æ¯”</h2>
                        <div class="chart-wrapper">
                            <div id="nutrientPieChart"></div>
                        </div>
                        <div class="chart-note">
                            <p>å»ºè­°æ¯”ä¾‹ï¼šè›‹ç™½è³ª 15-20%ï¼Œè„‚è‚ª 20-30%ï¼Œç¢³æ°´ 50-60%</p>
                        </div>
                    </div>

                    <div class="chart-container">
                        <h2>ğŸ† æœ€å¸¸é£Ÿç”¨çš„é£Ÿç‰©</h2>
                        <div class="chart-wrapper">
                            <div id="foodFrequencyChart"></div>
                        </div>
                    </div>
                </div>

                <!-- ä¸‰å¤§ç‡Ÿé¤Šç´ æ”å–é‡è¶¨å‹¢ (å…¨å¯¬) -->
                <div class="chart-container">
                    <h2>ğŸ“Š ä¸‰å¤§ç‡Ÿé¤Šç´ æ”å–è¶¨å‹¢</h2>
                    <div class="chart-wrapper">
                        <div id="macrosTrendChart"></div>
                    </div>
                </div>

                <!-- ç¬¬äºŒæ’ï¼šçº–ç¶­ + éˆ‰ -->
                <div class="charts-row">
                    <div class="chart-container">
                        <h2>ğŸŒ¾ è†³é£Ÿçº–ç¶­æ”å–</h2>
                        <div class="chart-wrapper">
                            <div id="fiberChart"></div>
                        </div>
                        <div class="chart-note">
                            <p>å»ºè­°æ”å–é‡ï¼š25-35 å…‹/å¤©</p>
                        </div>
                    </div>

                    <div class="chart-container">
                        <h2>ğŸ§‚ éˆ‰æ”å–ç›£æ§</h2>
                        <div class="chart-wrapper">
                            <div id="sodiumChart"></div>
                        </div>
                        <div class="chart-note">
                            <p>å»ºè­°æ”å–é‡ï¼š&lt;2300 æ¯«å…‹/å¤©</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨å°èˆªæ¬„ -->
    <nav class="bottom-nav">
        <a href="dashboard.html" class="nav-item">
            <div class="nav-icon">ğŸ </div>
            <span class="nav-label">é¦–é </span>
        </a>
        <a href="diet_records.html" class="nav-item">
            <div class="nav-icon">ğŸ½ï¸</div>
            <span class="nav-label">è¨˜éŒ„</span>
        </a>
        <a href="food-detect.html" class="nav-item">
            <div class="nav-icon">ğŸ“·</div>
            <span class="nav-label">è¾¨è­˜</span>
        </a>
        <a href="statistics.html" class="nav-item active">
            <div class="nav-icon">ğŸ“Š</div>
            <span class="nav-label">çµ±è¨ˆ</span>
        </a>
        <a href="chat.html" class="nav-item">
            <div class="nav-icon">ğŸ’¬</div>
            <span class="nav-label">è«®è©¢</span>
        </a>
        <a href="exercise.html" class="nav-item">
            <div class="nav-icon">ğŸƒ</div>
            <span class="nav-label">é‹å‹•</span>
        </a>
        <a href="settings.html" class="nav-item">
            <div class="nav-icon">âš™ï¸</div>
            <span class="nav-label">è¨­å®š</span>
        </a>
    </nav>

    <!-- å…±ç”¨å·¥å…·å‡½æ•¸ -->
    <script src="/js/utils.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        // Firebase é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyCk4GY-VkG4dd_zXP5HZQDlZbjdY0k0img",
            authDomain: "fooddata-92fa8.firebaseapp.com",
            projectId: "fooddata-92fa8",
            storageBucket: "fooddata-92fa8.firebasestorage.app",
            messagingSenderId: "459965557703",
            appId: "1:459965557703:web:6a16b3937935219eb887e2",
            measurementId: "G-R16CYV7QC2"
        };

        // åˆå§‹åŒ– Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        let currentUser = null;
        let hasCheckedAuth = false;
        let currentDays = 30;

        // API åŸºç¤ URLï¼ˆæœ¬åœ°æ¸¬è©¦ç”¨ localhostï¼Œæ­£å¼ç’°å¢ƒç”¨ Cloud Runï¼‰
        const API_BASE = window.location.hostname === 'localhost'
            ? 'http://localhost:8080'
            : 'https://bentoai-api-278768520764.asia-east1.run.app';

        // ä¿®å¾©ç‡Ÿé¤Šè³‡æ–™
        async function fixNutritionData() {
            if (!currentUser) {
                alert('è«‹å…ˆç™»å…¥');
                return;
            }

            if (!confirm('é€™å°‡æœƒä¿®å¾©æ‰€æœ‰ç¼ºå°‘ç‡Ÿé¤Šè³‡æ–™çš„è¨˜éŒ„ã€‚æ˜¯å¦ç¹¼çºŒï¼Ÿ')) {
                return;
            }

            try {
                console.log('[ä¿®å¾©] é–‹å§‹ä¿®å¾©ç‡Ÿé¤Šè³‡æ–™...');
                const idToken = await currentUser.getIdToken();

                const response = await fetch(`${API_BASE}/api/fix-nutrition-data`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${idToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                console.log('[ä¿®å¾©] ä¿®å¾©çµæœ:', data);

                if (data.success) {
                    // å¦‚æœç„¡éœ€ä¿®å¾©ï¼ˆä¿®å¾©æ•¸é‡ç‚º 0ï¼‰ï¼Œæ¸…ç©ºå¿«å–ä¸¦å¼·åˆ¶é‡æ–°æ•´ç†
                    if (data.fixed_count === 0) {
                        alert(`ç„¡éœ€ä¿®å¾©ï¼\næ‰€æœ‰è³‡æ–™çš†æ­£å¸¸\n\nå°‡æ¸…ç©ºå¿«å–ä¸¦å¼·åˆ¶é‡æ–°æ•´ç†é é¢...`);

                        // æ¸…ç©ºå¿«å–
                        if ('caches' in window) {
                            caches.keys().then(names => {
                                names.forEach(name => caches.delete(name));
                            });
                        }

                        // å¼·åˆ¶é‡æ–°æ•´ç†ï¼ˆç›¸ç•¶æ–¼ Ctrl+Shift+Rï¼‰
                        setTimeout(() => {
                            window.location.reload(true);
                        }, 1000);
                    } else {
                        // æœ‰ä¿®å¾©è³‡æ–™ï¼Œé¡¯ç¤ºçµæœä¸¦é‡æ–°è¼‰å…¥
                        alert(`ä¿®å¾©å®Œæˆï¼\næˆåŠŸ: ${data.fixed_count} ç­†\nå¤±æ•—: ${data.error_count} ç­†\nè·³é: ${data.skipped_count} ç­†`);

                        // é‡æ–°è¼‰å…¥çµ±è¨ˆè³‡æ–™
                        await loadStatistics(currentDays);
                    }
                } else {
                    alert('ä¿®å¾©å¤±æ•—: ' + (data.error || 'Unknown error'));
                }

            } catch (error) {
                console.error('[ä¿®å¾©] éŒ¯èª¤:', error);
                alert('ä¿®å¾©å¤±æ•—: ' + error.message);
            }
        }

        // ç›£è½ç™»å…¥ç‹€æ…‹
        auth.onAuthStateChanged(async (user) => {
            if (hasCheckedAuth) return;
            hasCheckedAuth = true;

            if (user) {
                console.log('[çµ±è¨ˆ] ç”¨æˆ¶å·²ç™»å…¥:', user.email);
                currentUser = user;

                // æ›´æ–°ç”¨æˆ¶è³‡è¨Š
                document.getElementById('userName').textContent = user.displayName || user.email;
                if (user.photoURL) {
                    const avatar = document.getElementById('userAvatar');
                    avatar.src = user.photoURL;
                    avatar.style.display = 'block';
                }

                // è¼‰å…¥çµ±è¨ˆè³‡æ–™
                await loadStatistics(currentDays);
            } else {
                console.log('[çµ±è¨ˆ] æœªç™»å…¥ï¼Œå°å‘ç™»å…¥é ');
                alert('è«‹å…ˆç™»å…¥');
                window.location.href = 'login.html';
            }
        });

        // æ™‚é–“é¸æ“‡å™¨
        document.querySelectorAll('.time-btn').forEach(btn => {
            btn.addEventListener('click', async function() {
                document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');

                currentDays = parseInt(this.dataset.days);
                await loadStatistics(currentDays);
            });
        });

        // è¼‰å…¥çµ±è¨ˆè³‡æ–™
        async function loadStatistics(days = 30) {
            console.log(`[çµ±è¨ˆ] è¼‰å…¥æœ€è¿‘ ${days} å¤©çš„çµ±è¨ˆè³‡æ–™`);

            document.getElementById('loading').style.display = 'block';
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('summarySection').style.display = 'none';

            try {
                const idToken = await currentUser.getIdToken();

                // æ·»åŠ æ™‚é–“æˆ³é¿å…ç€è¦½å™¨å¿«å–ï¼Œç¢ºä¿æ¯æ¬¡ F5 åˆ·æ–°éƒ½èƒ½ç²å–æœ€æ–°æ•¸æ“š
                const timestamp = new Date().getTime();
                const response = await fetch(`${API_BASE}/api/statistics?days=${days}&t=${timestamp}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${idToken}`,
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    },
                    cache: 'no-store'
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                console.log('[çµ±è¨ˆ] çµ±è¨ˆè³‡æ–™:', data);
                console.log('[çµ±è¨ˆ] Summary:', data.summary);
                console.log('[çµ±è¨ˆ] Daily Trend ç­†æ•¸:', data.daily_trend ? data.daily_trend.length : 0);
                console.log('[çµ±è¨ˆ] Daily Trend ç¯„ä¾‹ (å‰5ç­†):', data.daily_trend ? data.daily_trend.slice(0, 5) : []);
                console.log('[çµ±è¨ˆ] Top Foods:', data.top_foods);
                console.log('[çµ±è¨ˆ] Nutrient Distribution:', data.nutrient_distribution);

                document.getElementById('loading').style.display = 'none';

                if (!data.success || data.summary.total_records === 0) {
                    console.log('[çµ±è¨ˆ] ç„¡è¨˜éŒ„æˆ–æŸ¥è©¢å¤±æ•—');
                    document.getElementById('emptyState').style.display = 'block';
                    return;
                }

                // é¡¯ç¤ºçµ±è¨ˆè³‡æ–™
                displayStatistics(data);

                // è¼‰å…¥ AI å¥åº·é€±å ±
                loadAIInsight(days);

            } catch (error) {
                console.error('[çµ±è¨ˆ] è¼‰å…¥å¤±æ•—:', error);
                document.getElementById('loading').style.display = 'none';
                alert('è¼‰å…¥çµ±è¨ˆè³‡æ–™å¤±æ•—: ' + error.message);
            }
        }

        // é¡¯ç¤ºçµ±è¨ˆè³‡æ–™
        function displayStatistics(data) {
            document.getElementById('summarySection').style.display = 'block';

            // æ›´æ–°ç¸½é«”çµ±è¨ˆ
            document.getElementById('avgCalories').textContent = data.summary.avg_calories_per_day.toLocaleString();
            document.getElementById('avgMeals').textContent = data.summary.avg_meals_per_day.toFixed(1);
            document.getElementById('totalDays').textContent = data.summary.days_with_records;
            document.getElementById('uniqueFoods').textContent = data.summary.unique_foods;

            // ç¹ªè£½åœ–è¡¨
            drawCaloriesTrendChart(data.daily_trend);
            drawNutrientPieChart(data.nutrient_distribution);
            drawFoodFrequencyChart(data.top_foods);
            drawMacrosTrendChart(data.daily_trend);
            drawFiberChart(data.daily_trend);
            drawSodiumChart(data.daily_trend);

            // ç›£è½çª—å£èª¿æ•´ï¼Œé‡æ–°ç¹ªè£½åœ–è¡¨
            let resizeTimeout;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    // é‡æ–°èª¿æ•´æ‰€æœ‰åœ–è¡¨å¤§å°
                    const chartIds = ['caloriesTrendChart', 'nutrientPieChart', 'foodFrequencyChart',
                                     'macrosTrendChart', 'fiberChart', 'sodiumChart'];
                    chartIds.forEach(id => {
                        const chartDiv = document.getElementById(id);
                        if (chartDiv) {
                            Plotly.Plots.resize(chartDiv);
                        }
                    });
                }, 250);
            });
        }

        // 1. æ¯æ—¥ç†±é‡è¶¨å‹¢åœ–ï¼ˆæŠ˜ç·šåœ–ï¼‰
        function drawCaloriesTrendChart(dailyTrend) {
            console.log('[åœ–è¡¨] ç¹ªè£½æ¯æ—¥ç†±é‡è¶¨å‹¢åœ–');
            console.log('[åœ–è¡¨] dailyTrend è³‡æ–™ç­†æ•¸:', dailyTrend.length);
            console.log('[åœ–è¡¨] dailyTrend æœ€å¾Œ5ç­†:', dailyTrend.slice(-5));

            const dates = dailyTrend.map(d => d.date);
            const caloriesData = dailyTrend.map(d => Number(d.calories) || 0);
            const mealsData = dailyTrend.map(d => Number(d.meals) || 0);

            console.log('[åœ–è¡¨] ç†±é‡æ•¸æ“š (æœ€å¾Œ10å¤©):', caloriesData.slice(-10));
            console.log('[åœ–è¡¨] é¤æ¬¡æ•¸æ“š (æœ€å¾Œ10å¤©):', mealsData.slice(-10));
            console.log('[åœ–è¡¨] æ—¥æœŸ (æœ€å¾Œ10å¤©):', dates.slice(-10));

            const trace1 = {
                x: dates,
                y: caloriesData,
                name: 'ç†±é‡ (å¤§å¡)',
                type: 'scatter',
                mode: 'lines+markers',
                line: {
                    color: 'rgb(102, 126, 234)',
                    width: 3,
                    shape: 'spline'
                },
                marker: {
                    color: 'rgb(102, 126, 234)',
                    size: 6
                },
                fill: 'tozeroy',
                fillcolor: 'rgba(102, 126, 234, 0.1)',
                yaxis: 'y1'
            };

            const trace2 = {
                x: dates,
                y: mealsData,
                name: 'é¤æ¬¡',
                type: 'scatter',
                mode: 'lines+markers',
                line: {
                    color: 'rgb(255, 159, 64)',
                    width: 3,
                    shape: 'spline'
                },
                marker: {
                    color: 'rgb(255, 159, 64)',
                    size: 6
                },
                fill: 'tozeroy',
                fillcolor: 'rgba(255, 159, 64, 0.1)',
                yaxis: 'y2'
            };

            const layout = {
                autosize: true,
                title: false,
                xaxis: {
                    title: 'æ—¥æœŸ',
                    showgrid: true,
                    gridcolor: '#e5e5e5',
                    type: 'date',
                    range: [dates[0], dates[dates.length - 1]],
                    tickmode: 'auto',
                    nticks: window.innerWidth < 768 ? 7 : 15,
                    tickangle: window.innerWidth < 768 ? -45 : 0
                },
                yaxis: {
                    title: window.innerWidth < 768 ? 'ç†±é‡' : 'ç†±é‡ (å¤§å¡)',
                    side: 'left',
                    showgrid: true,
                    gridcolor: '#e5e5e5'
                },
                yaxis2: {
                    title: 'é¤æ¬¡',
                    side: 'right',
                    overlaying: 'y',
                    showgrid: false
                },
                hovermode: 'x unified',
                legend: {
                    orientation: 'h',
                    y: 1.15,
                    x: 0.5,
                    xanchor: 'center'
                },
                margin: { t: 40, r: 50, l: 50, b: window.innerWidth < 768 ? 70 : 50 }
            };

            const config = {
                responsive: true,
                displayModeBar: window.innerWidth > 768,
                displaylogo: false,
                modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d']
            };

            Plotly.newPlot('caloriesTrendChart', [trace1, trace2], layout, config);

            // é©—è­‰åœ–è¡¨å¯¦éš›ç¹ªè£½çš„æ•¸æ“š
            setTimeout(() => {
                const chartDiv = document.getElementById('caloriesTrendChart');
                if (chartDiv && chartDiv.data) {
                    console.log('[åœ–è¡¨é©—è­‰] å¯¦éš›ç¹ªè£½çš„æœ€å¾Œ5å€‹ç†±é‡å€¼:', chartDiv.data[0].y.slice(-5));
                    console.log('[åœ–è¡¨é©—è­‰] å¯¦éš›ç¹ªè£½çš„æœ€å¾Œ5å€‹æ—¥æœŸ:', chartDiv.data[0].x.slice(-5));
                }
            }, 100);
        }

        // 2. ç‡Ÿé¤Šç´ åˆ†å¸ƒåœ“é¤…åœ–
        function drawNutrientPieChart(nutrientDist) {
            const isMobile = window.innerWidth < 768;

            const data = [{
                values: [
                    nutrientDist.protein,
                    nutrientDist.fat,
                    nutrientDist.carbs
                ],
                labels: isMobile ? [
                    `è›‹ç™½è³ª`,
                    `è„‚è‚ª`,
                    `ç¢³æ°´`
                ] : [
                    `è›‹ç™½è³ª (${nutrientDist.protein_percent}%)`,
                    `è„‚è‚ª (${nutrientDist.fat_percent}%)`,
                    `ç¢³æ°´åŒ–åˆç‰© (${nutrientDist.carbs_percent}%)`
                ],
                type: 'pie',
                hole: 0.4,
                marker: {
                    colors: [
                        'rgba(255, 99, 132, 0.8)',
                        'rgba(255, 206, 86, 0.8)',
                        'rgba(54, 162, 235, 0.8)'
                    ],
                    line: {
                        color: 'white',
                        width: 2
                    }
                },
                textinfo: isMobile ? 'percent' : 'label+percent',
                textposition: isMobile ? 'inside' : 'outside',
                textfont: {
                    size: isMobile ? 10 : 12
                },
                hovertemplate: '%{label}<br>%{value}g<br>%{percent}<extra></extra>'
            }];

            const layout = {
                autosize: true,
                title: false,
                showlegend: true,
                legend: {
                    orientation: 'h',
                    y: isMobile ? -0.2 : -0.1,
                    x: 0.5,
                    xanchor: 'center',
                    font: { size: isMobile ? 10 : 12 }
                },
                margin: { t: 20, r: 20, l: 20, b: isMobile ? 60 : 80 }
            };

            const config = {
                responsive: true,
                displayModeBar: false
            };

            Plotly.newPlot('nutrientPieChart', data, layout, config);
        }

        // 3. é£Ÿç‰©é »ç‡é•·æ¢åœ–
        function drawFoodFrequencyChart(topFoods) {
            const isMobile = window.innerWidth < 768;

            // æ‰‹æ©Ÿç‰ˆåªé¡¯ç¤ºå‰5å€‹ï¼Œæ¡Œé¢ç‰ˆé¡¯ç¤ºå…¨éƒ¨
            const displayFoods = isMobile ? topFoods.slice(0, 5) : topFoods;
            const labels = displayFoods.map(f => {
                // æ‰‹æ©Ÿç‰ˆæˆªçŸ­åç¨±
                if (isMobile && f.name.length > 8) {
                    return f.name.substring(0, 8) + '...';
                }
                return f.name;
            });
            const counts = displayFoods.map(f => f.count);

            const data = [{
                y: labels,
                x: counts,
                type: 'bar',
                orientation: 'h',
                marker: {
                    color: 'rgba(118, 75, 162, 0.8)',
                    line: {
                        color: 'rgb(118, 75, 162)',
                        width: 2
                    }
                },
                text: counts.map(c => `${c}æ¬¡`),
                textposition: 'outside',
                textfont: { size: isMobile ? 10 : 12 },
                hovertemplate: '%{y}<br>é£Ÿç”¨æ¬¡æ•¸: %{x} æ¬¡<extra></extra>'
            }];

            const layout = {
                autosize: true,
                title: false,
                xaxis: {
                    title: isMobile ? '' : 'æ¬¡æ•¸',
                    showgrid: true,
                    gridcolor: '#e5e5e5'
                },
                yaxis: {
                    title: '',
                    automargin: true,
                    tickfont: { size: isMobile ? 10 : 12 }
                },
                margin: { t: 20, r: isMobile ? 50 : 80, l: isMobile ? 80 : 120, b: 40 }
            };

            const config = {
                responsive: true,
                displayModeBar: false
            };

            Plotly.newPlot('foodFrequencyChart', data, layout, config);
        }

        // 4. ä¸‰å¤§ç‡Ÿé¤Šç´ æ”å–è¶¨å‹¢åœ–ï¼ˆå¤šæ¢æŠ˜ç·šåœ–ï¼‰
        function drawMacrosTrendChart(dailyTrend) {
            console.log('[åœ–è¡¨] ç¹ªè£½ä¸‰å¤§ç‡Ÿé¤Šç´ è¶¨å‹¢åœ–');
            const isMobile = window.innerWidth < 768;

            const dates = dailyTrend.map(d => d.date);
            const proteinData = dailyTrend.map(d => d.protein || 0);
            const fatData = dailyTrend.map(d => d.fat || 0);
            const carbsData = dailyTrend.map(d => d.carbs || 0);

            const trace1 = {
                x: dates,
                y: proteinData,
                name: isMobile ? 'è›‹ç™½è³ª' : 'è›‹ç™½è³ª (g)',
                type: 'scatter',
                mode: 'lines+markers',
                line: {
                    color: 'rgb(255, 99, 132)',
                    width: isMobile ? 2 : 3,
                    shape: 'spline'
                },
                marker: {
                    color: 'rgb(255, 99, 132)',
                    size: isMobile ? 4 : 6
                }
            };

            const trace2 = {
                x: dates,
                y: fatData,
                name: isMobile ? 'è„‚è‚ª' : 'è„‚è‚ª (g)',
                type: 'scatter',
                mode: 'lines+markers',
                line: {
                    color: 'rgb(255, 206, 86)',
                    width: isMobile ? 2 : 3,
                    shape: 'spline'
                },
                marker: {
                    color: 'rgb(255, 206, 86)',
                    size: isMobile ? 4 : 6
                }
            };

            const trace3 = {
                x: dates,
                y: carbsData,
                name: isMobile ? 'ç¢³æ°´' : 'ç¢³æ°´åŒ–åˆç‰© (g)',
                type: 'scatter',
                mode: 'lines+markers',
                line: {
                    color: 'rgb(54, 162, 235)',
                    width: isMobile ? 2 : 3,
                    shape: 'spline'
                },
                marker: {
                    color: 'rgb(54, 162, 235)',
                    size: isMobile ? 4 : 6
                }
            };

            const layout = {
                autosize: true,
                title: false,
                xaxis: {
                    title: isMobile ? '' : 'æ—¥æœŸ',
                    showgrid: true,
                    gridcolor: '#e5e5e5',
                    type: 'date',
                    range: [dates[0], dates[dates.length - 1]],
                    tickmode: 'auto',
                    nticks: isMobile ? 7 : 15,
                    tickangle: isMobile ? -45 : 0
                },
                yaxis: {
                    title: isMobile ? 'å…‹' : 'æ”å–é‡ (å…‹)',
                    showgrid: true,
                    gridcolor: '#e5e5e5',
                    rangemode: 'tozero'
                },
                hovermode: 'x unified',
                legend: {
                    orientation: 'h',
                    y: 1.15,
                    x: 0.5,
                    xanchor: 'center',
                    font: { size: isMobile ? 10 : 12 }
                },
                margin: { t: 40, r: 30, l: 40, b: isMobile ? 70 : 50 }
            };

            const config = {
                responsive: true,
                displayModeBar: !isMobile,
                displaylogo: false,
                modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d']
            };

            Plotly.newPlot('macrosTrendChart', [trace1, trace2, trace3], layout, config);
        }

        // 5. è†³é£Ÿçº–ç¶­æ”å–åœ–ï¼ˆé•·æ¢åœ–ï¼‰
        function drawFiberChart(dailyTrend) {
            console.log('[åœ–è¡¨] ç¹ªè£½çº–ç¶­æ”å–åœ–');
            const isMobile = window.innerWidth < 768;

            const lastWeek = dailyTrend.slice(isMobile ? -5 : -7);
            const dates = lastWeek.map(d => d.date);
            const fiberData = lastWeek.map(d => d.fiber || 0);

            // åˆ¤æ–·æ˜¯å¦é”æ¨™ï¼ˆ25-35gï¼‰
            const colors = fiberData.map(value => {
                if (value >= 25 && value <= 35) return 'rgba(75, 192, 192, 0.8)';
                else if (value < 25) return 'rgba(255, 159, 64, 0.8)';
                else return 'rgba(255, 99, 132, 0.8)';
            });

            const data = [{
                x: dates,
                y: fiberData,
                type: 'bar',
                marker: {
                    color: colors,
                    line: { color: 'white', width: 2 }
                },
                text: fiberData.map(v => `${v.toFixed(1)}g`),
                textposition: 'outside',
                textfont: { size: isMobile ? 9 : 12 },
                hovertemplate: '%{x}<br>çº–ç¶­: %{y:.1f}g<extra></extra>'
            }];

            const layout = {
                autosize: true,
                title: false,
                xaxis: {
                    title: '',
                    showgrid: false,
                    tickangle: isMobile ? -45 : 0,
                    tickfont: { size: isMobile ? 9 : 11 }
                },
                yaxis: {
                    title: isMobile ? 'å…‹' : 'çº–ç¶­æ”å– (å…‹)',
                    showgrid: true,
                    gridcolor: '#e5e5e5',
                    range: [0, 40]
                },
                shapes: [
                    {
                        type: 'line', x0: dates[0], x1: dates[dates.length - 1],
                        y0: 25, y1: 25,
                        line: { color: 'rgb(75, 192, 192)', width: 2, dash: 'dash' }
                    },
                    {
                        type: 'line', x0: dates[0], x1: dates[dates.length - 1],
                        y0: 35, y1: 35,
                        line: { color: 'rgb(75, 192, 192)', width: 2, dash: 'dash' }
                    }
                ],
                annotations: isMobile ? [] : [
                    {
                        x: dates[dates.length - 1], y: 25, xanchor: 'left',
                        text: 'ä¸‹é™(25g)', showarrow: false, xshift: 5,
                        font: { size: 9, color: 'rgb(75, 192, 192)' }
                    },
                    {
                        x: dates[dates.length - 1], y: 35, xanchor: 'left',
                        text: 'ä¸Šé™(35g)', showarrow: false, xshift: 5,
                        font: { size: 9, color: 'rgb(75, 192, 192)' }
                    }
                ],
                margin: { t: 20, r: isMobile ? 20 : 80, l: isMobile ? 35 : 50, b: isMobile ? 60 : 50 }
            };

            const config = { responsive: true, displayModeBar: false };
            Plotly.newPlot('fiberChart', data, layout, config);
        }

        // 6. éˆ‰æ”å–ç›£æ§åœ–ï¼ˆé•·æ¢åœ–ï¼‰
        function drawSodiumChart(dailyTrend) {
            console.log('[åœ–è¡¨] ç¹ªè£½éˆ‰æ”å–åœ–');
            const isMobile = window.innerWidth < 768;

            const lastWeek = dailyTrend.slice(isMobile ? -5 : -7);
            const dates = lastWeek.map(d => d.date);
            const sodiumData = lastWeek.map(d => d.sodium || 0);

            // åˆ¤æ–·æ˜¯å¦è¶…æ¨™ï¼ˆ<2300mgï¼‰
            const colors = sodiumData.map(value => {
                if (value <= 2300) return 'rgba(75, 192, 192, 0.8)';
                else if (value <= 3000) return 'rgba(255, 206, 86, 0.8)';
                else return 'rgba(255, 99, 132, 0.8)';
            });

            const data = [{
                x: dates,
                y: sodiumData,
                type: 'bar',
                marker: {
                    color: colors,
                    line: { color: 'white', width: 2 }
                },
                text: sodiumData.map(v => `${v.toFixed(0)}mg`),
                textposition: 'outside',
                textfont: { size: isMobile ? 9 : 12 },
                hovertemplate: '%{x}<br>éˆ‰: %{y:.0f}mg<extra></extra>'
            }];

            const layout = {
                autosize: true,
                title: false,
                xaxis: {
                    title: '',
                    showgrid: false,
                    tickangle: isMobile ? -45 : 0,
                    tickfont: { size: isMobile ? 9 : 11 }
                },
                yaxis: {
                    title: isMobile ? 'mg' : 'éˆ‰æ”å– (æ¯«å…‹)',
                    showgrid: true,
                    gridcolor: '#e5e5e5',
                    range: [0, 4000]
                },
                shapes: [
                    {
                        type: 'line', x0: dates[0], x1: dates[dates.length - 1],
                        y0: 2300, y1: 2300,
                        line: { color: 'rgb(75, 192, 192)', width: 2, dash: 'dash' }
                    }
                ],
                annotations: isMobile ? [] : [
                    {
                        x: dates[dates.length - 1], y: 2300, xanchor: 'left',
                        text: 'ä¸Šé™(2300mg)', showarrow: false, xshift: 5,
                        font: { size: 9, color: 'rgb(75, 192, 192)' }
                    }
                ],
                margin: { t: 20, r: isMobile ? 20 : 100, l: isMobile ? 40 : 50, b: isMobile ? 60 : 50 }
            };

            const config = { responsive: true, displayModeBar: false };
            Plotly.newPlot('sodiumChart', data, layout, config);
        }

        // AI å¥åº·é€±å ±è¼‰å…¥å‡½æ•¸
        async function loadAIInsight(days) {
            const card = document.getElementById('aiInsightCard');
            const content = document.getElementById('aiInsightContent');

            // é¡¯ç¤ºå¡ç‰‡ä¸¦é‡ç½®ç‚ºè¼‰å…¥ç‹€æ…‹
            card.style.display = 'block';
            content.innerHTML = `
                <div class="insight-loading">
                    <span>âœ¨</span> AI æ­£åœ¨åˆ†ææ‚¨çš„é£²é£Ÿæ•¸æ“šï¼Œç”Ÿæˆå¥åº·é€±å ±...
                </div>
            `;

            try {
                const idToken = await currentUser.getIdToken();
                // æœ¬åœ°æ¸¬è©¦ç”¨ localhostï¼Œæ­£å¼ç’°å¢ƒç”¨ Cloud Run
                const API_BASE = window.location.hostname === 'localhost'
                    ? 'http://localhost:8080'
                    : 'https://bentoai-api-278768520764.asia-east1.run.app';
                const response = await fetch(`${API_BASE}/api/statistics/insight?days=${days}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${idToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.success && data.insight) {
                    // ä½¿ç”¨ marked.js è§£æ Markdown
                    if (typeof marked !== 'undefined') {
                        content.innerHTML = marked.parse(data.insight);
                    } else {
                        content.innerHTML = data.insight.replace(/\n/g, '<br>');
                    }
                } else {
                    content.innerHTML = "æš«æ™‚ç„¡æ³•ç”Ÿæˆå ±å‘Šï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
                }
            } catch (error) {
                console.error('AI Insight Error:', error);
                content.innerHTML = "AI é€£ç·šé€¾æ™‚ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚";
            }
        }
    </script>
</body>
</html>

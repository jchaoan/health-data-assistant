<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <!-- æ·±è‰²æ¨¡å¼ï¼ˆå…§è¯è…³æœ¬+æ¨£å¼ï¼Œé¿å…é–ƒçˆï¼‰ -->
    <script>try{if(JSON.parse(localStorage.getItem('bentoai_settings')||'{}').darkMode)document.documentElement.classList.add('dark-mode')}catch(e){}</script>
    <style>html.dark-mode,html.dark-mode body{background:linear-gradient(135deg,#1a1a2e 0%,#16213e 100%)!important}html.dark-mode .bottom-nav{background:#1a1a2e!important;border-top:1px solid #2a2a3e}html.dark-mode .nav-item{color:#888!important}html.dark-mode .container,html.dark-mode .header,html.dark-mode .section,html.dark-mode .form-section,html.dark-mode .form-group,html.dark-mode .settings-section,html.dark-mode .settings-item,html.dark-mode .user-card,html.dark-mode .user-header,html.dark-mode .user-info,html.dark-mode .profile-item,html.dark-mode .profile-grid,html.dark-mode .profile-panel,html.dark-mode .option-card,html.dark-mode .feature-card,html.dark-mode .stat-card,html.dark-mode .summary-item,html.dark-mode .nutrition-item,html.dark-mode .nutrition-card,html.dark-mode .chart-container,html.dark-mode .chart-section,html.dark-mode .insight-card,html.dark-mode .tips-card,html.dark-mode .recent-card,html.dark-mode .card,html.dark-mode .chat-container,html.dark-mode .chat-header,html.dark-mode .chat-messages,html.dark-mode .chat-input-area,html.dark-mode .quick-questions,html.dark-mode .welcome-message,html.dark-mode .edit-form,html.dark-mode .stats-grid,html.dark-mode .loading,html.dark-mode .step,html.dark-mode .total-item,html.dark-mode .input-wrapper,html.dark-mode .options-grid,html.dark-mode .multi-option,html.dark-mode .tech-item,html.dark-mode .empty-state,html.dark-mode .filter-btn,html.dark-mode .time-selector,html.dark-mode .controls,html.dark-mode .record-card,html.dark-mode .meal-section,html.dark-mode .food-item,html.dark-mode .modal-content,html.dark-mode .upload-area,html.dark-mode .result-card,html.dark-mode .analysis-card{background:#1e1e2e!important;color:#e0e0e0!important}html.dark-mode input,html.dark-mode select,html.dark-mode textarea{background:#2a2a3e!important;color:#e0e0e0!important;border-color:#3a3a4e!important}html.dark-mode .btn-secondary{background:#3a3a4e!important;color:#e0e0e0!important}</style>
    <meta charset="UTF-8">
    <script src="/js/dark-mode.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <title>æˆ‘çš„é£²é£Ÿè¨˜éŒ„</title>
    <!-- PWA æ”¯æ´ -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="å¥åº·åŠ©ç†">
    <link rel="apple-touch-icon" href="logo.png">
    <link rel="icon" href="logo.png" type="image/png">
    <!-- PWA å„ªåŒ–æ¨£å¼ -->
    <link rel="stylesheet" href="/css/pwa.css">

    <!-- Markdown è§£æå™¨ (marked.js) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- PWA å®‰è£æç¤º -->
    <script src="/js/pwa-install.js" defer></script>
    <script src="/js/pwa-utils.js" defer></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 32px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-logo {
            width: 45px;
            height: 45px;
            object-fit: contain;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #667eea;
        }

        .btn-add {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
        }

        .btn-add:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        /* ===== ç¯©é¸åˆ— ===== */
        .filter-bar {
            display: flex;
            gap: 10px;
            padding: 12px 16px;
            background: white;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .filter-bar::-webkit-scrollbar {
            display: none;
        }

        .filter-btn {
            padding: 10px 18px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            transition: all 0.2s;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .filter-btn:hover {
            border-color: #667eea;
            color: #667eea;
        }

        .filter-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: transparent;
            color: white;
        }

        /* ===== é¤é»é¡å‹æ¨™ç±¤ ===== */
        .meal-type-tag {
            display: inline-block;
            padding: 5px 14px;
            border-radius: 15px;
            font-size: 13px;
            font-weight: 600;
            margin-top: 8px;
        }

        .meal-type-tag.breakfast { background: #fff3e0; color: #e65100; }
        .meal-type-tag.lunch { background: #e3f2fd; color: #1565c0; }
        .meal-type-tag.dinner { background: #ede7f6; color: #5e35b1; }
        .meal-type-tag.snack { background: #fce4ec; color: #c2185b; }
        .meal-type-tag.unknown { background: #f5f5f5; color: #757575; }

        /* ===== Modal æ¨£å¼ ===== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }

        .modal-container {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 580px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #eee;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 18px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: white;
            opacity: 0.8;
            line-height: 1;
        }

        .modal-close:hover {
            opacity: 1;
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            overflow-x: hidden;
            flex: 1;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .form-section {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            font-size: 14px;
        }

        /* é¤é»é¡å‹é¸æ“‡å™¨ */
        .meal-type-selector {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .meal-type-btn {
            padding: 10px 8px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 10px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
            text-align: center;
        }

        .meal-type-btn:hover {
            border-color: #667eea;
        }

        .meal-type-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: transparent;
            color: white;
        }

        /* é£Ÿç‰©é …ç›®å¡ç‰‡ */
        .food-item-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            position: relative;
            width: 100%;
            box-sizing: border-box;
            overflow: hidden;
        }

        .food-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .food-item-header input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            margin-right: 10px;
        }

        .food-item-header input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-remove-food {
            background: #fee;
            color: #dc3545;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-remove-food:hover {
            background: #dc3545;
            color: white;
        }

        .food-item-nutrients {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .food-item-nutrients.expanded {
            grid-template-columns: repeat(2, 1fr);
        }

        .nutrient-input-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-width: 0;
        }

        .nutrient-input-group label {
            font-size: 11px;
            color: #666;
        }

        .nutrient-input-group input {
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            text-align: center;
            width: 100%;
            box-sizing: border-box;
        }

        .nutrient-input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .expand-nutrients-btn {
            background: none;
            border: none;
            color: #667eea;
            font-size: 12px;
            cursor: pointer;
            padding: 8px 0 0;
            width: 100%;
            text-align: left;
        }

        .expand-nutrients-btn:hover {
            text-decoration: underline;
        }

        .extra-nutrients {
            display: none;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #ddd;
        }

        .extra-nutrients.show {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .btn-add-food {
            width: 100%;
            padding: 12px;
            background: #f0f4ff;
            color: #667eea;
            border: 2px dashed #667eea;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-add-food:hover {
            background: #667eea;
            color: white;
            border-style: solid;
        }

        /* ç¸½è¨ˆå€åŸŸ */
        .total-section {
            background: linear-gradient(135deg, #f0f4ff 0%, #e8eeff 100%);
            border-radius: 12px;
            padding: 15px;
        }

        .total-title {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 12px;
        }

        .total-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .total-item {
            text-align: center;
        }

        .total-value {
            display: block;
            font-size: 20px;
            font-weight: 700;
            color: #333;
        }

        .total-label {
            font-size: 11px;
            color: #666;
        }

        /* ===== å¹³æ¿/ä¸­è¢å¹• Modal å„ªåŒ– ===== */
        @media (max-width: 768px) {
            .food-item-nutrients {
                grid-template-columns: 1fr 1fr;
            }

            .extra-nutrients.show {
                grid-template-columns: 1fr 1fr;
            }

            .total-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* ===== æ‰‹æ©Ÿç‰ˆ Modal å„ªåŒ– ===== */
        @media (max-width: 480px) {
            .modal-overlay {
                padding: 0;
                align-items: flex-end;
            }

            .modal-container {
                width: 100% !important;
                max-width: 100% !important;
                max-height: 90vh;
                border-radius: 16px 16px 0 0;
                overflow-x: hidden;
            }

            .modal-header {
                padding: 15px;
            }

            .modal-header h2 {
                font-size: 16px;
            }

            .modal-body {
                padding: 15px;
                overflow-x: hidden;
            }

            .modal-footer {
                padding: 12px 15px;
            }

            .meal-type-selector {
                grid-template-columns: repeat(2, 1fr);
                gap: 6px;
            }

            .meal-type-btn {
                padding: 8px 6px;
                font-size: 11px;
            }

            .food-item-card {
                padding: 12px;
                width: 100%;
                box-sizing: border-box;
            }

            .food-item-header {
                width: 100%;
            }

            .food-item-header input {
                font-size: 14px;
                padding: 10px;
                width: 100%;
                min-width: 0;
            }

            .food-item-nutrients {
                grid-template-columns: 1fr 1fr;
                gap: 8px;
                width: 100%;
            }

            .nutrient-input-group {
                width: 100%;
            }

            .nutrient-input-group label {
                font-size: 11px;
            }

            .nutrient-input-group input {
                padding: 10px 8px;
                font-size: 14px;
                width: 100%;
                box-sizing: border-box;
            }

            .extra-nutrients.show {
                grid-template-columns: 1fr 1fr;
                gap: 8px;
                width: 100%;
            }

            .btn-add-food {
                padding: 12px;
                font-size: 13px;
                width: 100%;
            }

            .total-section {
                padding: 12px;
                width: 100%;
                box-sizing: border-box;
            }

            .total-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .total-value {
                font-size: 18px;
            }

            .filter-bar {
                padding: 10px 12px;
                gap: 8px;
                margin-bottom: 15px;
            }

            .filter-btn {
                padding: 8px 12px;
                font-size: 12px;
                white-space: nowrap;
            }
        }

        /* ===== æ·±è‰²æ¨¡å¼ Modal ===== */
        body.dark-mode .modal-container {
            background: #1e1e1e;
        }

        body.dark-mode .modal-body {
            background: #1e1e1e;
        }

        body.dark-mode .modal-footer {
            background: #1e1e1e;
            border-top-color: #333;
        }

        body.dark-mode .form-label {
            color: #e0e0e0;
        }

        body.dark-mode .meal-type-btn {
            background: #2a2a2a;
            border-color: #444;
            color: #ccc;
        }

        body.dark-mode .food-item-card {
            background: #2a2a2a;
        }

        body.dark-mode .food-item-header input,
        body.dark-mode .nutrient-input-group input {
            background: #333;
            border-color: #444;
            color: #e0e0e0;
        }

        body.dark-mode .total-section {
            background: linear-gradient(135deg, #2a2a3a 0%, #252535 100%);
        }

        body.dark-mode .total-value {
            color: #e0e0e0;
        }

        body.dark-mode .filter-bar {
            background: #1e1e1e;
        }

        body.dark-mode .filter-btn {
            background: #2a2a2a;
            border-color: #444;
            color: #ccc;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 18px;
        }

        .records-grid {
            display: grid;
            gap: 20px;
        }

        .record-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }

        .record-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        .record-header {
            background: linear-gradient(135deg, #4a5dc7 0%, #5d3a8c 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .record-date {
            font-size: 16px;
            font-weight: 500;
        }

        .record-time {
            font-size: 14px;
            opacity: 0.9;
        }

        .record-body {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 20px;
        }

        .record-image-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .record-image {
            width: 100%;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .record-info-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .predictions-list {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
        }

        .prediction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: white;
            margin-bottom: 8px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .prediction-item:last-child {
            margin-bottom: 0;
        }

        .food-name {
            font-weight: 600;
            color: #333;
        }

        .confidence {
            background: #e7f3ff;
            color: #0066cc;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 13px;
        }

        .nutrition-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
        }

        .nutrition-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }

        .nutrition-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .nutrition-value {
            font-size: 20px;
            font-weight: 700;
            color: #667eea;
        }

        .nutrition-unit {
            font-size: 12px;
            color: #999;
        }

        .ai-advice-section {
            grid-column: 1 / -1;
            background: #fff8e1;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #ffa726;
        }

        .ai-advice-title {
            font-size: 18px;
            font-weight: 600;
            color: #f57c00;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ai-advice-content {
            color: #5d4037;
            line-height: 1.6;
        }

        /* Markdown æ¸²æŸ“æ¨£å¼ */
        .markdown-content h1, .markdown-content h2, .markdown-content h3 {
            color: #667eea;
            margin-top: 12px;
            margin-bottom: 8px;
        }
        .markdown-content h1 { font-size: 1.3em; }
        .markdown-content h2 { font-size: 1.15em; }
        .markdown-content h3 { font-size: 1.05em; }
        .markdown-content p { margin-bottom: 8px; }
        .markdown-content ul, .markdown-content ol {
            margin: 8px 0;
            padding-left: 20px;
        }
        .markdown-content li { margin: 4px 0; }
        .markdown-content strong { font-weight: 600; }
        .markdown-content hr {
            border: none;
            border-top: 1px solid #e0e0e0;
            margin: 12px 0;
        }
        .markdown-content blockquote {
            border-left: 3px solid #667eea;
            padding-left: 12px;
            margin: 8px 0;
            color: #666;
            background: #f5f5f5;
            padding: 8px 12px;
            border-radius: 4px;
        }

        .rag-suggestions-section {
            grid-column: 1 / -1;
            background: #e8f5e9;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #66bb6a;
        }

        .rag-suggestions-title {
            font-size: 18px;
            font-weight: 600;
            color: #2e7d32;
            margin-bottom: 10px;
        }

        .rag-item {
            background: white;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
        }

        .rag-food-name {
            font-weight: 600;
            color: #2e7d32;
            margin-bottom: 8px;
        }

        .rag-suggestion {
            color: #555;
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 5px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(102, 126, 234, 0.1);
        }

        .empty-state-icon {
            font-size: 80px;
            margin-bottom: 20px;
            animation: floatAnimation 3s ease-in-out infinite;
        }

        @keyframes floatAnimation {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .empty-state h2 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 22px;
        }

        .empty-state p {
            color: #888;
            margin-bottom: 25px;
            font-size: 15px;
            line-height: 1.6;
        }

        .empty-state .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .empty-state .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }

        .empty-state-tips {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .empty-state-tips h4 {
            color: #667eea;
            font-size: 14px;
            margin-bottom: 12px;
        }

        .empty-state-tips ul {
            list-style: none;
            padding: 0;
            margin: 0;
            text-align: left;
            display: inline-block;
        }

        .empty-state-tips li {
            color: #666;
            font-size: 13px;
            padding: 6px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .empty-state-tips li::before {
            content: 'ğŸ’¡';
            font-size: 12px;
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
        }

        /* ===== éŸ¿æ‡‰å¼è¨­è¨ˆ ===== */

        /* å¤§è¢å¹• (æ¡Œé¢) */
        @media (min-width: 1200px) {
            .container {
                max-width: 1200px;
            }
        }

        /* ä¸­ç­‰è¢å¹• (å¹³æ¿) */
        @media (max-width: 1199px) and (min-width: 769px) {
            .container {
                max-width: 95%;
            }

            .header h1 {
                font-size: 28px;
            }

            .record-body {
                gap: 15px;
                padding: 15px;
            }
        }

        /* å°è¢å¹• (æ‰‹æ©Ÿæ©«å‘ & å°å¹³æ¿) */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
                padding: 20px;
            }

            .header h1 {
                font-size: 24px;
            }

            .user-info {
                flex-wrap: wrap;
                justify-content: center;
            }

            .btn {
                padding: 10px 15px;
                font-size: 13px;
            }

            .record-body {
                grid-template-columns: 1fr;
                padding: 15px;
                gap: 15px;
            }

            .nutrition-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .nutrition-item {
                padding: 10px;
            }

            .nutrition-value {
                font-size: 18px;
            }

            .record-header {
                padding: 15px;
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }

            .record-header > div:last-child {
                text-align: center !important;
            }

            .predictions-list {
                padding: 12px;
            }

            .ai-advice-section,
            .rag-suggestions-section {
                padding: 15px;
            }

            .ai-advice-title,
            .rag-suggestions-title {
                font-size: 16px;
            }

            .ai-advice-content {
                font-size: 14px;
            }
        }

        /* è¶…å°è¢å¹• (æ‰‹æ©Ÿç›´å‘) */
        @media (max-width: 480px) {
            body {
                padding: 5px;
            }

            .header {
                padding: 15px;
                border-radius: 10px;
            }

            .header h1 {
                font-size: 20px;
            }

            .header p {
                font-size: 13px;
            }

            .user-info {
                gap: 8px;
                flex-wrap: wrap;
                justify-content: center;
            }

            .user-avatar {
                width: 36px;
                height: 36px;
            }

            #userName {
                font-size: 13px;
            }

            .header .btn {
                padding: 10px 16px;
                font-size: 12px;
            }

            .header .btn-add {
                flex: 0 0 100%;
                margin-bottom: 8px;
            }

            .header .btn-secondary,
            .header .btn-primary {
                flex: 1;
            }

            .record-card {
                border-radius: 10px;
            }

            .record-header {
                padding: 12px;
            }

            .record-date {
                font-size: 14px;
            }

            .record-time {
                font-size: 12px;
            }

            .record-header div[style*="font-size: 24px"] {
                font-size: 20px !important;
            }

            .record-body {
                padding: 12px;
                gap: 12px;
            }

            .nutrition-grid {
                grid-template-columns: 1fr 1fr;
                gap: 6px;
            }

            .nutrition-item {
                padding: 8px;
            }

            .nutrition-label {
                font-size: 11px;
            }

            .nutrition-value {
                font-size: 16px;
            }

            .nutrition-unit {
                font-size: 10px;
            }

            .predictions-list {
                padding: 10px;
            }

            .predictions-list h3 {
                font-size: 14px;
            }

            .prediction-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
                padding: 8px;
            }

            .food-name {
                font-size: 14px;
            }

            .prediction-item > div > div:nth-child(2) {
                font-size: 11px !important;
            }

            .confidence {
                align-self: flex-end;
                font-size: 12px;
                padding: 3px 10px;
            }

            .ai-advice-section,
            .rag-suggestions-section {
                padding: 12px;
                border-radius: 8px;
            }

            .ai-advice-title,
            .rag-suggestions-title {
                font-size: 14px;
            }

            .ai-advice-content {
                font-size: 13px;
                line-height: 1.5;
            }

            .rag-item {
                padding: 10px;
            }

            .rag-food-name {
                font-size: 14px;
            }

            .rag-suggestion {
                font-size: 12px;
            }

            .empty-state {
                padding: 40px 15px;
            }

            .empty-state h2 {
                font-size: 18px;
            }

            .empty-state p {
                font-size: 14px;
            }

            .loading p {
                font-size: 16px;
            }

            /* Markdown å…§å®¹éŸ¿æ‡‰å¼ */
            .markdown-content h1 { font-size: 1.1em; }
            .markdown-content h2 { font-size: 1em; }
            .markdown-content h3 { font-size: 0.95em; }
            .markdown-content {
                font-size: 13px;
            }
        }

        /* è§¸æ§è£ç½®å„ªåŒ– */
        @media (hover: none) and (pointer: coarse) {
            .btn {
                min-height: 44px;
            }

            .record-card:hover {
                transform: none;
            }

            .record-card:active {
                transform: scale(0.99);
            }

            .btn:active {
                transform: scale(0.98);
            }
        }

        /* ===== åº•éƒ¨å°èˆªæ¬„ ===== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 8px 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: #666;
            font-size: 12px;
            padding: 5px 10px;
            border-radius: 10px;
            transition: all 0.3s;
            min-width: 60px;
        }

        .nav-item:hover {
            background: #f0f4ff;
            color: #667eea;
        }

        .nav-item.active {
            color: #667eea;
        }

        .nav-item.active .nav-icon {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .nav-icon {
            font-size: 20px;
            margin-bottom: 3px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            transition: all 0.3s;
        }

        .nav-label {
            font-weight: 500;
        }

        /* ç‚ºåº•éƒ¨å°èˆªç•™å‡ºç©ºé–“ */
        body {
            padding-bottom: 80px;
        }

        /* æ‰‹æ©Ÿç‰ˆåº•éƒ¨å°èˆªå„ªåŒ– */
        @media (max-width: 480px) {
            .nav-item {
                font-size: 10px;
                padding: 5px 5px;
                min-width: 50px;
            }

            .nav-icon {
                font-size: 18px;
                width: 35px;
                height: 35px;
            }

            .bottom-nav {
                padding: 5px 0;
            }
        }

        /* æ·±è‰²æ¨¡å¼ */
        body.dark-mode {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }

        body.dark-mode .header {
            background: #1e1e1e;
        }

        body.dark-mode .header h1 {
            color: #667eea;
        }

        body.dark-mode .header p {
            color: #888 !important;
        }

        body.dark-mode #userName {
            color: #e0e0e0;
        }

        body.dark-mode .btn-secondary {
            background: #333;
            color: #e0e0e0;
        }

        body.dark-mode .record-card {
            background: #1e1e1e;
        }

        body.dark-mode .record-body {
            background: #1e1e1e;
        }

        body.dark-mode .predictions-list {
            background: #2a2a2a;
        }

        body.dark-mode .predictions-list h3 {
            color: #e0e0e0 !important;
        }

        body.dark-mode .prediction-item {
            background: #333;
        }

        body.dark-mode .food-name {
            color: #e0e0e0;
        }

        body.dark-mode .nutrition-grid {
            background: #2a2a2a;
        }

        body.dark-mode .ai-advice-section {
            background: #2a2a2a;
            border-left-color: #ffa726;
        }

        body.dark-mode .ai-advice-content {
            color: #ccc;
        }

        body.dark-mode .rag-suggestions-section {
            background: #1a3a1a;
        }

        body.dark-mode .rag-item {
            background: #2a4a2a;
        }

        body.dark-mode .rag-suggestion {
            color: #a5d6a5;
        }

        body.dark-mode .empty-state {
            background: #1e1e1e;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        body.dark-mode .empty-state h2 {
            color: #8b9cf4;
        }

        body.dark-mode .empty-state p {
            color: #aaa;
        }

        body.dark-mode .empty-state-tips {
            border-top-color: #333;
        }

        body.dark-mode .empty-state-tips h4 {
            color: #8b9cf4;
        }

        body.dark-mode .empty-state-tips li {
            color: #999;
        }

        body.dark-mode .loading {
            color: #e0e0e0;
        }

        body.dark-mode .bottom-nav {
            background: #1e1e1e;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
        }

        body.dark-mode .nav-item {
            color: #888;
        }

        body.dark-mode .nav-item:hover,
        body.dark-mode .nav-item.active {
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- é é¢æ¨™é¡Œ -->
        <div class="header">
            <div>
                <h1><img src="logo.png" alt="Logo" class="header-logo">æˆ‘çš„é£²é£Ÿè¨˜éŒ„</h1>
                <p style="color: #666; margin-top: 5px;">è¿½è¹¤æ‚¨çš„é£²é£Ÿï¼Œé‚å‘å¥åº·ç”Ÿæ´»</p>
            </div>
            <div class="user-info">
                <img id="userAvatar" class="user-avatar" style="display: none;">
                <span id="userName"></span>
                <button class="btn btn-add" onclick="openAddModal()">+ æ‰‹å‹•æ–°å¢</button>
                <button class="btn btn-secondary" onclick="window.location.href='dashboard.html'">è¿”å›ä¸»é </button>
                <button class="btn btn-primary" id="logoutBtn" style="display: none;">ç™»å‡º</button>
            </div>
        </div>

        <!-- ç¯©é¸åˆ— -->
        <div class="filter-bar">
            <button class="filter-btn active" data-filter="all">å…¨éƒ¨</button>
            <button class="filter-btn" data-filter="breakfast">ğŸŒ… æ—©é¤</button>
            <button class="filter-btn" data-filter="lunch">â˜€ï¸ åˆé¤</button>
            <button class="filter-btn" data-filter="dinner">ğŸŒ™ æ™šé¤</button>
            <button class="filter-btn" data-filter="snack">ğŸª é»å¿ƒ</button>
        </div>

        <!-- è¼‰å…¥ä¸­ -->
        <div id="loading" class="loading">
            <p>â³ è¼‰å…¥é£²é£Ÿè¨˜éŒ„ä¸­...</p>
        </div>

        <!-- éŒ¯èª¤è¨Šæ¯ -->
        <div id="errorMessage" class="error-message" style="display: none;"></div>

        <!-- é£²é£Ÿè¨˜éŒ„åˆ—è¡¨ -->
        <div id="recordsContainer" class="records-grid"></div>

        <!-- ç©ºç‹€æ…‹ -->
        <div id="emptyState" class="empty-state" style="display: none;">
            <div class="empty-state-icon">ğŸ½ï¸</div>
            <h2>é–‹å§‹æ‚¨çš„å¥åº·é£²é£Ÿä¹‹æ—…ï¼</h2>
            <p>è¨˜éŒ„æ¯ä¸€é¤ï¼ŒAI æœƒå¹«æ‚¨åˆ†æç‡Ÿé¤Šæˆåˆ†<br>è®“å¥åº·ç®¡ç†è®Šå¾—ç°¡å–®åˆæœ‰è¶£</p>
            <button class="btn btn-primary" onclick="window.location.href='food-detect.html'">
                ğŸ“¸ æ‹ç…§è¾¨è­˜é£Ÿç‰©
            </button>
            <div class="empty-state-tips">
                <h4>å°æç¤º</h4>
                <ul>
                    <li>æ‹æ”é£Ÿç‰©æ¸…æ™°ç…§ç‰‡ï¼ŒAI è¾¨è­˜æ›´æº–ç¢º</li>
                    <li>æ¯é¤è¨˜éŒ„ï¼Œè¿½è¹¤ç‡Ÿé¤Šæ”å–æ›´å®Œæ•´</li>
                    <li>ä¹Ÿå¯ä»¥æ‰‹å‹•æ–°å¢è¨˜éŒ„</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- æ‰‹å‹•æ–°å¢ Modal -->
    <div id="addModal" class="modal-overlay" style="display: none;">
        <div class="modal-container">
            <div class="modal-header">
                <h2>æ‰‹å‹•æ–°å¢é£²é£Ÿè¨˜éŒ„</h2>
                <button class="modal-close" onclick="closeAddModal()">&times;</button>
            </div>

            <div class="modal-body">
                <!-- é¤é»é¡å‹é¸æ“‡ -->
                <div class="form-section">
                    <label class="form-label">é¤é»é¡å‹</label>
                    <div class="meal-type-selector">
                        <button type="button" class="meal-type-btn" data-type="breakfast">ğŸŒ… æ—©é¤</button>
                        <button type="button" class="meal-type-btn active" data-type="lunch">â˜€ï¸ åˆé¤</button>
                        <button type="button" class="meal-type-btn" data-type="dinner">ğŸŒ™ æ™šé¤</button>
                        <button type="button" class="meal-type-btn" data-type="snack">ğŸª é»å¿ƒ</button>
                    </div>
                </div>

                <!-- é£Ÿç‰©åˆ—è¡¨ -->
                <div class="form-section">
                    <label class="form-label">é£Ÿç‰©é …ç›®</label>
                    <div id="foodItemsList">
                        <!-- é£Ÿç‰©é …ç›®æœƒå‹•æ…‹æ–°å¢åœ¨é€™è£¡ -->
                    </div>
                    <button type="button" class="btn btn-add-food" onclick="addFoodItem()">+ æ–°å¢é£Ÿç‰©</button>
                </div>

                <!-- ç¸½è¨ˆå€åŸŸ -->
                <div class="total-section">
                    <div class="total-title">ğŸ“Š ç¸½è¨ˆ</div>
                    <div class="total-grid">
                        <div class="total-item">
                            <span class="total-value" id="totalCalories">0</span>
                            <span class="total-label">å¤§å¡</span>
                        </div>
                        <div class="total-item">
                            <span class="total-value" id="totalProtein">0</span>
                            <span class="total-label">è›‹ç™½è³ª(g)</span>
                        </div>
                        <div class="total-item">
                            <span class="total-value" id="totalFat">0</span>
                            <span class="total-label">è„‚è‚ª(g)</span>
                        </div>
                        <div class="total-item">
                            <span class="total-value" id="totalCarbs">0</span>
                            <span class="total-label">ç¢³æ°´(g)</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeAddModal()">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="saveManualRecord()" id="saveRecordBtn">å„²å­˜è¨˜éŒ„</button>
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨å°èˆªæ¬„ -->
    <nav class="bottom-nav">
        <a href="dashboard.html" class="nav-item">
            <div class="nav-icon">ğŸ </div>
            <span class="nav-label">é¦–é </span>
        </a>
        <a href="diet_records.html" class="nav-item active">
            <div class="nav-icon">ğŸ½ï¸</div>
            <span class="nav-label">è¨˜éŒ„</span>
        </a>
        <a href="food-detect.html" class="nav-item">
            <div class="nav-icon">ğŸ“·</div>
            <span class="nav-label">è¾¨è­˜</span>
        </a>
        <a href="statistics.html" class="nav-item">
            <div class="nav-icon">ğŸ“Š</div>
            <span class="nav-label">çµ±è¨ˆ</span>
        </a>
        <a href="chat.html" class="nav-item">
            <div class="nav-icon">ğŸ’¬</div>
            <span class="nav-label">è«®è©¢</span>
        </a>
        <a href="exercise.html" class="nav-item">
            <div class="nav-icon">ğŸƒ</div>
            <span class="nav-label">é‹å‹•</span>
        </a>
        <a href="settings.html" class="nav-item">
            <div class="nav-icon">âš™ï¸</div>
            <span class="nav-label">è¨­å®š</span>
        </a>
    </nav>

    <!-- å…±ç”¨å·¥å…·å‡½æ•¸ -->
    <script src="/js/utils.js"></script>
    <script src="/js/security.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <script>
        // Markdown è§£æå‡½å¼ï¼ˆæ­é…å®‰å…¨éæ¿¾ï¼‰
        function parseMarkdown(text) {
            if (!text) return '';
            if (typeof marked !== 'undefined') {
                marked.setOptions({ breaks: true, gfm: true });
                let html = marked.parse(text);
                // ä½¿ç”¨å®‰å…¨å·¥å…·éæ¿¾ XSS
                if (typeof BentoAISecurity !== 'undefined') {
                    html = BentoAISecurity.sanitizeHtml(html);
                }
                return html;
            }
            // å¦‚æœ marked æœªè¼‰å…¥ï¼Œä½¿ç”¨åŸºæœ¬æ ¼å¼åŒ–ï¼ˆåŒæ™‚è·³è„« HTMLï¼‰
            if (typeof BentoAISecurity !== 'undefined') {
                text = BentoAISecurity.escapeHtml(text);
            }
            return text.replace(/\n/g, '<br>').replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
        }

        // Firebase é…ç½®ï¼ˆå¿…é ˆèˆ‡ index.html ä¸€è‡´æ‰èƒ½å…±äº«ç™»å…¥ç‹€æ…‹ï¼‰
        const firebaseConfig = {
            apiKey: "AIzaSyCk4GY-VkG4dd_zXP5HZQDlZbjdY0k0img",
            authDomain: "fooddata-92fa8.firebaseapp.com",
            projectId: "fooddata-92fa8",
            storageBucket: "fooddata-92fa8.firebasestorage.app",
            messagingSenderId: "459965557703",
            appId: "1:459965557703:web:6a16b3937935219eb887e2",
            measurementId: "G-R16CYV7QC2"
        };

        // åˆå§‹åŒ– Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        // å•Ÿç”¨ session æŒä¹…åŒ–
        auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

        let currentUser = null;
        // let isInitializing = true;  // èˆŠç‰ˆï¼šä½¿ç”¨ isInitializing æ¨™èªŒ
        let hasCheckedAuth = false;  // æ–°ç‰ˆï¼šé˜²æ­¢ onAuthStateChanged é‡è¤‡è™•ç†

        // ç›£è½ç™»å…¥ç‹€æ…‹
        auth.onAuthStateChanged(async (user) => {
            // console.log('[é£²é£Ÿè¨˜éŒ„] onAuthStateChanged è§¸ç™¼', { user: user ? user.uid : null, isInitializing });  // èˆŠç‰ˆ log
            console.log('[é£²é£Ÿè¨˜éŒ„] onAuthStateChanged è§¸ç™¼', { user: user ? user.uid : null, hasCheckedAuth });

            // æ–°å¢ï¼šé˜²æ­¢é‡è¤‡è™•ç†
            if (hasCheckedAuth) {
                console.log('[é£²é£Ÿè¨˜éŒ„] å·²è™•ç†éèªè­‰ï¼Œè·³é');
                return;
            }
            hasCheckedAuth = true;

            if (user) {
                console.log('[é£²é£Ÿè¨˜éŒ„] ç”¨æˆ¶å·²ç™»å…¥:', user.email);
                currentUser = user;
                // isInitializing = false;  // èˆŠç‰ˆï¼šè¨­å®šåˆå§‹åŒ–å®Œæˆ

                // æ›´æ–°ç”¨æˆ¶è³‡è¨Š
                document.getElementById('userName').textContent = user.displayName || user.email;

                if (user.photoURL) {
                    const avatar = document.getElementById('userAvatar');
                    avatar.src = user.photoURL;
                    avatar.style.display = 'block';
                }

                document.getElementById('logoutBtn').style.display = 'block';

                // è¼‰å…¥é£²é£Ÿè¨˜éŒ„
                console.log('[é£²é£Ÿè¨˜éŒ„] é–‹å§‹è¼‰å…¥è¨˜éŒ„...');
                await loadDietRecords();
            } else {
                console.log('[é£²é£Ÿè¨˜éŒ„] user is null, hasCheckedAuth:', hasCheckedAuth);

                // èˆŠç‰ˆé‚è¼¯ï¼šä½¿ç”¨ isInitializing å’Œ setTimeout ç­‰å¾…
                /*
                // åªåœ¨åˆå§‹åŒ–å®Œæˆå¾Œæ‰æª¢æŸ¥ç™»å…¥ç‹€æ…‹
                if (!isInitializing) {
                    console.log('[é£²é£Ÿè¨˜éŒ„] å·²åˆå§‹åŒ–å®Œæˆä½†ç„¡ç”¨æˆ¶ï¼Œå°å‘ç™»å…¥é ');
                    alert('è«‹å…ˆç™»å…¥');
                    window.location.href = 'login.html';
                } else {
                    console.log('[é£²é£Ÿè¨˜éŒ„] ç­‰å¾… 1 ç§’è®“ Firebase Auth æ¢å¾© session...');
                    // çµ¦ Firebase Auth ä¸€äº›æ™‚é–“ä¾†æ¢å¾© session
                    setTimeout(() => {
                        isInitializing = false;
                        const checkUser = auth.currentUser;
                        console.log('[é£²é£Ÿè¨˜éŒ„] 1 ç§’å¾Œæª¢æŸ¥ç”¨æˆ¶:', checkUser ? checkUser.uid : null);
                        // å¦‚æœä»ç„¶æ²’æœ‰ç”¨æˆ¶ï¼Œå‰‡å°å‘ç™»å…¥é 
                        if (!checkUser) {
                            console.log('[é£²é£Ÿè¨˜éŒ„] 1 ç§’å¾Œä»ç„¡ç”¨æˆ¶ï¼Œå°å‘ç™»å…¥é ');
                            alert('è«‹å…ˆç™»å…¥');
                            window.location.href = 'login.html';
                        } else {
                            console.log('[é£²é£Ÿè¨˜éŒ„] 1 ç§’å¾Œæ‰¾åˆ°ç”¨æˆ¶ï¼Œé‡æ–°è§¸ç™¼è¼‰å…¥');
                            // ç”¨æˆ¶å·²æ¢å¾©ï¼Œé‡æ–°è§¸ç™¼è¼‰å…¥
                            currentUser = checkUser;
                            loadDietRecords();
                        }
                    }, 1000);
                }
                */

                // æ–°ç‰ˆé‚è¼¯ï¼šonAuthStateChanged å·²ç¢ºä¿ Firebase Auth åˆå§‹åŒ–å®Œæˆï¼Œç›´æ¥å°å‘ç™»å…¥é 
                console.log('[é£²é£Ÿè¨˜éŒ„] âœ— Firebase Auth å·²åˆå§‹åŒ–ä½†ç„¡ç”¨æˆ¶ï¼Œå°å‘ç™»å…¥é ');
                document.getElementById('loading').style.display = 'none';
                alert('è«‹å…ˆç™»å…¥');
                window.location.href = 'login.html';
            }
        });

        // ç™»å‡º
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                await auth.signOut();
                window.location.href = 'login.html';
            } catch (error) {
                console.error('ç™»å‡ºå¤±æ•—:', error);
                alert('ç™»å‡ºå¤±æ•—: ' + error.message);
            }
        });

        // è¼‰å…¥é£²é£Ÿè¨˜éŒ„
        async function loadDietRecords() {
            console.log('[é£²é£Ÿè¨˜éŒ„] loadDietRecords() é–‹å§‹');
            console.log('[é£²é£Ÿè¨˜éŒ„] currentUser:', currentUser ? currentUser.uid : null);

            try {
                const idToken = await currentUser.getIdToken();
                console.log('[é£²é£Ÿè¨˜éŒ„] Token å–å¾—æˆåŠŸï¼Œé•·åº¦:', idToken.length);

                console.log('[é£²é£Ÿè¨˜éŒ„] ç™¼é€ API è«‹æ±‚åˆ° /api/diet-records');

                // æ·»åŠ æ™‚é–“æˆ³é¿å…ç€è¦½å™¨å¿«å–ï¼Œç¢ºä¿æ¯æ¬¡ F5 åˆ·æ–°éƒ½èƒ½ç²å–æœ€æ–°æ•¸æ“š
                const timestamp = new Date().getTime();
                const response = await fetch(`https://bentoai-api-de2tsulgza-de.a.run.app/api/diet-records?limit=20&t=${timestamp}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${idToken}`,
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    },
                    cache: 'no-store'
                });

                console.log('[é£²é£Ÿè¨˜éŒ„] API å›æ‡‰ç‹€æ…‹:', response.status);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                console.log('[é£²é£Ÿè¨˜éŒ„] API å›æ‡‰è³‡æ–™:', data);

                // éš±è—è¼‰å…¥ä¸­
                document.getElementById('loading').style.display = 'none';

                if (!data.success) {
                    console.error('[é£²é£Ÿè¨˜éŒ„] API å›å‚³å¤±æ•—:', data.error);
                    showError(data.error || 'è¼‰å…¥å¤±æ•—');
                    return;
                }

                if (!data.data || data.data.length === 0) {
                    console.log('[é£²é£Ÿè¨˜éŒ„] ç„¡è¨˜éŒ„ï¼Œé¡¯ç¤ºç©ºç‹€æ…‹');
                    document.getElementById('emptyState').style.display = 'block';
                    return;
                }

                console.log('[é£²é£Ÿè¨˜éŒ„] æ‰¾åˆ°', data.data.length, 'ç­†è¨˜éŒ„');

                // Debug: æª¢æŸ¥åœ–ç‰‡è³‡æ–™
                data.data.forEach((record, index) => {
                    console.log(`[é£²é£Ÿè¨˜éŒ„] è¨˜éŒ„${index}: has_image=${record.has_image}, image_base64é•·åº¦=${record.image_base64 ? record.image_base64.length : 0}`);
                });
                // é¡¯ç¤ºè¨˜éŒ„
                displayRecords(data.data);

            } catch (error) {
                console.error('[é£²é£Ÿè¨˜éŒ„] è¼‰å…¥è¨˜éŒ„å¤±æ•—:', error);
                document.getElementById('loading').style.display = 'none';
                showError('è¼‰å…¥å¤±æ•—: ' + error.message);
            }
        }

        // é¡¯ç¤ºéŒ¯èª¤
        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
        }

        // é¡¯ç¤ºè¨˜éŒ„
        // æ ¹æ“šç‡Ÿé¤Šç´ æ•¸å€¼è¨ˆç®—é¡è‰²ï¼ˆèˆ‡çµ±è¨ˆåœ–è¡¨ä¸€è‡´ï¼Œä½¿ç”¨ä¸é€æ˜è‰²å½©å¢å¼·å°æ¯”åº¦ï¼‰
        function getNutrientColor(nutrient, value) {
            switch(nutrient) {
                case 'fiber':
                    // è†³é£Ÿçº–ç¶­ï¼š25-35g é”æ¨™
                    if (value >= 25 && value <= 35) return '#2e9e7e';  // æ·±ç¶ è‰²
                    else if (value < 25) return '#e07d35';  // æ©˜è‰²
                    else return '#dc4c64';  // ç´…è‰²

                case 'sodium':
                    // éˆ‰ï¼š<2300mg æ­£å¸¸
                    if (value <= 2300) return '#2e9e7e';  // æ·±ç¶ è‰²
                    else if (value <= 3000) return '#d9a824';  // é»ƒè‰²
                    else return '#dc4c64';  // ç´…è‰²

                case 'calories':
                    return '#5a6fd6';  // ç´«è—è‰²
                case 'protein':
                    return '#dc4c64';  // ç´…è‰²
                case 'fat':
                    return '#d9a824';  // é»ƒè‰²
                case 'carbs':
                    return '#2d8bc9';  // è—è‰²
                default:
                    return '#888888';  // ç°è‰²
            }
        }

        function displayRecords(records) {
            const container = document.getElementById('recordsContainer');
            container.innerHTML = '';

            records.forEach(record => {
                const card = createRecordCard(record);
                container.appendChild(card);
            });
        }

        // å»ºç«‹è¨˜éŒ„å¡ç‰‡
        function createRecordCard(record) {
            const card = document.createElement('div');
            card.className = 'record-card';

            // æ ¼å¼åŒ–æ—¥æœŸ
            const date = new Date(record.created_at || record.timestamp);
            const dateStr = date.toLocaleDateString('zh-TW', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                weekday: 'long'
            });
            const timeStr = date.toLocaleTimeString('zh-TW', {
                hour: '2-digit',
                minute: '2-digit'
            });

            card.innerHTML = `
                <div class="record-header">
                    <div>
                        <div class="record-date">${dateStr}</div>
                        <div class="record-time">${timeStr}</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 24px; font-weight: 700;">
                            ${record.total_nutrition?.total_cal || 0} <span style="font-size: 14px;">å¤§å¡</span>
                        </div>
                    </div>
                </div>

                <div class="record-body">
                    <!-- åœ–ç‰‡å€åŸŸ -->
                    <div class="record-image-section">
                        ${(record.image_base64 || record.image_path) ? `
                            <img class="record-image"
                                 src="${record.image_base64 ?
                                      `data:image/${record.image_format || 'jpeg'};base64,${record.image_base64}` :
                                      record.image_path}"
                                 alt="é£Ÿç‰©ç…§ç‰‡"
                                 onerror="this.parentElement.innerHTML='<div style=\\'text-align: center; color: #999;\\'>åœ–ç‰‡è¼‰å…¥å¤±æ•—</div>'">
                        ` : '<div style="text-align: center; color: #999;">ç„¡åœ–ç‰‡</div>'}

                        <!-- è¾¨è­˜çµæœ -->
                        <div class="predictions-list">
                            <h3 style="margin-bottom: 10px; color: #333;">ğŸ´ è¾¨è­˜é£Ÿç‰©</h3>
                            ${(record.predictions || []).map(pred => `
                                <div class="prediction-item">
                                    <div>
                                        <div class="food-name">${pred.class_name}</div>
                                        ${pred.nutrition ? `
                                            <div style="font-size: 12px; color: #666; margin-top: 4px;">
                                                ${pred.nutrition.cal || 0}å¡ |
                                                è›‹ç™½è³ª${pred.nutrition.p || 0}g |
                                                è„‚è‚ª${pred.nutrition.f || 0}g |
                                                ç¢³æ°´${pred.nutrition.c || 0}g |
                                                çº–ç¶­${pred.nutrition.fiber || 0}g |
                                                éˆ‰${pred.nutrition.sodium || 0}mg
                                            </div>
                                        ` : ''}
                                    </div>
                                    <span class="confidence">${Math.round((pred.confidence || 1) * 100)}%</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- ç‡Ÿé¤Šè³‡è¨Šå€åŸŸ -->
                    <div class="record-info-section">
                        <div class="nutrition-grid">
                            <div class="nutrition-item" style="background: ${getNutrientColor('calories', record.total_nutrition?.total_cal)}; border-left: 3px solid ${getNutrientColor('calories', record.total_nutrition?.total_cal)};">
                                <div class="nutrition-label" style="color: white;">ç†±é‡</div>
                                <div class="nutrition-value" style="color: white;">
                                    ${record.total_nutrition?.total_cal || 0}
                                    <span class="nutrition-unit">å¤§å¡</span>
                                </div>
                            </div>
                            <div class="nutrition-item" style="background: ${getNutrientColor('protein', record.total_nutrition?.total_pro)}; border-left: 3px solid ${getNutrientColor('protein', record.total_nutrition?.total_pro)};">
                                <div class="nutrition-label" style="color: white;">è›‹ç™½è³ª</div>
                                <div class="nutrition-value" style="color: white;">
                                    ${record.total_nutrition?.total_pro || 0}
                                    <span class="nutrition-unit">å…‹</span>
                                </div>
                            </div>
                            <div class="nutrition-item" style="background: ${getNutrientColor('fat', record.total_nutrition?.total_fat)}; border-left: 3px solid ${getNutrientColor('fat', record.total_nutrition?.total_fat)};">
                                <div class="nutrition-label" style="color: white;">è„‚è‚ª</div>
                                <div class="nutrition-value" style="color: white;">
                                    ${record.total_nutrition?.total_fat || 0}
                                    <span class="nutrition-unit">å…‹</span>
                                </div>
                            </div>
                            <div class="nutrition-item" style="background: ${getNutrientColor('carbs', record.total_nutrition?.total_carb)}; border-left: 3px solid ${getNutrientColor('carbs', record.total_nutrition?.total_carb)};">
                                <div class="nutrition-label" style="color: white;">ç¢³æ°´åŒ–åˆç‰©</div>
                                <div class="nutrition-value" style="color: white;">
                                    ${record.total_nutrition?.total_carb || 0}
                                    <span class="nutrition-unit">å…‹</span>
                                </div>
                            </div>
                            <div class="nutrition-item" style="background: ${getNutrientColor('fiber', record.total_nutrition?.total_fiber || 0)}; border-left: 3px solid ${getNutrientColor('fiber', record.total_nutrition?.total_fiber || 0)};">
                                <div class="nutrition-label" style="color: white;">è†³é£Ÿçº–ç¶­</div>
                                <div class="nutrition-value" style="color: white;">
                                    ${record.total_nutrition?.total_fiber || 0}
                                    <span class="nutrition-unit">å…‹</span>
                                </div>
                            </div>
                            <div class="nutrition-item" style="background: ${getNutrientColor('sodium', record.total_nutrition?.total_sodium || 0)}; border-left: 3px solid ${getNutrientColor('sodium', record.total_nutrition?.total_sodium || 0)};">
                                <div class="nutrition-label" style="color: white;">éˆ‰</div>
                                <div class="nutrition-value" style="color: white;">
                                    ${record.total_nutrition?.total_sodium || 0}
                                    <span class="nutrition-unit">æ¯«å…‹</span>
                                </div>
                            </div>
                        </div>

                        ${record.gemini_reply ? `
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 10px;">
                                <h4 style="color: #667eea; margin-bottom: 8px;">ğŸ’¡ é£Ÿç‰©èªªæ˜</h4>
                                <div class="markdown-content" style="color: #555; line-height: 1.5; font-size: 14px;">${parseMarkdown(record.gemini_reply)}</div>
                            </div>
                        ` : ''}
                    </div>

                    <!-- AI é£²é£Ÿå»ºè­° -->
                    ${record.diet_advice ? `
                        <div class="ai-advice-section">
                            <div class="ai-advice-title">
                                ğŸ¤– AI é£²é£Ÿå»ºè­°
                            </div>
                            <div class="ai-advice-content markdown-content">${parseMarkdown(record.diet_advice)}</div>
                        </div>
                    ` : ''}

                    <!-- RAG é¡å¤–å»ºè­° -->
                    ${record.rag_suggestions && record.rag_suggestions.length > 0 ? `
                        <div class="rag-suggestions-section">
                            <div class="rag-suggestions-title">
                                ğŸ“š ç‡Ÿé¤ŠçŸ¥è­˜åº«å»ºè­°
                            </div>
                            ${record.rag_suggestions.map(rag => `
                                <div class="rag-item">
                                    <div class="rag-food-name">${rag.food}</div>
                                    ${rag.suggestions.map((sugg, idx) => `
                                        <div class="rag-suggestion">
                                            ${idx + 1}. ${sugg.substring(0, 150)}${sugg.length > 150 ? '...' : ''}
                                        </div>
                                    `).join('')}
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `;

            return card;
        }

        // ===== æ‰‹å‹•æ–°å¢åŠŸèƒ½ =====
        let selectedMealType = 'lunch';
        let foodItemCount = 0;
        let allRecords = []; // å„²å­˜æ‰€æœ‰è¨˜éŒ„ç”¨æ–¼ç¯©é¸
        let currentFilter = 'all';

        // é¤é»é¡å‹å°æ‡‰ä¸­æ–‡
        const mealTypeLabels = {
            'breakfast': 'ğŸŒ… æ—©é¤',
            'lunch': 'â˜€ï¸ åˆé¤',
            'dinner': 'ğŸŒ™ æ™šé¤',
            'snack': 'ğŸª é»å¿ƒ',
            'unknown': 'æœªåˆ†é¡'
        };

        // é–‹å•Ÿ Modal
        function openAddModal() {
            document.getElementById('addModal').style.display = 'flex';
            document.getElementById('foodItemsList').innerHTML = '';
            foodItemCount = 0;
            selectedMealType = 'lunch';

            // é‡ç½®é¤é»é¡å‹æŒ‰éˆ•
            document.querySelectorAll('.meal-type-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.type === 'lunch') {
                    btn.classList.add('active');
                }
            });

            // æ–°å¢ç¬¬ä¸€å€‹é£Ÿç‰©é …ç›®
            addFoodItem();
            updateTotals();
        }

        // é—œé–‰ Modal
        function closeAddModal() {
            document.getElementById('addModal').style.display = 'none';
        }

        // é»æ“ŠèƒŒæ™¯é—œé–‰ Modal
        document.getElementById('addModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeAddModal();
            }
        });

        // é¤é»é¡å‹é¸æ“‡
        document.querySelectorAll('.meal-type-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.meal-type-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                selectedMealType = this.dataset.type;
            });
        });

        // æ–°å¢é£Ÿç‰©é …ç›®
        function addFoodItem() {
            foodItemCount++;
            const itemId = foodItemCount;

            const itemHtml = `
                <div class="food-item-card" id="foodItem${itemId}">
                    <div class="food-item-header">
                        <input type="text" placeholder="é£Ÿç‰©åç¨±ï¼ˆå¿…å¡«ï¼‰" id="foodName${itemId}" required>
                        <button type="button" class="btn-remove-food" onclick="removeFoodItem(${itemId})">Ã—</button>
                    </div>
                    <div class="food-item-nutrients">
                        <div class="nutrient-input-group">
                            <label>ç†±é‡ (kcal)*</label>
                            <input type="number" id="calories${itemId}" placeholder="0" min="0" oninput="updateTotals()">
                        </div>
                        <div class="nutrient-input-group">
                            <label>è›‹ç™½è³ª (g)</label>
                            <input type="number" id="protein${itemId}" placeholder="0" min="0" step="0.1" oninput="updateTotals()">
                        </div>
                        <div class="nutrient-input-group">
                            <label>è„‚è‚ª (g)</label>
                            <input type="number" id="fat${itemId}" placeholder="0" min="0" step="0.1" oninput="updateTotals()">
                        </div>
                    </div>
                    <button type="button" class="expand-nutrients-btn" onclick="toggleExtraNutrients(${itemId})">
                        â–¼ æ›´å¤šç‡Ÿé¤Šç´ 
                    </button>
                    <div class="extra-nutrients" id="extraNutrients${itemId}">
                        <div class="nutrient-input-group">
                            <label>ç¢³æ°´ (g)</label>
                            <input type="number" id="carbs${itemId}" placeholder="0" min="0" step="0.1" oninput="updateTotals()">
                        </div>
                        <div class="nutrient-input-group">
                            <label>çº–ç¶­ (g)</label>
                            <input type="number" id="fiber${itemId}" placeholder="0" min="0" step="0.1">
                        </div>
                        <div class="nutrient-input-group">
                            <label>éˆ‰ (mg)</label>
                            <input type="number" id="sodium${itemId}" placeholder="0" min="0">
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('foodItemsList').insertAdjacentHTML('beforeend', itemHtml);
        }

        // ç§»é™¤é£Ÿç‰©é …ç›®
        function removeFoodItem(itemId) {
            const item = document.getElementById(`foodItem${itemId}`);
            if (item) {
                item.remove();
                updateTotals();
            }
        }

        // å±•é–‹/æ”¶åˆæ›´å¤šç‡Ÿé¤Šç´ 
        function toggleExtraNutrients(itemId) {
            const extra = document.getElementById(`extraNutrients${itemId}`);
            const btn = extra.previousElementSibling;

            if (extra.classList.contains('show')) {
                extra.classList.remove('show');
                btn.textContent = 'â–¼ æ›´å¤šç‡Ÿé¤Šç´ ';
            } else {
                extra.classList.add('show');
                btn.textContent = 'â–² æ”¶åˆ';
            }
        }

        // æ›´æ–°ç¸½è¨ˆ
        function updateTotals() {
            let totalCal = 0, totalPro = 0, totalFat = 0, totalCarbs = 0;

            document.querySelectorAll('.food-item-card').forEach(card => {
                const id = card.id.replace('foodItem', '');
                totalCal += parseFloat(document.getElementById(`calories${id}`)?.value) || 0;
                totalPro += parseFloat(document.getElementById(`protein${id}`)?.value) || 0;
                totalFat += parseFloat(document.getElementById(`fat${id}`)?.value) || 0;
                totalCarbs += parseFloat(document.getElementById(`carbs${id}`)?.value) || 0;
            });

            document.getElementById('totalCalories').textContent = Math.round(totalCal);
            document.getElementById('totalProtein').textContent = totalPro.toFixed(1);
            document.getElementById('totalFat').textContent = totalFat.toFixed(1);
            document.getElementById('totalCarbs').textContent = totalCarbs.toFixed(1);
        }

        // å„²å­˜æ‰‹å‹•è¨˜éŒ„
        async function saveManualRecord() {
            const items = [];
            let hasError = false;

            document.querySelectorAll('.food-item-card').forEach(card => {
                const id = card.id.replace('foodItem', '');
                const name = document.getElementById(`foodName${id}`)?.value?.trim();
                const calories = parseFloat(document.getElementById(`calories${id}`)?.value) || 0;

                if (!name) {
                    hasError = true;
                    return;
                }

                items.push({
                    name: name,
                    calories: calories,
                    protein: parseFloat(document.getElementById(`protein${id}`)?.value) || 0,
                    fat: parseFloat(document.getElementById(`fat${id}`)?.value) || 0,
                    carbs: parseFloat(document.getElementById(`carbs${id}`)?.value) || 0,
                    fiber: parseFloat(document.getElementById(`fiber${id}`)?.value) || 0,
                    sodium: parseFloat(document.getElementById(`sodium${id}`)?.value) || 0,
                    confidence: 1.0,
                    source: 'manual'
                });
            });

            if (hasError || items.length === 0) {
                alert('è«‹å¡«å¯«è‡³å°‘ä¸€é …é£Ÿç‰©åç¨±');
                return;
            }

            // è¨ˆç®—ç¸½ç‡Ÿé¤Šç´ 
            let totalCal = 0, totalPro = 0, totalFat = 0, totalCarbs = 0, totalFiber = 0, totalSodium = 0;
            items.forEach(item => {
                totalCal += item.calories;
                totalPro += item.protein;
                totalFat += item.fat;
                totalCarbs += item.carbs;
                totalFiber += item.fiber;
                totalSodium += item.sodium;
            });

            const recordData = {
                items: items,
                total_calories: Math.round(totalCal),
                total_protein: parseFloat(totalPro.toFixed(1)),
                total_fat: parseFloat(totalFat.toFixed(1)),
                total_carbs: parseFloat(totalCarbs.toFixed(1)),
                total_fiber: parseFloat(totalFiber.toFixed(1)),
                total_sodium: Math.round(totalSodium),
                advice: '',
                mode: 'manual',
                meal_type: selectedMealType,
                image_base64: null
            };

            // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
            const saveBtn = document.getElementById('saveRecordBtn');
            const originalText = saveBtn.textContent;
            saveBtn.textContent = 'å„²å­˜ä¸­...';
            saveBtn.disabled = true;

            try {
                const idToken = await currentUser.getIdToken();

                const response = await fetch('https://bentoai-api-de2tsulgza-de.a.run.app/api/diet-records', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${idToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(recordData)
                });

                const result = await response.json();

                if (result.success) {
                    alert('è¨˜éŒ„å·²å„²å­˜ï¼');
                    closeAddModal();
                    // é‡æ–°è¼‰å…¥è¨˜éŒ„
                    await loadDietRecords();
                } else {
                    alert('å„²å­˜å¤±æ•—ï¼š' + (result.error || 'æœªçŸ¥éŒ¯èª¤'));
                }
            } catch (error) {
                console.error('å„²å­˜å¤±æ•—:', error);
                alert('å„²å­˜å¤±æ•—ï¼š' + error.message);
            } finally {
                saveBtn.textContent = originalText;
                saveBtn.disabled = false;
            }
        }

        // ===== ç¯©é¸åŠŸèƒ½ =====
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentFilter = this.dataset.filter;
                filterRecords();
            });
        });

        function filterRecords() {
            if (currentFilter === 'all') {
                displayRecords(allRecords);
            } else {
                const filtered = allRecords.filter(record => {
                    const mealType = record.meal_type || 'unknown';
                    return mealType === currentFilter;
                });
                displayRecords(filtered);

                // å¦‚æœç¯©é¸å¾Œæ²’æœ‰è¨˜éŒ„ï¼Œé¡¯ç¤ºæç¤º
                if (filtered.length === 0) {
                    document.getElementById('recordsContainer').innerHTML = `
                        <div class="empty-state">
                            <h2>æ²’æœ‰${mealTypeLabels[currentFilter]}è¨˜éŒ„</h2>
                            <p>åˆ‡æ›å…¶ä»–é¡å‹æˆ–æ–°å¢è¨˜éŒ„</p>
                        </div>
                    `;
                }
            }
        }

        // ä¿®æ”¹åŸæœ¬çš„ displayRecordsï¼Œå„²å­˜æ‰€æœ‰è¨˜éŒ„
        const originalDisplayRecords = displayRecords;
        displayRecords = function(records) {
            // ç¬¬ä¸€æ¬¡è¼‰å…¥æ™‚å„²å­˜æ‰€æœ‰è¨˜éŒ„
            if (allRecords.length === 0 || records.length > allRecords.length) {
                allRecords = records;
            }
            originalDisplayRecords(records);
        };

        // ä¿®æ”¹ createRecordCard åŠ å…¥é¤é»é¡å‹æ¨™ç±¤
        const originalCreateRecordCard = createRecordCard;
        createRecordCard = function(record) {
            const card = originalCreateRecordCard(record);

            // åŠ å…¥é¤é»é¡å‹æ¨™ç±¤
            const mealType = record.meal_type || 'unknown';
            const mealLabel = mealTypeLabels[mealType] || 'æœªåˆ†é¡';

            const headerDiv = card.querySelector('.record-header > div:first-child');
            if (headerDiv) {
                const tag = document.createElement('span');
                tag.className = `meal-type-tag ${mealType}`;
                tag.textContent = mealLabel;
                headerDiv.appendChild(tag);
            }

            return card;
        };
    </script>
</body>
</html>
